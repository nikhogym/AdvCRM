<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LexManager | CRM Jur√≠dico Profissional</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           1. DESIGN SYSTEM & VARI√ÅVEIS CSS
        ========================================= */
        :root {
            --primary: #4F46E5;
            --primary-hover: #4338CA;
            --primary-gradient: linear-gradient(135deg, #4F46E5 0%, #818CF8 100%);
            
            --danger: #EF4444; 
            --warning: #F59E0B; 
            --success: #10B981; 
            --info: #3B82F6;
            
            --bg-body: #F8FAFC; 
            --bg-surface: #FFFFFF;
            --bg-sidebar: #1E293B; 
            --text-main: #1E293B; 
            --text-secondary: #64748B; 
            --text-muted: #94A3B8;
            --text-on-dark: #F8FAFC;
            --border-color: #E2E8F0;

            /* NOVAS CORES PERGUNTA/RESPOSTA */
            --text-question: #2563EB; /* Azul */
            --text-answer: #1E293B;   /* Preto */
            
            --radius-sm: 8px;
            --radius-md: 12px; 
            --radius-lg: 20px; 
            --radius-xl: 28px;
            
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.025);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
            --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.08), 0 8px 10px -6px rgba(0,0,0,0.04);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            --font-main: 'Inter', system-ui, sans-serif;
            --sidebar-width: 260px;
        }

        body.dark-mode {
            --bg-body: #0F172A; 
            --bg-surface: #1E293B;
            --bg-sidebar: #0B0F19;
            --text-main: #F1F5F9; 
            --text-secondary: #94A3B8; 
            --border-color: #334155;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.4);
            --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.5);
            
            /* NOVAS CORES PERGUNTA/RESPOSTA DARK MODE */
            --text-question: #60A5FA; /* Azul Claro */
            --text-answer: #F8FAFC;   /* Branco */
        }

        body.dark-mode .pub-full-text {
            color: var(--text-main); 
            border-color: var(--border-color);
            background-color: #0B0F19; 
        }
        body.dark-mode .client-summary-box {
            background: rgba(245, 158, 11, 0.05); 
            border-color: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
        }

        /* ESTILOS PARA VISUALIZA√á√ÉO ESTRAT√âGICA E EXPANSIVO */
        .strat-block-container {
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .strat-header {
            font-weight: 800;
            color: var(--primary);
            text-transform: uppercase;
            font-size: 0.85rem;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            cursor: pointer;
            user-select: none;
        }
        
        .strat-header::after {
            content: '‚ñº';
            font-size: 0.75rem;
            transition: transform 0.3s ease;
        }
        .strat-header.collapsed::after {
            transform: rotate(-90deg);
        }
        .strat-content {
            margin-top: 12px;
            display: block;
        }
        .strat-content.collapsed {
            display: none;
        }
        
        /* CORRE√á√ÉO DAS CORES E LAYOUT DA PERGUNTA/RESPOSTA */
        .strat-row {
            margin-bottom: 8px;
            line-height: 1.5;
            display: block;
        }
        .strat-label {
            font-weight: 700;
            color: var(--text-question);
            display: inline;
            font-size: 0.9rem;
            margin-right: 4px;
        }
        .strat-value {
            color: var(--text-answer);
            display: inline;
            font-size: 0.9rem;
            word-break: break-word;
        }
        
        /* Ajuste fino caso haja itens aninhados dentro da aba de publica√ß√µes */
        .analysis-val .strat-row { margin-bottom: 6px; }
        .analysis-val .strat-row:last-child { margin-bottom: 0; }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        body { font-family: var(--font-main); background-color: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; transition: background-color 0.3s, color 0.3s; font-size: 14px; -webkit-font-smoothing: antialiased; }

        aside { width: var(--sidebar-width); background-color: var(--bg-sidebar); display: flex; flex-direction: column; padding: 24px 16px; transition: var(--transition); z-index: 50; flex-shrink: 0; box-shadow: var(--shadow-md); }
        .logo { font-size: 1.5rem; font-weight: 800; margin-bottom: 40px; padding: 0 12px; display: flex; align-items: center; gap: 12px; color: var(--text-on-dark); letter-spacing: -0.5px; }
        .logo svg { width: 28px; height: 28px; fill: var(--primary); }
        nav button { background: transparent; border: none; color: #94A3B8; width: 100%; padding: 12px 16px; text-align: left; cursor: pointer; border-radius: var(--radius-md); display: flex; align-items: center; gap: 12px; font-weight: 500; font-size: 0.95rem; transition: var(--transition); position: relative; margin-bottom: 8px; }
        nav button:hover { background-color: rgba(255,255,255,0.05); color: var(--text-on-dark); }
        nav button.active { background-color: var(--primary); color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        nav button svg { width: 20px; height: 20px; fill: currentColor; opacity: 0.8; }

        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        /* CORRE√á√ÉO TOPBAR RESTAURADA */
        .app-topbar { 
            background-color: var(--bg-surface); 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 10px 24px; 
            flex-shrink: 0; 
            transition: background-color 0.3s, border-color 0.3s;
            height: 70px; 
            z-index: 40;
            width: 100%;
        }

        .topbar-main-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .header-titles h1 { font-size: 1.25rem; font-weight: 800; color: var(--text-main); margin: 0; line-height: 1.2; }
        .header-titles small { font-size: 0.8rem; color: var(--text-secondary); font-weight: 500; }
        
        .header-actions { display: flex; align-items: center; gap: 12px; }

        .content-scroll { flex: 1; overflow-y: auto; padding: 32px; scroll-behavior: smooth; }
        .hidden { display: none !important; }

        .card { background: var(--bg-surface); border-radius: var(--radius-lg); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); padding: 24px; margin-bottom: 24px; transition: var(--transition); }
        .card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); border-color: var(--primary); }

        .dash-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 32px; }
        .dash-header h2 { font-size: 1.8rem; font-weight: 700; color: var(--text-main); letter-spacing: -0.5px; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px; margin-bottom: 32px; }
        .stat-card { background: var(--bg-surface); padding: 24px; border-radius: var(--radius-lg); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); display: flex; flex-direction: column; min-height: 140px; transition: var(--transition); user-select: none; -webkit-user-select: none; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .stat-icon-bg { width: 48px; height: 48px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin-bottom: 16px; font-size: 1.5rem; }
        .stat-title { font-size: 0.8rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-value { font-size: 2.25rem; font-weight: 800; color: var(--text-main); margin: 8px 0 4px 0; letter-spacing: -1px; }

        .card-blue .stat-icon-bg { background: rgba(79, 70, 229, 0.1); color: var(--primary); }
        .card-red .stat-icon-bg { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .stat-value.text-danger { color: var(--danger); }
        .card-green .stat-icon-bg { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .stat-value.text-success { color: var(--success); }

        .btn { padding: 10px 20px; border-radius: var(--radius-md); border: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: var(--transition); box-shadow: var(--shadow-sm); font-family: inherit; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary-gradient); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); }
        .btn-primary:hover { box-shadow: 0 6px 15px rgba(79, 70, 229, 0.4); transform: translateY(-1px); }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-main); box-shadow: none; }
        .btn-outline:hover { background: var(--bg-body); border-color: var(--text-secondary); }
        .btn-danger { background: var(--bg-surface); border: 1px solid var(--danger); color: var(--danger); }
        .btn-success { background: var(--success); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; border-radius: 8px; }
        
        input, select, textarea { width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: var(--bg-body); color: var(--text-main); font-family: var(--font-main); font-size: 0.95rem; margin-bottom: 16px; transition: var(--transition); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); background: var(--bg-surface); box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        label { display: block; margin-bottom: 6px; font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); }

        .sort-select { width: auto; padding: 8px 12px; font-size: 0.85rem; border-radius: 8px; margin-bottom: 0; border: 1px solid var(--border-color); background-color: var(--bg-surface); color: var(--text-main); cursor: pointer; font-weight: 500; }
        .sort-select:hover { border-color: var(--primary); }

        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { text-align: left; padding: 16px 20px; color: var(--text-secondary); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; border-bottom: 1px solid var(--border-color); background: var(--bg-surface); position: sticky; top: 0; }
        td { padding: 16px 20px; border-bottom: 1px solid var(--border-color); font-size: 0.95rem; vertical-align: middle; }
        tr:hover td { background-color: var(--bg-body); }
        tr:last-child td { border-bottom: none; }

        .badge { padding: 6px 12px; border-radius: 999px; font-size: 0.75rem; font-weight: 700; display: inline-flex; align-items: center; cursor: pointer; transition: transform 0.2s; }
        .badge-blue { background: rgba(59, 130, 246, 0.1); color: #2563eb; border: 1px solid rgba(59, 130, 246, 0.2); }
        .badge-green { background: rgba(16, 185, 129, 0.1); color: #059669; border: 1px solid rgba(16, 185, 129, 0.2); }
        .badge-red { background: rgba(239, 68, 68, 0.1); color: #dc2626; border: 1px solid rgba(239, 68, 68, 0.2); }
        .badge-yellow { background: rgba(245, 158, 11, 0.1); color: #d97706; border: 1px solid rgba(245, 158, 11, 0.2); }
        .badge-gray { background: rgba(107, 114, 128, 0.1); color: var(--text-secondary); border: 1px solid rgba(107, 114, 128, 0.2); }

        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .flex-gap { display: flex; gap: 16px; }
        .clickable-link { color: var(--primary); font-weight: 600; cursor: pointer; transition: 0.2s; }
        .clickable-link:hover { text-decoration: underline; color: var(--primary-hover); }

        /* WIDGETS CALENDARIO */
        .calendar-widget { display: grid; grid-template-columns: 1fr 320px; gap: 32px; }
        .calendar-list { border-right: 1px solid var(--border-color); padding-right: 24px; max-height: 350px; overflow-y: auto; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
        .calendar-day-header { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; padding-bottom: 8px; }
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: var(--radius-md); font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: 0.2s; color: var(--text-main); position: relative; background: var(--bg-body); }
        .calendar-day:hover { background: var(--border-color); }
        .calendar-day.today { border: 2px solid var(--primary); background: rgba(79, 70, 229, 0.05); color: var(--primary); font-weight: 800; }
        .calendar-dots { display: flex; gap: 4px; margin-top: 4px; flex-wrap: wrap; justify-content: center; max-width: 80%; }
        .calendar-dot { width: 6px; height: 6px; border-radius: 50%; }
        .dot-deadline { background-color: var(--danger); }
        .dot-task { background-color: var(--info); }
        .dot-publication { background-color: var(--warning); }
        
        .calendar-legend { display: flex; gap: 15px; justify-content: center; margin-top: 20px; font-size: 0.85rem; color: var(--text-secondary); font-weight: 600; padding-top:15px; border-top: 1px solid var(--border-color); }
        .legend-item { display: flex; align-items: center; gap: 6px; }

        .smart-summary { background: var(--bg-body); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px; cursor: pointer; transition: 0.2s; }
        .smart-summary:hover { box-shadow: var(--shadow-md); border-color: var(--primary); }
        .summary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); }
        .summary-tag { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; padding: 4px 10px; border-radius: 8px; }
        .tag-blue { background: var(--primary); color: white; }
        .raw-text-content { display: none; }

        .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 0.9rem; margin-bottom: 20px; }
        .analysis-item { display: flex; flex-direction: column; background: var(--bg-body); padding: 12px; border-radius: var(--radius-md); }
        .analysis-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; }
        .analysis-val { font-weight: 500; color: var(--text-main); font-size: 0.9rem; white-space: pre-wrap; word-break: break-word; }
        .client-summary-box { background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); padding: 16px; border-radius: var(--radius-md); margin-top: 10px; font-size: 0.95rem; color: #b45309; line-height: 1.5; font-style: italic;}
        
        .full-timeline { position: relative; margin-top: 2rem; }
        .full-timeline::before { content: ''; position: absolute; left: 24px; top: 0; bottom: 0; width: 2px; background: var(--border-color); }
        .ft-item { position: relative; margin-bottom: 24px; padding-left: 60px; }
        .ft-icon { position: absolute; left: 8px; top: 0; width: 34px; height: 34px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; border: 4px solid var(--bg-surface); z-index: 2; box-shadow: var(--shadow-sm); }
        .ft-icon.finance { background: var(--success); } .ft-icon.create { background: var(--text-secondary); } .ft-icon.update { background: var(--info); } .ft-icon.analysis { background: var(--warning); }
        .ft-card { background: var(--bg-surface); padding: 1.5rem; border-radius: var(--radius-lg); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); transition: var(--transition); }
        
        .finance-summary-bar { margin-top: 1.5rem; padding: 1.5rem; background: var(--bg-body); border-radius: var(--radius-md); border: 1px solid var(--border-color); }
        .finance-progress { height: 10px; background: var(--border-color); border-radius: 5px; margin: 12px 0; overflow: hidden; display: flex; }
        .progress-received { background: var(--success); height: 100%; } .progress-pending { background: var(--warning); height: 100%; }

        .status-dropdown { position: absolute; background: var(--bg-surface); border: 1px solid var(--border-color); box-shadow: var(--shadow-lg); border-radius: var(--radius-md); z-index: 100; display: none; min-width: 180px; padding: 8px; }
        .status-dropdown.show { display: block; animation: slideUp 0.2s ease-out; }
        .status-option { padding: 10px 12px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 10px; color: var(--text-main); }
        .status-option:hover { background: var(--bg-body); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); z-index: 200; backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-surface); padding: 32px; border-radius: var(--radius-xl); width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg); border: 1px solid var(--border-color); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }

        .pub-view-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .pub-full-text { background: var(--bg-body); padding: 16px; border-radius: var(--radius-md); font-family: 'Courier New', monospace; font-size: 0.85rem; color: var(--text-secondary); max-height: 200px; overflow-y: auto; white-space: pre-wrap; border: 1px solid var(--border-color); word-break: break-word; }
        
        .menu-toggle { display: none; position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: var(--primary); color: white; box-shadow: var(--shadow-lg); z-index: 100; font-size: 24px; align-items: center; justify-content: center; border: none; }

        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* =========================================================
           MOBILE OPTIMIZATIONS (GRID COMPACTO E LIMPO)
        ========================================================= */
        @media (max-width: 768px) { 
            aside { position: fixed; height: 100%; left: calc(var(--sidebar-width) * -1); box-shadow: var(--shadow-lg); } 
            aside.active { left: 0; } 
            .menu-toggle { display: flex; bottom: 20px; } 
            .calendar-widget { grid-template-columns: 1fr; } 
            
            .app-topbar { 
                padding: 10px 16px; 
                height: auto;
                min-height: 70px;
                padding-top: calc(10px + env(safe-area-inset-top)); 
                position: relative;
                z-index: 40;
            }
            .topbar-main-row { width: 100%; }

            .analysis-grid { grid-template-columns: 1fr; } 
            
            .content-scroll { padding: 16px; }
            
            .dash-header { flex-direction: column; gap: 12px; margin-bottom: 16px; }
            .dash-header h2 { font-size: 1.4rem; }
            .dash-header .quick-actions { width: 100%; display: flex; gap: 8px; justify-content: space-between;}
            .dash-header .quick-actions button { flex: 1; font-size: 0.75rem; padding: 8px 4px;}
            
            .stats-grid { grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px; }
            .stat-card { padding: 12px 6px; min-height: auto; align-items: center; text-align: center; border-radius: var(--radius-md); }
            .stat-icon-bg { width: 32px; height: 32px; font-size: 1rem; margin-bottom: 6px; border-radius: 8px; }
            .stat-title { font-size: 0.6rem; letter-spacing: 0; }
            .stat-value { font-size: 1rem; margin: 4px 0 0 0; }
            
            .card { padding: 10px; margin-bottom: 16px; border-radius: var(--radius-md); overflow-x: hidden; }
            .calendar-widget { display: flex; flex-direction: column-reverse; gap: 16px; }
            
            table, thead, tbody, th, td, tr { display: block; width: 100%; border: none; }
            thead { display: none; } 
            
            tr { 
                background: var(--bg-surface);
                margin-bottom: 12px;
                border: 1px solid var(--border-color);
                border-radius: 12px;
                padding: 10px;
                box-shadow: 0 1px 2px rgba(0,0,0,0.03);
                display: grid !important; 
                grid-template-columns: 1fr 1fr; 
                gap: 4px 12px; 
            }
            
            td { 
                padding: 0; 
                border: none; 
                font-size: 0.85rem; 
                display: flex; 
                align-items: center;
                height: auto;
                min-height: auto;
            }
            
            td::before { content: none !important; }

            #clients-table-body tr { grid-template-areas: "name name" "role count" "val act"; }
            #clients-table-body td:nth-child(1) { grid-area: name; font-weight: 800; font-size: 1rem; margin-bottom: 6px; color: var(--primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; } 
            #clients-table-body td:nth-child(2) { grid-area: role; font-size: 0.8rem; color: var(--text-secondary); } 
            #clients-table-body td:nth-child(3) { grid-area: count; justify-content: flex-end; } 
            #clients-table-body td:nth-child(4) { grid-area: val; font-weight: 700; color: var(--text-main); font-size: 0.9rem; margin-top: 4px; } 
            #clients-table-body td:nth-child(5) { grid-area: act; justify-content: flex-end; margin-top: 4px; } 

            #cases-table-body tr { grid-template-areas: "num num" "client status" "area act"; }
            #cases-table-body td:nth-child(1) { grid-area: num; font-family: monospace; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px; } 
            #cases-table-body td:nth-child(2) { grid-area: client; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; padding-right: 5px; } 
            #cases-table-body td:nth-child(3) { grid-area: area; color: var(--text-secondary); font-size: 0.8rem; } 
            #cases-table-body td:nth-child(4) { grid-area: status; justify-content: flex-end; } 
            #cases-table-body td:nth-child(5) { grid-area: act; justify-content: flex-end; } 

            #deadlines-table-body tr { grid-template-areas: "date type" "proc proc" "status act"; }
            #deadlines-table-body td:nth-child(1) { grid-area: date; font-weight: 800; font-size: 0.95rem; } 
            #deadlines-table-body td:nth-child(2) { grid-area: type; justify-content: flex-end; } 
            #deadlines-table-body td:nth-child(3) { grid-area: proc; font-size: 0.85rem; color: var(--text-main); margin: 4px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; } 
            #deadlines-table-body td:nth-child(4) { grid-area: status; } 
            #deadlines-table-body td:nth-child(5) { grid-area: act; justify-content: flex-end; } 

            #tasks-table-body tr { grid-template-areas: "desc desc" "date prio" "link act"; }
            #tasks-table-body td:nth-child(1) { grid-area: prio; justify-content: flex-end; } 
            #tasks-table-body td:nth-child(2) { grid-area: desc; font-weight: 600; margin-bottom: 4px; } 
            #tasks-table-body td:nth-child(3) { grid-area: link; font-size: 0.8rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; } 
            #tasks-table-body td:nth-child(4) { grid-area: date; font-size: 0.85rem; } 
            #tasks-table-body td:nth-child(5) { grid-area: act; justify-content: flex-end; } 

            #finance-ledger-body tr, #finance-table-body tr { display: flex !important; flex-direction: column; gap: 6px; }
            #finance-ledger-body td, #finance-table-body td { width: 100%; justify-content: space-between; }
            
            .badge { padding: 4px 8px; font-size: 0.7rem; }
            .btn-sm { padding: 4px 8px; font-size: 0.75rem; }
            .sort-select { padding: 6px; font-size: 0.75rem; border-radius: 6px; }

            .modal-content { padding: 16px !important; width: 95% !important; border-radius: 16px !important; overflow-y: auto; max-height: 95vh; }
            .modal h3 { font-size: 1.1rem !important; margin: 0 !important; }
            .modal .flex-between { margin-bottom: 12px !important; }
            .flex-gap { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 10px !important; flex-direction: row !important; }
            .mobile-full { grid-column: span 2; }
            
            .modal input, .modal select, .modal textarea { padding: 0 10px !important; height: 38px !important; font-size: 0.9rem !important; margin-bottom: 8px !important; border-radius: 8px !important; }
            .modal textarea { height: 60px !important; padding-top: 8px !important; }
            .modal label { font-size: 0.7rem !important; margin-bottom: 2px !important; text-transform: uppercase; color: var(--text-secondary); }
            
            #modal-case form { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
            #modal-case form > div { margin: 0 !important; }
            #modal-case .flex-gap { display: contents !important; }
            #modal-case input[name="client"], #modal-case input[name="opponent"], #modal-case input[name="lawyer"], #modal-case textarea[name="obs"], #modal-case button { grid-column: span 2; }

            .case-detail-card { 
                padding: 0; 
                background: transparent; 
                box-shadow: none; 
                border: none; 
                margin-bottom: 24px; 
                margin-top: 10px;
            }
            
            .case-header-optimized {
                display: flex;
                justify-content: space-between;
                align-items: center; 
                padding-bottom: 16px;
                border-bottom: 1px solid var(--border-color);
                margin-bottom: 20px;
                gap: 12px;
            }

            .case-number-box {
                display: flex;
                flex-direction: column;
                justify-content: center;
                flex: 1;
                min-width: 0; 
            }

            .case-number-label {
                font-size: 0.65rem;
                color: var(--text-secondary);
                text-transform: uppercase;
                font-weight: 700;
                margin-bottom: 4px;
                letter-spacing: 0.5px;
            }

            .case-number-main {
                font-family: 'Courier New', Courier, monospace;
                font-size: 1rem; 
                font-weight: 600; 
                color: var(--text-main);
                letter-spacing: -0.5px;
                line-height: 1.2;
                white-space: normal; 
                word-break: break-all;
            }
            
            .case-info-grid { 
                display: grid; 
                grid-template-columns: 1fr 1fr; 
                gap: 16px; 
                background: var(--bg-surface); 
                padding: 20px; 
                border-radius: 16px; 
                border: 1px solid var(--border-color); 
                margin-bottom: 16px; 
                box-shadow: var(--shadow-sm); 
            }
            
            .info-item label { 
                font-size: 0.65rem; 
                color: var(--text-muted); 
                text-transform: uppercase; 
                font-weight: 800; 
                margin-bottom: 4px; 
                display: block; 
                letter-spacing: 0.5px; 
            }
            
            .info-item div { 
                font-size: 0.95rem; 
                font-weight: 500; 
                color: var(--text-main); 
                white-space: nowrap; 
                overflow: hidden; 
                text-overflow: ellipsis; 
            }
            
            .finance-compact { 
                background: var(--bg-surface); 
                padding: 16px; 
                border-radius: 12px; 
                border: 1px solid var(--border-color); 
                margin-bottom: 20px; 
                box-shadow: var(--shadow-sm); 
            }
            
            .finance-compact .finance-row { 
                display: flex; 
                justify-content: space-between; 
                font-size: 0.85rem; 
                margin-bottom: 8px; 
                color: var(--text-secondary); 
            }
            
            .finance-compact b { color: var(--text-main); }
            .finance-compact .finance-progress { height: 6px; border-radius: 4px; }
            
            .btn-group-mobile { 
                display: grid; 
                grid-template-columns: 1fr 1fr; 
                gap: 12px; 
                padding-top: 10px; 
            }
            
            .btn-group-mobile button { 
                width: 100%; 
                margin: 0; 
                height: 48px; 
            }
        }

        /* SAFE AREA */
        @supports (padding-top: env(safe-area-inset-top)) {
            .app-topbar { padding-top: calc(10px + env(safe-area-inset-top)) !important; }
            @media (max-width: 768px) { .app-topbar { padding-top: env(safe-area-inset-top) !important; } }
            aside { padding-top: calc(24px + env(safe-area-inset-top, 0px)); padding-bottom: env(safe-area-inset-bottom, 0px); }
            .content-scroll { padding-bottom: calc(32px + env(safe-area-inset-bottom, 0px)); }
            .menu-toggle { bottom: calc(20px + env(safe-area-inset-bottom, 0px)) !important; }
            .modal { padding-top: env(safe-area-inset-top, 0px); padding-bottom: env(safe-area-inset-bottom, 0px); }
        }
    </style>
</head>
<body>

    <button class="menu-toggle" onclick="app.toggleSidebar()">‚ò∞</button>

    <aside id="sidebar">
        <div class="logo"><svg viewBox="0 0 24 24"><path d="M12 2L1 21h22L12 2zm0 3.5L19.5 19h-15L12 5.5z"/></svg> LexManager</div>
        <nav>
            <button onclick="app.navigate('dashboard')" class="active" id="nav-dashboard">üìä Dashboard</button>
            <button onclick="app.navigate('updates')" id="nav-updates">üì¢ Publica√ß√µes</button>
            <button onclick="app.navigate('analyses')" id="nav-analyses">üß† Estrat√©gias</button>
            <button onclick="app.navigate('cases')" id="nav-cases">‚öñÔ∏è Processos</button>
            <button onclick="app.navigate('clients')" id="nav-clients">üë• Clientes</button>
            <button onclick="app.navigate('deadlines')" id="nav-deadlines">‚è≥ Prazos</button>
            <button onclick="app.navigate('tasks')" id="nav-tasks">üìù Tarefas</button>
            <button onclick="app.navigate('finance')" id="nav-finance">üí∞ Financeiro</button>
            <button onclick="app.navigate('settings')" id="nav-settings">‚öôÔ∏è Configura√ß√µes</button>
        </nav>
    </aside>

    <main>
        <div class="app-topbar">
            <div class="topbar-main-row">
                <div class="header-titles">
                    <h1>Painel Executivo</h1>
                    <small>Vis√£o Geral</small>
                </div>
                <div class="header-actions">
                    <button class="btn-outline btn-sm" onclick="app.toggleDarkMode()">üåì</button>
                    <div id="topbar-avatar" style="width:38px; height:38px; border-radius:50%; background:var(--primary-gradient); color:white; display:flex; align-items:center; justify-content:center; font-weight: 700; overflow:hidden; font-size: 0.9rem;">Dr</div>
                </div>
            </div>
        </div>

        <div class="content-scroll">
            
            <section id="view-dashboard">
                <div class="dash-header">
                    <div><h2 id="dash-greeting">Ol√°, Doutor(a)</h2><p style="color:var(--text-secondary); margin-top:4px;">Resumo estrat√©gico do escrit√≥rio.</p></div>
                    <div class="quick-actions flex-gap">
                        <button class="btn btn-outline" onclick="app.openModal('modal-case')">‚ûï Processo</button>
                        <button class="btn btn-outline" onclick="app.openFullAnalysisModal()">üìÇ Analisar Autos</button>
                        <button class="btn btn-primary" onclick="app.openModal('modal-import')">üìã Importar Pub.</button>
                    </div>
                </div>

                <div class="stats-grid" id="dashboard-stats-grid">
                    <div class="stat-card card-blue" data-id="ativos" draggable="true" onclick="if(!app.isDragging) app.navigate('cases')">
                        <div class="stat-icon-bg">‚öñÔ∏è</div><div class="stat-title">Ativos</div><div class="stat-value" id="dash-active">0</div>
                    </div>
                    <div class="stat-card card-red" data-id="prazos" draggable="true" onclick="if(!app.isDragging) app.navigate('deadlines')">
                        <div class="stat-icon-bg">‚è≥</div><div class="stat-title">Prazos Hoje</div><div class="stat-value text-danger" id="dash-today">0</div>
                    </div>
                    <div class="stat-card card-green" data-id="saldo" draggable="true" onclick="if(!app.isDragging) app.navigate('finance')">
                        <div class="stat-icon-bg">üí∞</div><div class="stat-title">Recebido (Total)</div><div class="stat-value text-success" id="dash-finance-received">R$ 0,00</div>
                    </div>
                </div>

                <div class="card">
                    <div class="flex-between" style="margin-bottom: 1.5rem;"><h3>üìÖ Agenda Forense</h3><span id="calendar-month-label" style="font-weight:700; color:var(--primary); text-transform:uppercase; font-size:0.85rem;"></span></div>
                    <div class="calendar-widget">
                        <div class="calendar-list" id="calendar-list-content"></div>
                        <div>
                            <div class="calendar-grid" style="margin-bottom:5px;"><div class="calendar-day-header">D</div><div class="calendar-day-header">S</div><div class="calendar-day-header">T</div><div class="calendar-day-header">Q</div><div class="calendar-day-header">Q</div><div class="calendar-day-header">S</div><div class="calendar-day-header">S</div></div>
                            <div class="calendar-grid" id="calendar-grid-content"></div>
                            
                            <div class="calendar-legend">
                                <div class="legend-item"><div class="calendar-dot dot-deadline"></div> Prazo</div>
                                <div class="legend-item"><div class="calendar-dot dot-task"></div> Tarefa</div>
                                <div class="legend-item"><div class="calendar-dot dot-publication"></div> Pub.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="view-cases" class="hidden">
                <div class="flex-between" style="margin-bottom:1.5rem;">
                    <h2>Processos</h2>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <select class="sort-select" onchange="app.changeSort('cases', this.value)">
                            <option value="date">üïí Data</option>
                            <option value="name">A-Z Nome</option>
                        </select>
                        <button class="btn btn-primary" onclick="app.openModal('modal-case')">+ Novo Processo</button>
                    </div>
                </div>
                <div class="card" style="overflow-x:auto; padding-bottom: 0;"><table style="width:100%"><thead><tr><th>N√∫mero</th><th>Cliente</th><th>√Årea</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="cases-table-body"></tbody></table></div>
            </section>

            <section id="view-updates" class="hidden">
                <div class="dash-header">
                    <div><h2>Central de Publica√ß√µes</h2><p style="color:var(--text-secondary); margin-top:4px;">An√°lise inteligente via IA.</p></div>
                    <div class="quick-actions" style="display:flex; gap:10px; align-items:center;">
                        <select class="sort-select" onchange="app.changeSort('updates', this.value)">
                            <option value="date">üïí Data</option>
                            <option value="name">A-Z Cliente</option>
                        </select>
                        <button class="btn btn-primary" onclick="app.openModal('modal-import')">‚ú® Analisar Nova</button>
                    </div>
                </div>
                <div id="updates-list-full"></div>
            </section>
            
            <section id="view-analyses" class="hidden">
                <div class="dash-header">
                    <div><h2>An√°lises Estrat√©gicas</h2><p style="color:var(--text-secondary); margin-top:4px;">Diagn√≥sticos de autos completos.</p></div>
                    <div class="quick-actions" style="display:flex; gap:10px; align-items:center;">
                        <button class="btn btn-primary" onclick="app.openFullAnalysisModal()">‚ú® Nova An√°lise</button>
                    </div>
                </div>
                <div id="analyses-list-full"></div>
            </section>

            <section id="view-clients" class="hidden">
                <div class="flex-between" style="margin-bottom:1.5rem;">
                    <h2>Clientes</h2>
                    <select class="sort-select" onchange="app.changeSort('clients', this.value)">
                        <option value="name">A-Z Nome</option>
                        <option value="value">üí∞ Maior Valor</option>
                    </select>
                </div>
                <div class="card" style="overflow-x:auto; padding-bottom: 0;"><table style="width:100%"><thead><tr><th>Cliente</th><th>Posi√ß√£o</th><th>Processos Ativos</th><th>Total Causa</th><th>A√ß√µes</th></tr></thead><tbody id="clients-table-body"></tbody></table></div>
            </section>
            
            <section id="view-finance" class="hidden">
                <div class="flex-between" style="margin-bottom:1.5rem;">
                    <h2>Financeiro</h2>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <select class="sort-select" onchange="app.changeSort('finance', this.value)">
                            <option value="date">üïí Mais Recentes</option>
                            <option value="name">A-Z Cliente</option>
                        </select>
                        <button class="btn btn-primary" onclick="app.openModal('modal-payment')">+ Novo</button>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card" style="border-top: 4px solid var(--info)"><div class="stat-title">A Receber</div><div class="stat-value" id="fin-pending">R$ 0,00</div></div>
                    <div class="stat-card" style="border-top: 4px solid var(--success)"><div class="stat-title">Entradas</div><div class="stat-value text-success" id="fin-received-tab">R$ 0,00</div></div>
                    <div class="stat-card" style="border-top: 4px solid var(--danger)"><div class="stat-title">Sa√≠das</div><div class="stat-value text-danger" id="fin-expenses-tab">R$ 0,00</div></div>
                    <div class="stat-card" style="border-top: 4px solid var(--primary)"><div class="stat-title">Saldo L√≠quido</div><div class="stat-value" id="fin-balance-tab">R$ 0,00</div></div>
                </div>
                
                <h3 style="margin-bottom: 1rem; margin-top:2rem;">Hist√≥rico Geral de Caixa (Lan√ßamentos)</h3>
                <div class="card" style="overflow-x:auto; padding-bottom: 0;"><table style="width:100%"><thead><tr><th>Data</th><th>Tipo</th><th>Descri√ß√£o</th><th>Cliente</th><th>Valor</th><th>A√ß√µes</th></tr></thead><tbody id="finance-ledger-body"></tbody></table></div>
                
                <h3 style="margin-bottom: 1rem; margin-top:2rem;">Balan√ßo por Processo</h3>
                <div class="card" style="overflow-x:auto; padding-bottom: 0;"><table style="width:100%"><thead><tr><th>Cliente / Processo</th><th>Contrato</th><th>Recebido</th><th>Saldo Devedor</th><th>A√ß√µes</th></tr></thead><tbody id="finance-table-body"></tbody></table></div>
            </section>

            <section id="view-deadlines" class="hidden">
                <div class="flex-between" style="margin-bottom:1.5rem;">
                    <h2>Prazos</h2>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <select class="sort-select" onchange="app.changeSort('deadlines', this.value)">
                            <option value="date">üïí Pr√≥ximos</option>
                            <option value="name">A-Z Processo</option>
                        </select>
                        <button class="btn btn-primary" onclick="app.openModal('modal-deadline')">+ Novo</button>
                    </div>
                </div>
                <div class="card" style="overflow-x:auto; padding-bottom: 0;"><table style="width:100%"><thead><tr><th>Data</th><th>Tipo</th><th>Processo</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="deadlines-table-body"></tbody></table></div>
            </section>
            
            <section id="view-tasks" class="hidden">
                <div class="flex-between" style="margin-bottom:1.5rem;">
                    <h2>Tarefas</h2>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <select class="sort-select" onchange="app.changeSort('tasks', this.value)">
                            <option value="date">üïí Pr√≥ximas</option>
                            <option value="name">A-Z Descri√ß√£o</option>
                        </select>
                        <button class="btn btn-primary" onclick="app.openModal('modal-task')">+ Tarefa</button>
                    </div>
                </div>
                <div class="card" style="overflow-x:auto; padding-bottom: 0;"><table style="width:100%"><thead><tr><th>Prioridade</th><th>Descri√ß√£o</th><th>V√≠nculo</th><th>Prazo</th><th>A√ß√µes</th></tr></thead><tbody id="tasks-table-body"></tbody></table></div>
            </section>
            
            <section id="view-settings" class="hidden">
                <h2>Configura√ß√µes</h2>
                <div class="card" style="max-width: 500px; margin-top:20px;">
                    
                    <h4 style="margin-bottom: 10px; font-size:0.9rem; color:var(--text-secondary);">Perfil do Usu√°rio</h4>
                    
                    <label>Foto de Perfil</label>
                    <div style="display:flex; gap:10px; margin-bottom:15px; align-items: center;">
                        <input type="file" id="settings-profile-pic" accept="image/*" style="margin-bottom:0;" onchange="app.saveProfilePic(event)">
                        <button class="btn btn-outline btn-sm" onclick="app.removeProfilePic()">Remover</button>
                    </div>

                    <label>Nome de Exibi√ß√£o (Reflete no Dashboard)</label>
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <input type="text" id="settings-user-name" placeholder="Ex: Dr. Jo√£o Silva" style="margin-bottom:0;">
                        <button class="btn btn-primary" onclick="app.saveUserName()">Salvar</button>
                    </div>

                    <hr style="margin:25px 0; border:0; border-top:1px solid var(--border-color);">
                    
                    <h4 style="margin-bottom: 15px; font-size:0.9rem; color:var(--text-secondary);">Integra√ß√µes e Produtividade</h4>
                    <button class="btn btn-outline" style="width:100%; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                        <span>Sincronizar Financeiro com Notion</span> <span style="font-size: 1.2rem;">üîó</span>
                    </button>
                    <button class="btn btn-outline" style="width:100%; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                        <span>Alertas de Prazos via WhatsApp</span> <span style="font-size: 1.2rem;">üì±</span>
                    </button>

                    <hr style="margin:25px 0; border:0; border-top:1px solid var(--border-color);">

                    <h4 style="margin-bottom: 15px; font-size:0.9rem; color:var(--text-secondary);">Apar√™ncia do Sistema</h4>
                    <button class="btn btn-outline" style="width:100%; margin-bottom:15px;" onclick="app.toggleDarkMode()">üåì Alternar Tema Claro/Escuro</button>
                    
                    <hr style="margin:25px 0; border:0; border-top:1px solid var(--border-color);">
                    
                    <h4 style="margin-bottom: 15px; font-size:0.9rem; color:var(--text-secondary);">Gerenciamento de Dados</h4>
                    <button class="btn btn-outline" style="width:100%; margin-bottom:10px; color: var(--info); border-color: var(--info);" onclick="app.exportBackup()">üíæ Fazer Backup de Seguran√ßa (.json)</button>
                    <button class="btn btn-outline" style="width:100%; margin-bottom:20px; color: var(--warning); border-color: var(--warning);" onclick="document.getElementById('import-file').click()">üìÇ Restaurar Backup Antigo</button>
                    <input type="file" id="import-file" style="display:none" accept=".json" onchange="app.importBackup(event)">
                    
                    <button class="btn btn-danger" style="width:100%; margin-top:10px;" onclick="app.clearData()">‚ö†Ô∏è Limpar Todos os Dados</button>
                </div>
            </section>

            <section id="view-case-detail" class="hidden"><button class="btn btn-outline" onclick="app.navigate('cases')" style="margin-bottom:1rem;">‚Üê Voltar</button><div id="case-detail-content"></div></section>
        </div>

        <div id="status-menu" class="status-dropdown">
            <div class="status-option" onclick="app.changeStatus('Em andamento')"><div class="status-dot" style="background:#2563eb"></div>Em andamento</div>
            <div class="status-option" onclick="app.changeStatus('Suspenso')"><div class="status-dot" style="background:#f59e0b"></div>Suspenso</div>
            <div class="status-option" onclick="app.changeStatus('Finalizado')"><div class="status-dot" style="background:#10b981"></div>Finalizado</div>
            <div class="status-option" onclick="app.changeStatus('Arquivado')"><div class="status-dot" style="background:var(--text-secondary)"></div>Arquivado</div>
        </div>

        <div id="modal-import" class="modal">
            <div class="modal-content">
                <div class="flex-between" style="margin-bottom:20px;"><h3>Analisar Nova Publica√ß√£o</h3><button class="btn-outline btn-sm" style="border:none;" onclick="app.closeModal('modal-import')">‚úï</button></div>
                <input type="hidden" id="import-id">
                
                <div id="step-1-import">
                    <label style="color:var(--primary); font-weight:800; font-size:1rem;">PASSO 1: Publica√ß√£o Original</label>
                    <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:10px;">Cole o texto bruto retirado do Di√°rio Oficial.</p>
                    <textarea id="import-text" rows="5" placeholder="Cole o texto aqui..."></textarea>
                    
                    <label style="margin-top:10px;">Meu cliente neste processo atua como:</label>
                    <select id="import-client-role" style="margin-bottom:10px;">
                        <option value="autor">Autor / Reclamante</option>
                        <option value="reu">R√©u / Reclamado</option>
                        <option value="desconhecido" selected>An√°lise Neutra (N√£o sei ainda)</option>
                    </select>

                    <div style="text-align:right; margin-top:10px; display:flex; justify-content:flex-end; gap:10px;">
                        <button class="btn" style="background: linear-gradient(135deg, #1d4ed8, #3b82f6); color:white; display:inline-flex; align-items:center; gap:8px;" onclick="app.analyzeWithAI('gemini')">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12.0001 0.354126C12.0001 0.354126 12.3789 7.74971 18.0001 11.2501C18.0001 11.2501 11.854 12.8727 12.0001 23.646C12.0001 23.646 11.6212 16.2505 6.00007 12.75C6.00007 12.75 12.1462 11.1274 12.0001 0.354126Z"/></svg> Gemini
                        </button>
                        <button class="btn" style="background: linear-gradient(135deg, #10b981, #059669); color:white; display:inline-flex; align-items:center; gap:8px;" onclick="app.analyzeWithAI('chatgpt')">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A6.0651 6.0651 0 0 0 19.0193 19.82a5.9847 5.9847 0 0 0 3.9977-2.9 6.0462 6.0462 0 0 0-.735-7.0988zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.8956zm16.0993 3.8558L12.604 8.3829V3.8105a.0757.0757 0 0 1 .0332-.0615l4.83-2.7866a4.504 4.504 0 0 1 6.136 1.6464 4.4708 4.4708 0 0 1 .5346 3.0137l-.1419-.0852-4.783-2.7582a.7712.7712 0 0 0-.7806 0zM8.4065 5.394C8.8253 4.0967 10.0461 3.2 11.411 3.2h.023l-.1419.0804-4.7783 2.7582a.7948.7948 0 0 0-.3927.6813v6.7369l-2.02-1.1686a.071.071 0 0 1-.038-.052V6.6528a4.504 4.504 0 0 1 4.3434-1.2588zm2.3438 6.2624l-2.5126-1.4503V7.3054l2.5126-1.4503 2.5126 1.4503v2.9007z"/></svg> ChatGPT
                        </button>
                    </div>

                    <hr style="margin: 25px 0; border:0; border-top:1px dashed var(--border-color)">
                    
                    <label style="color:var(--primary); font-weight:800; font-size:1rem;">PASSO 2: Resultado da IA</label>
                    <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:10px;">Ap√≥s copiar o resultado na IA, cole-o na caixa abaixo.</p>
                    <textarea id="ai-result-text" rows="6" placeholder="Cole o resultado estruturado gerado pela Intelig√™ncia Artificial..."></textarea>
                    <button class="btn btn-primary" style="width:100%; margin-top:10px; padding:15px; font-size:1rem;" onclick="app.parseAIResult()">ü™Ñ Extrair Dados e Salvar</button>
                </div>

                <div id="step-2-import" style="display:none;">
                    <div style="text-align:center; padding: 20px 0;">
                        <h3 style="color:var(--success); margin-bottom:10px;">‚úÖ An√°lise Extra√≠da com Sucesso!</h3>
                        <div id="match-info" style="font-size:0.95rem; color:var(--text-secondary);"></div>
                    </div>
                    <div style="text-align:right; margin-top:20px; display:flex; justify-content:space-between;">
                        <button class="btn btn-outline" onclick="app.backToStep1()">‚Üê Corrigir</button>
                        <button class="btn btn-primary" onclick="app.saveParsedImport()">üíæ Finalizar Registro</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal-full-analysis" class="modal">
            <div class="modal-content">
                <div class="flex-between" style="margin-bottom:20px;"><h3>An√°lise Completa de Autos</h3><button class="btn-outline btn-sm" style="border:none;" onclick="app.closeModal('modal-full-analysis'); app.editAnalysisId=null;">‚úï</button></div>
                
                <div id="full-analysis-step-1">
                    <label style="color:var(--primary); font-weight:800; font-size:1rem;">PASSO 1: Selecionar Texto ou Processo</label>
                    <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:10px;">Selecione um processo cadastrado para incluir o hist√≥rico ou cole o texto.</p>
                    
                    <label>Carregar Hist√≥rico do Processo</label>
                    <select id="full-analysis-case-select" onchange="app.loadCaseContext()" style="margin-bottom:10px;">
                        <option value="">-- Selecione ou use texto avulso --</option>
                    </select>

                    <label>Meu Cliente √©:</label>
                    <select id="full-analysis-role" style="margin-bottom:10px;">
                        <option value="autor">Autor / Reclamante</option>
                        <option value="reu">R√©u / Reclamado</option>
                    </select>

                    <textarea id="full-analysis-text" rows="5" placeholder="Cole o texto do processo ou hist√≥rico aqui..."></textarea>

                    <div style="text-align:right; margin-top:10px; display:flex; justify-content:flex-end; gap:10px;">
                        <button class="btn" style="background: linear-gradient(135deg, #1d4ed8, #3b82f6); color:white; display:inline-flex; align-items:center; gap:8px;" onclick="app.analyzeFullCase('gemini')">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12.0001 0.354126C12.0001 0.354126 12.3789 7.74971 18.0001 11.2501C18.0001 11.2501 11.854 12.8727 12.0001 23.646C12.0001 23.646 11.6212 16.2505 6.00007 12.75C6.00007 12.75 12.1462 11.1274 12.0001 0.354126Z"/></svg> Gemini
                        </button>
                        <button class="btn" style="background: linear-gradient(135deg, #10b981, #059669); color:white; display:inline-flex; align-items:center; gap:8px;" onclick="app.analyzeFullCase('chatgpt')">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A6.0651 6.0651 0 0 0 19.0193 19.82a5.9847 5.9847 0 0 0 3.9977-2.9 6.0462 6.0462 0 0 0-.735-7.0988zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.8956zm16.0993 3.8558L12.604 8.3829V3.8105a.0757.0757 0 0 1 .0332-.0615l4.83-2.7866a4.504 4.504 0 0 1 6.136 1.6464 4.4708 4.4708 0 0 1 .5346 3.0137l-.1419-.0852-4.783-2.7582a.7712.7712 0 0 0-.7806 0zM8.4065 5.394C8.8253 4.0967 10.0461 3.2 11.411 3.2h.023l-.1419.0804-4.7783 2.7582a.7948.7948 0 0 0-.3927.6813v6.7369l-2.02-1.1686a.071.071 0 0 1-.038-.052V6.6528a4.504 4.504 0 0 1 4.3434-1.2588zm2.3438 6.2624l-2.5126-1.4503V7.3054l2.5126-1.4503 2.5126 1.4503v2.9007z"/></svg> ChatGPT
                        </button>
                    </div>
                    <hr style="margin: 25px 0; border:0; border-top:1px dashed var(--border-color)">
                </div>
                
                <label style="color:var(--primary); font-weight:800; font-size:1rem;">PASSO 2: Resultado da An√°lise</label>
                <textarea id="full-analysis-result" rows="8" placeholder="Cole aqui a an√°lise estrat√©gica gerada pela IA..."></textarea>
                <button class="btn btn-primary" style="width:100%; margin-top:10px; padding:15px; font-size:1rem;" onclick="app.saveFullAnalysis()">üíæ Salvar na Ficha do Processo</button>
            </div>
        </div>

        <div id="modal-publication-view" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="flex-between" style="margin-bottom:20px"><h3>Vis√£o Estrat√©gica</h3><button class="btn-outline btn-sm" style="border:none;" onclick="app.closeModal('modal-publication-view')">‚úï</button></div>
                <div class="pub-view-grid">
                    <div id="pub-view-summary"></div>
                    <div style="margin-top:20px;">
                        <label>Texto Original Di√°rio Oficial:</label>
                        <div class="pub-full-text" id="pub-view-text"></div>
                    </div>
                </div>
                <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px; border-top:1px solid var(--border-color); padding-top:20px;">
                    <div id="pub-view-extra-actions"></div>
                    <button class="btn btn-primary" id="pub-view-action-btn">üìÖ Ir para Prazos</button>
                </div>
            </div>
        </div>

        <div id="modal-case" class="modal">
            <div class="modal-content">
                <div class="flex-between"><h3>Processo</h3><button class="btn-outline btn-sm" style="border:none;" onclick="app.closeModal('modal-case')">‚úï</button></div>
                <form onsubmit="app.saveCase(event)">
                    <input type="hidden" name="id">
                    <div style="display:flex; flex-direction:column;"><label>N√∫mero</label><input type="text" name="number" required></div>
                    <div style="display:flex; flex-direction:column;"><label>Status</label><select name="status"><option>Em andamento</option><option>Suspenso</option><option>Finalizado</option><option>Arquivado</option></select></div>
                    <div class="mobile-full" style="display:flex; justify-content:flex-end;"><button type="button" class="btn-outline btn-sm" style="border:none; color:var(--primary); font-weight:700; padding:2px;" onclick="app.swapClientOpponent()">üîÅ Inverter Partes</button></div>
                    <div style="grid-column: span 2;"><label>Meu Cliente</label><input type="text" name="client" required></div>
                    <div><label>Posi√ß√£o</label><select name="client_role"><option value="autor">Autor</option><option value="reu">R√©u</option></select></div>
                    <div><label>√Årea</label><select name="area"><option>C√≠vel</option><option>Trabalhista</option><option>Fam√≠lia</option><option>Penal</option><option>Previdenc.</option><option>Tribut√°rio</option><option>Empresarial</option><option>Consumidor</option></select></div>
                    <div style="grid-column: span 2;"><label>Parte Adversa</label><input type="text" name="opponent"></div>
                    <div><label>Valor (R$)</label><input type="number" name="value" step="0.01"></div>
                    <div><label>Data In√≠cio</label><input type="date" name="date_start"></div>
                    <div><label>Honor√°rios</label><input type="number" name="fees" step="0.01"></div>
                    <div><label>Advogado</label><input type="text" name="lawyer"></div>
                    <div style="grid-column: span 2;"><label>Obs</label><textarea name="obs"></textarea></div>
                    <button class="btn btn-primary" style="width:100%; margin-top:0;">Salvar</button>
                </form>
            </div>
        </div>
        
        <div id="modal-deadline" class="modal">
            <div class="modal-content">
                <div class="flex-between"><h3>Prazo</h3><button class="btn-outline btn-sm" style="border:none;" onclick="app.closeModal('modal-deadline')">‚úï</button></div>
                <form onsubmit="app.saveDeadline(event)">
                    <input type="hidden" name="id"><input type="hidden" name="caseId" id="deadline-case-id">
                    <div id="case-selector-container"><label>Processo</label><select id="case-select-dropdown" name="caseSelect" onchange="document.getElementById('deadline-case-id').value=this.value"><option value="">Selecione...</option></select></div>
                    <label>Tipo</label><input type="text" name="type" required>
                    <div class="flex-gap"><div style="flex:1"><label>Data In√≠cio</label><input type="date" name="date_start"></div><div style="flex:1"><label>Data Fatal</label><input type="date" name="date" required></div></div>
                    <button class="btn btn-primary" style="width:100%; margin-top:5px;">Salvar Prazo</button>
                </form>
            </div>
        </div>

        <div id="modal-task" class="modal"><div class="modal-content"><div class="flex-between" style="margin-bottom:20px"><h3>Tarefa</h3><button class="btn-outline btn-sm" style="border:none;" onclick="app.closeModal('modal-task')">‚úï</button></div><form onsubmit="app.saveTask(event)"><input type="hidden" name="id"><label>V√≠nculo</label><select id="task-case-select" name="caseId"><option value="">Geral</option></select><label>Descri√ß√£o</label><input type="text" name="desc" required><div class="flex-gap"><div style="flex:1"><label>Prioridade</label><select name="priority"><option>Alta</option><option selected>M√©dia</option><option>Baixa</option></select></div><div style="flex:1"><label>Data</label><input type="date" name="date" required></div></div><button class="btn btn-primary" style="width:100%; margin-top:10px;">Adicionar</button></form></div></div>

        <div id="modal-payment" class="modal">
            <div class="modal-content">
                <div class="flex-between"><h3>Novo Lan√ßamento</h3><button class="btn-outline btn-sm" style="border:none;" onclick="app.closeModal('modal-payment')">‚úï</button></div>
                <form onsubmit="app.saveTransaction(event)">
                    <label>Processo / Cliente</label><select name="caseId" id="payment-case-select" required><option value="">Selecione...</option></select>
                    <div class="flex-gap"><div style="flex:1"><label>Tipo</label><select name="type"><option value="income">Recebimento (+)</option><option value="expense">Despesa (-)</option></select></div><div style="flex:1"><label>Valor (R$)</label><input type="number" step="0.01" name="amount" required></div></div>
                    <label>Descri√ß√£o</label><input type="text" name="desc" placeholder="Ex: Custas, honor√°rios..." required>
                    <button class="btn btn-success" style="width:100%; margin-top:5px;">Registrar</button>
                </form>
            </div>
        </div>

        <div id="modal-client-detail" class="modal"><div class="modal-content"><div class="flex-between" style="margin-bottom:20px;"><h3>Ficha</h3><button class="btn-outline btn-sm" style="border:none;" onclick="app.closeModal('modal-client-detail')">‚úï</button></div><div id="client-detail-body"></div></div></div>
        
        <div id="modal-day-details" class="modal"><div class="modal-content" style="max-width:500px"><div class="flex-between" style="margin-bottom:20px"><h3 id="day-details-title">Detalhes</h3><button class="btn-outline btn-sm" style="border:none;" onclick="app.closeModal('modal-day-details')">‚úï</button></div><div id="day-details-body"></div></div></div>
        
    </main>

    <script>
        const app = {
            data: { cases: [], deadlines: [], transactions: [], updates: [], tasks: [], settings: { theme: 'light', dashOrder: ['ativos', 'prazos', 'saldo'], userName: 'Doutor(a)', profilePic: null } },
            sortState: { cases: 'date', updates: 'date', clients: 'name', deadlines: 'date', tasks: 'date', finance: 'date' },
            currentStatusId: null,
            tempParsedData: null,
            isDragging: false,
            editAnalysisId: null,

            init() {
                this.loadData();
                if(localStorage.getItem('lexTheme') === 'dark') document.body.classList.add('dark-mode');
                
                const dashOrder = this.data.settings.dashOrder || ['ativos', 'prazos', 'saldo'];
                const dashGrid = document.getElementById('dashboard-stats-grid');
                if(dashGrid) {
                    dashOrder.forEach(id => {
                        const card = dashGrid.querySelector(`[data-id="${id}"]`);
                        if(card) dashGrid.appendChild(card);
                    });

                    let dragged = null;
                    dashGrid.addEventListener('dragstart', e => { const card = e.target.closest('.stat-card'); if(card) { dragged = card; dragged.style.opacity = '0.5'; this.isDragging = true; } });
                    dashGrid.addEventListener('dragend', e => { if(dragged) { dragged.style.opacity = '1'; const newOrder = Array.from(dashGrid.querySelectorAll('.stat-card')).map(c => c.dataset.id); this.data.settings.dashOrder = newOrder; this.saveToStorage(); setTimeout(() => this.isDragging = false, 100); dragged = null; } });
                    dashGrid.addEventListener('dragover', e => { e.preventDefault(); const targetCard = e.target.closest('.stat-card'); if(targetCard && targetCard !== dragged && dragged) { const rect = targetCard.getBoundingClientRect(); const next = (e.clientX - rect.left) / (rect.right - rect.left) > 0.5; dashGrid.insertBefore(dragged, next ? targetCard.nextSibling : targetCard); } });

                    let touchTimer;
                    dashGrid.addEventListener('touchstart', e => { const card = e.target.closest('.stat-card'); if(card && e.touches.length === 1) { touchTimer = setTimeout(() => { dragged = card; this.isDragging = true; dragged.style.opacity = '0.7'; dragged.style.transform = 'scale(0.95)'; dragged.style.pointerEvents = 'none'; if(navigator.vibrate) navigator.vibrate(50); }, 400); } }, {passive: false});
                    dashGrid.addEventListener('touchmove', e => { if(dragged && this.isDragging) { e.preventDefault(); const touch = e.touches[0]; const targetEl = document.elementFromPoint(touch.clientX, touch.clientY); if(targetEl) { const targetCard = targetEl.closest('.stat-card'); if(targetCard && targetCard !== dragged && dashGrid.contains(targetCard)) { const rect = targetCard.getBoundingClientRect(); const next = (touch.clientX - rect.left) / rect.width > 0.5; dashGrid.insertBefore(dragged, next ? targetCard.nextSibling : targetCard); } } } else { clearTimeout(touchTimer); } }, {passive: false});
                    const endTouch = () => { clearTimeout(touchTimer); if(dragged && this.isDragging) { dragged.style.opacity = '1'; dragged.style.transform = 'none'; dragged.style.pointerEvents = 'auto'; const newOrder = Array.from(dashGrid.querySelectorAll('.stat-card')).map(c => c.dataset.id); this.data.settings.dashOrder = newOrder; this.saveToStorage(); setTimeout(() => this.isDragging = false, 100); dragged = null; } };
                    dashGrid.addEventListener('touchend', endTouch); dashGrid.addEventListener('touchcancel', endTouch);
                }

                this.renderDashboard();
                this.updateGreeting();
                document.addEventListener('click', (e) => { if (!e.target.closest('.badge') && !e.target.closest('.status-dropdown')) { document.getElementById('status-menu').classList.remove('show'); } });
            },

            changeSort(view, criteria) {
                this.sortState[view] = criteria;
                if (view === 'cases') this.renderCases();
                if (view === 'updates') this.renderUpdatesFull();
                if (view === 'clients') this.renderClients();
                if (view === 'deadlines') this.renderDeadlines();
                if (view === 'tasks') this.renderTasks();
                if (view === 'finance') this.renderFinance();
            },

            updateGreeting() {
                const name = this.data.settings.userName || 'Doutor(a)';
                const greetingEl = document.getElementById('dash-greeting');
                if(greetingEl) greetingEl.innerText = `Ol√°, ${name}`;
                const avatarEl = document.getElementById('topbar-avatar');
                if(avatarEl) { if (this.data.settings.profilePic) { avatarEl.style.backgroundImage = `url(${this.data.settings.profilePic})`; avatarEl.style.backgroundSize = 'cover'; avatarEl.style.backgroundPosition = 'center'; avatarEl.innerText = ''; } else { avatarEl.style.backgroundImage = 'var(--primary-gradient)'; let initials = name.substring(0,2).toUpperCase(); if(name.includes(' ') && name.split(' ').length > 1) { const parts = name.split(' '); initials = (parts[0][0] + parts[1][0]).toUpperCase(); } avatarEl.innerText = initials; } }
                const inputEl = document.getElementById('settings-user-name');
                if(inputEl) inputEl.value = name === 'Doutor(a)' ? '' : name;
            },

            saveUserName() { const input = document.getElementById('settings-user-name').value.trim(); this.data.settings.userName = input || 'Doutor(a)'; this.saveToStorage(); this.updateGreeting(); alert('Nome de perfil salvo com sucesso!'); },
            saveProfilePic(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { this.data.settings.profilePic = event.target.result; this.saveToStorage(); this.updateGreeting(); }; reader.readAsDataURL(file); },
            removeProfilePic() { this.data.settings.profilePic = null; document.getElementById('settings-profile-pic').value = ''; this.saveToStorage(); this.updateGreeting(); },

            // FUN√á√ÉO CORRIGIDA PARA REMOVER O CABE√áALHO DUPLICADO COMPLETAMENTE
            cleanBlockText(text, keywordFilter) {
                if(!text) return '-';
                let lines = text.split('\n');
                // Remove linhas em branco do come√ßo
                while(lines.length > 0 && lines[0].trim() === '') lines.shift();
                
                if(lines.length > 0) {
                    const firstLine = lines[0].trim();
                    // Regex cobre todas as varia√ß√µes e sin√¥nimos dos t√≠tulos que a IA pode devolver
                    const regexHeaders = /^(?:\dÔ∏è‚É£|\d\.)?\s*(Identifica√ß|Diagn√≥stico|Partes|An√°lise|Natureza|Postura|Resumo|Determina√ß|Recursos|Pedidos|Simula√ß|Prazo|Mapa|Pr√≥ximo)/i;
                    
                    if (regexHeaders.test(firstLine)) {
                        let parts = firstLine.split(':');
                        // Se a IA gerou o t√≠tulo na mesma linha da primeira resposta (ex: "9Ô∏è‚É£ Resumo: O caso foi bom")
                        if (parts.length > 1 && parts.slice(1).join(':').trim() !== '') {
                            lines[0] = parts.slice(1).join(':').trim();
                        } else {
                            // Se for s√≥ o t√≠tulo (ex: "2Ô∏è‚É£ An√°lise Estrat√©gica das Partes"), apaga a linha inteira.
                            lines.shift();
                        }
                    }
                }
                return lines.join('\n').trim();
            },

            analyzeWithAI(platform) {
                const textToAnalyze = document.getElementById('import-text').value;
                if (!textToAnalyze || !textToAnalyze.trim()) { alert('‚ö†Ô∏è Cole o texto da publica√ß√£o no Passo 1 primeiro.'); return; }
                
                const roleFromImport = document.getElementById('import-client-role').value;
                
                let specificClientInstruction = "Se meu cliente √© o R√âU/RECLAMADO ou AUTOR/RECLAMANTE";
                if(roleFromImport === 'autor') specificClientInstruction = "Meu cliente √© o AUTOR/RECLAMANTE";
                if(roleFromImport === 'reu') specificClientInstruction = "Meu cliente √© o R√âU/RECLAMADO";
                
                const geminiPrompt = `Analise a publica√ß√£o judicial abaixo e extraia as informa√ß√µes de forma ESTRUTURADA, EXTREMAMENTE CONCISA e DIRETA.

üö® ATEN√á√ÉO: ${specificClientInstruction}. Indique claramente se a decis√£o foi POSITIVA ou NEGATIVA para ele no Resumo (Bloco 9).

üö® ATEN√á√ÉO ESPECIAL AOS PRAZOS:
Calcule o prazo processual de forma EXATA conforme a legisla√ß√£o vigente aplic√°vel ao caso (CPC, CPP, CLT ou lei espec√≠fica).
A contagem deve:
	‚Ä¢	Considerar dias √∫teis quando a lei assim determinar.
	‚Ä¢	Excluir o dia do come√ßo e incluir o do vencimento.
	‚Ä¢	Considerar a data de disponibiliza√ß√£o e a data de publica√ß√£o quando aplic√°vel.
	‚Ä¢	Indicar corretamente o termo inicial.
	‚Ä¢	Desconsiderar feriados apenas se houver informa√ß√£o expressa.
	‚Ä¢	Indicar a DATA FINAL EXATA (prazo fatal). No formato DD/MM/AAAA.
Exemplo: Se a publica√ß√£o ocorreu em 19/02, informe exatamente qual √© o √∫ltimo dia para recurso segundo a lei vigente aplic√°vel ao caso.

‚ö†Ô∏è REGRAS DE FORMATA√á√ÉO OBRIGAT√ìRIAS:
	‚Ä¢	N√ÉO USE formata√ß√£o Markdown (PROIBIDO usar asteriscos **, PROIBIDO usar bullet points como * ou -).
	‚Ä¢	Use APENAS texto puro.
	‚Ä¢	Siga rigorosamente os emojis de 1Ô∏è‚É£ a 9Ô∏è‚É£ para separa√ß√£o dos blocos.
	‚Ä¢	Responda exatamente no formato ‚ÄúCampo: Resposta curta‚Äù em linhas separadas.

1Ô∏è‚É£ Identifica√ß√£o do Processo
N√∫mero:
√ìrg√£o:
Tribunal:
Tipo de Justi√ßa:
Comunica√ß√£o:
Data de disponibiliza√ß√£o:
Data de publica√ß√£o:
In√≠cio do prazo:
Fundamento legal da contagem:

2Ô∏è‚É£ Partes do Processo
Autor:
R√©u:
Advogados:
Intimado:

3Ô∏è‚É£ Natureza do Ato Judicial
Classifica√ß√£o:
Explica√ß√£o:

4Ô∏è‚É£ Resumo Objetivo do Conte√∫do
Resumo:

5Ô∏è‚É£ Determina√ß√µes do Juiz
Determina√ß√£o:
Quem deve cumprir:
Prazo expresso:
Fundamento legal do prazo:

6Ô∏è‚É£ Pedidos e Recursos Envolvidos
Recurso/Pedido cab√≠vel:
Prazo legal do recurso:
Fundamento legal:
Tipo de contagem:
Termo inicial:
Termo final exato:

7Ô∏è‚É£ Prazo Fatal do Pr√≥ximo Passo
Ato a ser praticado:
Respons√°vel:
Prazo legal:
Data inicial da contagem:
Data final exata:
Base legal aplicada:
Forma de contagem:
Risco:

8Ô∏è‚É£ Pr√≥ximo Cen√°rio Processual
Cen√°rio:

9Ô∏è‚É£ Resumo Para o Cliente
Resumo: Indicar expressamente se a decis√£o foi POSITIVA ou NEGATIVA para o meu cliente e informar a DATA FATAL exata do pr√≥ximo prazo.

Segue a publica√ß√£o para an√°lise:
${textToAnalyze}`;

                navigator.clipboard.writeText(geminiPrompt).then(() => { 
                    alert(`‚úÖ Prompt copiado com sucesso!\n\nEstou abrindo o ${platform === 'gemini' ? 'Gemini' : 'ChatGPT'}. Cole o texto l√° (Ctrl+V), aguarde a resposta e copie o resultado de volta para o Passo 2.`); 
                    
                    if(platform === 'gemini') {
                        window.open('https://gemini.google.com/app', '_blank'); 
                    } else {
                        window.open('https://chatgpt.com', '_blank'); 
                    }
                }).catch(err => { 
                    console.error('Falha ao copiar:', err); 
                    alert('Seu navegador bloqueou a c√≥pia autom√°tica. Verifique as permiss√µes.'); 
                });
            },

            openFullAnalysisModal() {
                this.editAnalysisId = null;
                const sel = document.getElementById('full-analysis-case-select');
                sel.innerHTML = '<option value="">-- Selecione ou use texto avulso --</option>';
                this.data.cases.forEach(c => {
                    sel.add(new Option(`${c.client} - ${c.number}`, c.id));
                });
                
                document.getElementById('full-analysis-text').value = '';
                document.getElementById('full-analysis-result').value = '';
                document.getElementById('full-analysis-step-1').style.display = 'block';
                document.getElementById('modal-full-analysis').classList.add('active');
            },

            loadCaseContext() {
                const cid = document.getElementById('full-analysis-case-select').value;
                const txtArea = document.getElementById('full-analysis-text');
                if (!cid) { txtArea.value = ''; return; }
                
                const updates = this.data.updates.filter(u => u.caseId == cid);
                updates.sort((a,b) => new Date(a.date) - new Date(b.date)); 
                
                let context = `--- HIST√ìRICO DO PROCESSO ---\n`;
                if(updates.length === 0) {
                    context += "Nenhuma publica√ß√£o cadastrada neste processo.\n";
                } else {
                    updates.forEach(u => {
                        const a = u.analysis || {};
                        const b = a.blocks || {};
                        const fullStrat = `1Ô∏è‚É£ ${b.b1||''}\n2Ô∏è‚É£ ${b.b2||''}\n3Ô∏è‚É£ ${b.b3||''}\n4Ô∏è‚É£ ${b.b4||''}\n5Ô∏è‚É£ ${b.b5||''}\n6Ô∏è‚É£ ${b.b6||''}\n7Ô∏è‚É£ ${b.b7||''}\n8Ô∏è‚É£ ${b.b8||''}\n9Ô∏è‚É£ ${b.b9||''}`;
                        
                        context += `\n[DATA: ${new Date(u.date).toLocaleDateString()}] - TIPO: ${a.type}\n`;
                        context += `AN√ÅLISE ANTERIOR:\n${fullStrat}\n`;
                        context += `-----------------------------------\n`;
                    });
                }
                txtArea.value = context;
            },

            analyzeFullCase(platform) {
                const textToAnalyze = document.getElementById('full-analysis-text').value;
                const role = document.getElementById('full-analysis-role').value;
                
                let specificClientInstruction = "Se meu cliente √© AUTOR ou R√âU";
                if(role === 'autor') specificClientInstruction = "Meu cliente √© o AUTOR/RECLAMANTE";
                if(role === 'reu') specificClientInstruction = "Meu cliente √© o R√âU/RECLAMADO";

                const strategicPrompt = `Analise o processo judicial completo contido no texto ou PDF anexado e extraia as informa√ß√µes de forma ESTRUTURADA, EXTREMAMENTE CONCISA, T√âCNICA e ESTRAT√âGICA.

Sou aluno do 5¬∫ semestre de Direito e quero utilizar esta an√°lise para auxiliar minha advogada e desenvolver racioc√≠nio estrat√©gico profissional.

üö® ATEN√á√ÉO: ${specificClientInstruction}. Indique claramente se o cen√°rio processual atual √© FAVOR√ÅVEL, DESFAVOR√ÅVEL ou DE RISCO no Bloco 9.

üö® ATEN√á√ÉO ESPECIAL AOS PRAZOS:
Calcule o prazo processual de forma EXATA conforme a legisla√ß√£o aplic√°vel (CPC, CPP, CLT ou lei espec√≠fica).
A contagem deve:
‚Ä¢ Considerar dias √∫teis quando a lei determinar.
‚Ä¢ Excluir o dia do come√ßo e incluir o do vencimento.
‚Ä¢ Considerar data de intima√ß√£o, disponibiliza√ß√£o e publica√ß√£o quando aplic√°vel.
‚Ä¢ Indicar corretamente o termo inicial.
‚Ä¢ Desconsiderar feriados apenas se houver informa√ß√£o expressa.
‚Ä¢ Indicar a DATA FINAL EXATA (prazo fatal).
Se n√£o houver elemento suficiente para c√°lculo exato, indique EXPRESSAMENTE a limita√ß√£o.
Data de hoje: ${new Date().toLocaleDateString('pt-BR')}

‚ö†Ô∏è REGRAS DE FORMATA√á√ÉO OBRIGAT√ìRIAS:
‚Ä¢ N√ÉO USE formata√ß√£o Markdown.
‚Ä¢ N√ÉO USE asteriscos.
‚Ä¢ N√ÉO USE bullet points.
‚Ä¢ Use APENAS texto puro.
‚Ä¢ Siga rigorosamente os emojis de 1Ô∏è‚É£ a 9Ô∏è‚É£ para separa√ß√£o dos blocos.
‚Ä¢ Responda exatamente no formato ‚ÄúCampo: Resposta objetiva‚Äù em linhas separadas.
‚Ä¢ Linguagem t√©cnica, direta e estrat√©gica.
‚Ä¢ Evite explica√ß√µes longas. Priorize precis√£o.

1Ô∏è‚É£ Diagn√≥stico Geral do Caso
Conflito central:
Tese do autor:
Tese da defesa:
Fase processual atual:
Parte em posi√ß√£o mais favor√°vel:
Principais riscos processuais:
Impacto financeiro estimado:
Probabilidade estrat√©gica de √™xito:

2Ô∏è‚É£ An√°lise Estrat√©gica das Partes
Estrat√©gia do autor:
Erro estrat√©gico do autor:
Estrat√©gia da defesa:
Erro estrat√©gico da defesa:
√înus da prova bem trabalhado:
Provas fr√°geis:
Preliminares n√£o exploradas:
Oportunidade estrat√©gica n√£o utilizada:

3Ô∏è‚É£ An√°lise da Postura do Juiz
Fundamenta√ß√£o adequada:
H√° omiss√£o relevante:
H√° contradi√ß√£o:
H√° obscuridade:
Risco de nulidade:
Tend√™ncia decis√≥ria identific√°vel:
Probabilidade de reforma em recurso:

4Ô∏è‚É£ An√°lise T√©cnica Processual Profunda
Natureza jur√≠dica da a√ß√£o:
Compet√™ncia adequada:
Pressupostos processuais:
Condi√ß√µes da a√ß√£o:
Preclus√µes ocorridas:
Nulidades argu√≠veis:
Regularidade procedimental:
Momento processual:
Pr√≥ximo ato esperado:

5Ô∏è‚É£ Recursos e Medidas Cab√≠veis
Recurso cab√≠vel:
Prazo legal:
Fundamento legal:
Tipo de contagem:
Termo inicial:
Termo final exato:
Outra medida estrat√©gica poss√≠vel:
Viabilidade recursal:

6Ô∏è‚É£ Simula√ß√£o Estrat√©gica de Recurso
Tese recursal principal:
Fundamento jur√≠dico central:
Argumento mais forte:
Tese subsidi√°ria:
Pedido recursal estrat√©gico:
Chance estimada de √™xito:

7Ô∏è‚É£ Mapa de Oportunidades Estrat√©gicas
Possibilidade de acordo:
Risco de sucumb√™ncia:
Risco de majora√ß√£o de honor√°rios:
Tese alternativa vi√°vel:
Prova que pode mudar o cen√°rio:
Medida preventiva recomendada:

8Ô∏è‚É£ Pr√≥ximo Cen√°rio Processual
Cen√°rio prov√°vel:
Cen√°rio de risco:
Movimento estrat√©gico recomendado:
Prioridade imediata:

9Ô∏è‚É£ Resumo Estrat√©gico para Auxiliar Minha Advogada
Posi√ß√£o atual do cliente:
Situa√ß√£o: Indicar expressamente se √© FAVOR√ÅVEL, DESFAVOR√ÅVEL ou DE RISCO.
Ponto cr√≠tico do processo:
Data fatal do pr√≥ximo prazo:
A√ß√£o estrat√©gica recomendada:
N√≠vel de urg√™ncia:

${textToAnalyze ? '\nSegue texto do processo:\n' + textToAnalyze : ''}`;

                navigator.clipboard.writeText(strategicPrompt).then(() => { 
                    alert(`‚úÖ Prompt de An√°lise Estrat√©gica copiado!\n\nCole no ${platform === 'gemini' ? 'Gemini' : 'ChatGPT'} e anexe o PDF do processo.`); 
                    if(platform === 'gemini') { window.open('https://gemini.google.com/app', '_blank'); } else { window.open('https://chatgpt.com', '_blank'); }
                }).catch(err => alert('Erro ao copiar prompt. Verifique permiss√µes.'));
            },

            saveFullAnalysis() {
                const analysisText = document.getElementById('full-analysis-result').value;
                if(!analysisText.trim()) return alert("Cole o resultado da an√°lise antes de salvar.");

                let linkedCaseId = document.getElementById('full-analysis-case-select').value;
                
                if (!linkedCaseId && !this.editAnalysisId) {
                    const caseMatch = analysisText.match(/\d{7}-\d{2}\.\d{4}\.\d\.\d{2}\.\d{4}/);
                    const caseNum = caseMatch ? caseMatch[0] : null;
                    if (caseNum) {
                        const found = this.data.cases.find(c => c.number === caseNum);
                        if (found) linkedCaseId = found.id;
                    }
                } else if(linkedCaseId) {
                    linkedCaseId = parseInt(linkedCaseId);
                }

                if (linkedCaseId || this.editAnalysisId) {
                    
                    if(this.editAnalysisId) {
                        for(let c of this.data.cases) {
                            if(c.full_analyses) {
                                let fIndex = c.full_analyses.findIndex(fa => fa.id === this.editAnalysisId);
                                if(fIndex > -1) {
                                    c.full_analyses[fIndex].text = analysisText;
                                    linkedCaseId = c.id;
                                    break;
                                }
                            }
                        }
                    } else {
                        const cIndex = this.data.cases.findIndex(c => c.id === linkedCaseId);
                        if (!this.data.cases[cIndex].full_analyses) this.data.cases[cIndex].full_analyses = [];
                        
                        this.data.cases[cIndex].full_analyses.push({
                            id: Date.now(),
                            date: new Date().toISOString(),
                            text: analysisText,
                            type: 'strategic_analysis'
                        });
                    }
                    
                    this.saveToStorage();
                    alert(`An√°lise salva e vinculada ao processo!`);
                    this.closeModal('modal-full-analysis');
                    this.editAnalysisId = null;
                    this.renderAnalyses(); 
                    
                    if(!document.getElementById('view-case-detail').classList.contains('hidden')) {
                        this.openCaseDetail(linkedCaseId);
                    }
                } else {
                    alert('N√£o consegui vincular a um processo. Selecione o processo na lista antes de salvar ou certifique-se que o n√∫mero CNJ consta no texto.');
                }
            },

            openEditStrategicAnalysis(caseId, analysisId) {
                const c = this.data.cases.find(x => x.id === caseId);
                const item = c.full_analyses.find(a => a.id === analysisId);
                if(!item) return;
                
                this.editAnalysisId = analysisId;
                document.getElementById('full-analysis-step-1').style.display = 'none'; 
                document.getElementById('full-analysis-result').value = item.text;
                
                this.closeModal('modal-publication-view'); 
                document.getElementById('modal-full-analysis').classList.add('active');
            },

            toggleStratBlock(el) {
                el.classList.toggle('collapsed');
                el.nextElementSibling.classList.toggle('collapsed');
            },

            viewStrategicAnalysis(caseId, analysisId) {
                const c = this.data.cases.find(x => x.id === caseId);
                const item = c.full_analyses.find(a => a.id === analysisId);
                if (!item) return;

                const extract = (text, current, next) => { 
                    let regexStr = current + "([\\s\\S]*?)"; 
                    regexStr += next ? "(?=" + next + "|$)" : "(?=$)"; 
                    const match = text.match(new RegExp(regexStr)); 
                    if(match) return match[1].trim(); 
                    return ''; 
                };

                const blocks = {
                    b1: extract(item.text, '1Ô∏è‚É£', '2Ô∏è‚É£'),
                    b2: extract(item.text, '2Ô∏è‚É£', '3Ô∏è‚É£'),
                    b3: extract(item.text, '3Ô∏è‚É£', '4Ô∏è‚É£'),
                    b4: extract(item.text, '4Ô∏è‚É£', '5Ô∏è‚É£'),
                    b5: extract(item.text, '5Ô∏è‚É£', '6Ô∏è‚É£'),
                    b6: extract(item.text, '6Ô∏è‚É£', '7Ô∏è‚É£'),
                    b7: extract(item.text, '7Ô∏è‚É£', '8Ô∏è‚É£'),
                    b8: extract(item.text, '8Ô∏è‚É£', '9Ô∏è‚É£'),
                    b9: extract(item.text, '9Ô∏è‚É£', null)
                };

                const titles = {
                    b1: "1Ô∏è‚É£ Diagn√≥stico Geral", b2: "2Ô∏è‚É£ An√°lise das Partes", b3: "3Ô∏è‚É£ Postura do Juiz",
                    b4: "4Ô∏è‚É£ An√°lise T√©cnica", b5: "5Ô∏è‚É£ Recursos Cab√≠veis", b6: "6Ô∏è‚É£ Simula√ß√£o de Recurso",
                    b7: "7Ô∏è‚É£ Oportunidades", b8: "8Ô∏è‚É£ Pr√≥ximo Cen√°rio", b9: "9Ô∏è‚É£ Resumo para Advogada"
                };

                // FUN√á√ÉO REVISADA QUE SEPARA A PERGUNTA (AZUL) DA RESPOSTA (PRETA)
                const formatContent = (text, key) => {
                    if (!text) return '<span style="color:var(--text-muted)">Sem dados.</span>';
                    text = this.cleanBlockText(text, titles[key].substring(4));
                    
                    let formatted = '';
                    let lines = text.split('\n');
                    for(let l of lines) {
                        let match = l.match(/^([^:]+):(.*)/);
                        if(match) {
                            if(formatted !== '') formatted += '</span></div>';
                            formatted += `<div class="strat-row"><span class="strat-label">${match[1]}:</span><span class="strat-value">${match[2]}`;
                        } else {
                            if(formatted !== '') formatted += '<br>' + l;
                            else formatted += l;
                        }
                    }
                    if(formatted !== '') formatted += '</span></div>';
                    return formatted || text;
                };

                let html = '<div style="display:flex; flex-direction:column; gap:10px;">';
                for (let i = 1; i <= 9; i++) {
                    let key = 'b' + i;
                    html += `<div class="strat-block-container" style="padding:10px 16px;">
                                <div class="strat-header" onclick="app.toggleStratBlock(this)">${titles[key]}</div>
                                <div class="strat-content">${formatContent(blocks[key], key)}</div>
                             </div>`;
                }
                html += '</div>';

                document.getElementById('pub-view-summary').innerHTML = html;
                document.getElementById('pub-view-text').innerText = item.text; 
                
                const extraActions = document.getElementById('pub-view-extra-actions');
                extraActions.innerHTML = `<button class="btn btn-outline" onclick="app.openEditStrategicAnalysis(${c.id}, ${item.id})">‚úèÔ∏è Editar An√°lise</button>`;
                
                document.getElementById('pub-view-action-btn').style.display = 'none'; 
                document.getElementById('modal-publication-view').classList.add('active');
            },

            parseAIResult() {
                const aiResult = document.getElementById('ai-result-text').value;
                const rawImport = document.getElementById('import-text').value;
                if(!aiResult.trim()) return alert("Cole o resultado gerado pela IA na caixa do Passo 2.");
                const extract = (current, next) => { let regexStr = current + "([\\s\\S]*?)"; regexStr += next ? "(?=" + next + "|$)" : "(?=$)"; const match = aiResult.match(new RegExp(regexStr)); if(match) { let block = match[1].trim(); block = block.replace(/^[^\n]*\n/, '').replace(/\*\*/g, '').replace(/^\s*[\*\-]\s/gm, '').trim(); return block; } return '-'; };
                const b1 = extract('1Ô∏è‚É£', '2Ô∏è‚É£'); const b2 = extract('2Ô∏è‚É£', '3Ô∏è‚É£'); const b3 = extract('3Ô∏è‚É£', '4Ô∏è‚É£'); const b4 = extract('4Ô∏è‚É£', '5Ô∏è‚É£'); const b5 = extract('5Ô∏è‚É£', '6Ô∏è‚É£'); const b6 = extract('6Ô∏è‚É£', '7Ô∏è‚É£'); const b7 = extract('7Ô∏è‚É£', '8Ô∏è‚É£'); const b8 = extract('8Ô∏è‚É£', '9Ô∏è‚É£'); const b9 = extract('9Ô∏è‚É£', '‚öñÔ∏è');
                const caseMatch = (b1 + rawImport).match(/\d{7}-\d{2}\.\d{4}\.\d\.\d{2}\.\d{4}/);
                const caseNum = caseMatch ? caseMatch[0] : '';
                const autorMatch = b2.match(/Autor:\s*([^\n]+)/i); const reuMatch = b2.match(/R√©u:\s*([^\n]+)/i);
                const extractedAutor = autorMatch ? autorMatch[1].trim() : ''; const extractedReu = reuMatch ? reuMatch[1].trim() : '';
                const dateMatch = b1.match(/Data de disponibiliza√ß√£o:\s*(\d{2})\/(\d{2})\/(\d{4})/i);
                let dispDate = null; if(dateMatch) { dispDate = new Date(`${dateMatch[3]}-${dateMatch[2]}-${dateMatch[1]}T12:00:00`).toISOString(); }
                let matchedId = null; if(caseNum) { const found = this.data.cases.find(c => c.number === caseNum); if(found) matchedId = found.id; }
                const roleFromImport = document.getElementById('import-client-role').value;
                this.tempParsedData = { rawText: rawImport, caseNumber: caseNum, matchedCaseId: matchedId, extractedAutor: extractedAutor, extractedReu: extractedReu, dispDate: dispDate, type: b3.split('\n')[0].replace('Classifica√ß√£o:', '').trim().substring(0, 40) || 'Ato Judicial', outcome: "Movimenta√ß√£o", blocks: { b1, b2, b3, b4, b5, b6, b7, b8, b9 }, importRole: roleFromImport };
                const matchDiv = document.getElementById('match-info');
                if(matchedId) { matchDiv.innerHTML = `Processo identificado automaticamente na base: <b style="color:var(--text-main)">${caseNum}</b>. Ser√° vinculado ao dossi√™.`; } else if(caseNum) { matchDiv.innerHTML = `Processo <b style="color:var(--text-main)">${caseNum}</b> n√£o encontrado na base. Um novo caso ser√° criado com Autor(a): <b style="color:var(--text-main)">${extractedAutor || 'Desconhecido'}</b> e R√©u: <b style="color:var(--text-main)">${extractedReu || 'Desconhecido'}</b>.`; } else { matchDiv.innerHTML = `Processo n√£o identificado. Ficar√° registrado como an√°lise avulsa.`; }
                document.getElementById('step-1-import').style.display = 'none'; document.getElementById('step-2-import').style.display = 'block';
            },

            saveParsedImport() {
                if(!this.tempParsedData) return;
                let cid = this.tempParsedData.matchedCaseId;
                if(!cid && this.tempParsedData.caseNumber) {
                    let defClient = this.tempParsedData.extractedAutor || "Cliente N√£o Identificado";
                    let defOpponent = this.tempParsedData.extractedReu || "-";
                    if (this.tempParsedData.importRole === 'reu') { defClient = this.tempParsedData.extractedReu || "Cliente N√£o Identificado"; defOpponent = this.tempParsedData.extractedAutor || "-"; }
                    const newCase = { id: Date.now(), number: this.tempParsedData.caseNumber, client: defClient, client_role: this.tempParsedData.importRole === 'desconhecido' ? 'autor' : this.tempParsedData.importRole, opponent: defOpponent, area: 'C√≠vel', status: 'Em andamento', date_created: new Date().toISOString() };
                    this.data.cases.push(newCase); cid = newCase.id;
                }
                const isEditId = document.getElementById('import-id').value;
                const updatePayload = { id: isEditId ? parseInt(isEditId) : Date.now(), date: this.tempParsedData.dispDate || new Date().toISOString(), rawText: this.tempParsedData.rawText, caseId: cid, analysis: { caseNumber: this.tempParsedData.caseNumber, type: this.tempParsedData.type, outcome: this.tempParsedData.outcome, blocks: this.tempParsedData.blocks } };
                if(isEditId) { const idx = this.data.updates.findIndex(u => u.id == isEditId); if(idx > -1) { updatePayload.date = this.tempParsedData.dispDate || this.data.updates[idx].date; this.data.updates[idx] = updatePayload; } } else { this.data.updates.unshift(updatePayload); }
                
                let extractedDeadline = '';
                const dateRegex = /(\d{2})\/(\d{2})\/(\d{4})/;
                if(this.tempParsedData.blocks.b7) {
                    let m = this.tempParsedData.blocks.b7.match(/Data final exata:\s*(\d{2}\/\d{2}\/\d{4})/i);
                    if(!m) m = this.tempParsedData.blocks.b7.match(dateRegex);
                    if(m) extractedDeadline = `${m[3]}-${m[2]}-${m[1]}`; 
                }
                
                this.saveToStorage(); document.getElementById('import-text').value = ''; document.getElementById('ai-result-text').value = ''; document.getElementById('import-id').value = ''; document.getElementById('import-client-role').value = 'desconhecido'; this.tempParsedData = null; this.closeModal('modal-import'); this.navigate('updates'); this.backToStep1();
                
                if(confirm('Deseja agendar um Prazo relacionado a esta publica√ß√£o agora mesmo?')) { 
                    this.openModal('modal-deadline', cid, extractedDeadline); 
                }
            },

            backToStep1() { document.getElementById('step-1-import').style.display = 'block'; document.getElementById('step-2-import').style.display = 'none'; },

            getOutcomeColor(text, clientRole) { text = (text || '').toLowerCase(); let isPositive = null; if (text.includes('positivo')) return 'style="background:var(--success); color:white;" class="summary-tag"'; if (text.includes('negativo')) return 'style="background:var(--danger); color:white;" class="summary-tag"'; if (/deferi|procedent|provid|acolhid/i.test(text)) isPositive = true; else if (/indeferi|improcedent|improvid|rejeitad/i.test(text)) isPositive = false; if (isPositive === null) return 'class="summary-tag tag-blue"'; let goodForClient = clientRole === 'reu' ? !isPositive : isPositive; return goodForClient ? 'style="background:var(--success); color:white;" class="summary-tag"' : 'style="background:var(--danger); color:white;" class="summary-tag"'; },

            viewPublication(id) {
                const pub = this.data.updates.find(u => u.id === id); if(!pub) return; const b = pub.analysis.blocks || {}; 
                
                // FUN√á√ÉO REVISADA PARA APLICAR A COR AZUL/PRETO IGUAL √Ä VIS√ÉO ESTRAT√âGICA
                const formatBlock = (text, keyName) => { 
                    if(!text) return '-'; 
                    text = this.cleanBlockText(text, keyName);
                    
                    let formatted = '';
                    let lines = text.split('\n');
                    for(let l of lines) {
                        let match = l.match(/^([^:]+):(.*)/);
                        if(match) {
                            if(formatted !== '') formatted += '</span></div>';
                            formatted += `<div class="strat-row"><span class="strat-label">${match[1]}:</span><span class="strat-value">${match[2]}`;
                        } else {
                            if(formatted !== '') formatted += '<br>' + l;
                            else formatted += l;
                        }
                    }
                    if(formatted !== '') formatted += '</span></div>';
                    return formatted || text;
                };
                
                const summaryHtml = `
                    <div style="display:flex; flex-direction:column; gap:15px;">
                        <div class="analysis-grid">
                            <div class="analysis-item"><span class="analysis-label">1Ô∏è‚É£ Identifica√ß√£o</span><div class="analysis-val">${formatBlock(b.b1, "Identifica√ß√£o")}</div></div>
                            <div class="analysis-item"><span class="analysis-label">2Ô∏è‚É£ Partes</span><div class="analysis-val">${formatBlock(b.b2, "Partes")}</div></div>
                            <div class="analysis-item"><span class="analysis-label">3Ô∏è‚É£ Natureza</span><div class="analysis-val">${formatBlock(b.b3, "Natureza")}</div></div>
                            <div class="analysis-item"><span class="analysis-label">4Ô∏è‚É£ Resumo</span><div class="analysis-val">${formatBlock(b.b4, "Resumo")}</div></div>
                        </div>
                        
                        <div class="strat-block-container" style="padding:10px 15px; margin-bottom:0;">
                            <div class="strat-header" onclick="app.toggleStratBlock(this)"><span class="analysis-label" style="margin:0;">5Ô∏è‚É£ Determina√ß√µes do Juiz</span></div>
                            <div class="strat-content"><div>${formatBlock(b.b5, "Determina√ß√µes")}</div></div>
                        </div>
                        
                        <div class="strat-block-container" style="padding:10px 15px; margin-bottom:0;">
                            <div class="strat-header" onclick="app.toggleStratBlock(this)"><span class="analysis-label" style="margin:0;">6Ô∏è‚É£ Pedidos e Recursos</span></div>
                            <div class="strat-content"><div>${formatBlock(b.b6, "Pedidos e Recursos")}</div></div>
                        </div>
                        
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                            <div class="strat-block-container" style="padding:10px 15px; margin-bottom:0; border-top: 4px solid var(--danger);">
                                <div class="strat-header" onclick="app.toggleStratBlock(this)"><span class="analysis-label" style="color:var(--danger); margin:0;">7Ô∏è‚É£ Prazo Fatal</span></div>
                                <div class="strat-content"><div>${formatBlock(b.b7, "Prazo Fatal")}</div></div>
                            </div>
                            <div class="strat-block-container" style="padding:10px 15px; margin-bottom:0; border-top: 4px solid var(--info);">
                                <div class="strat-header" onclick="app.toggleStratBlock(this)"><span class="analysis-label" style="margin:0;">8Ô∏è‚É£ Pr√≥ximo Cen√°rio</span></div>
                                <div class="strat-content"><div>${formatBlock(b.b8, "Pr√≥ximo Cen√°rio")}</div></div>
                            </div>
                        </div>
                        
                        <div class="client-summary-box"><b>9Ô∏è‚É£ Resumo para o Cliente (Copie e envie no WhatsApp):</b><br><br><span style="white-space:pre-wrap; font-style: normal; font-size:1rem; color:var(--text-main);">${(b.b9 || '').replace(/^Resumo:/i, '').trim() || '-'}</span></div>
                    </div>`;
                    
                document.getElementById('pub-view-summary').innerHTML = summaryHtml; 
                document.getElementById('pub-view-text').innerText = pub.rawText || 'Texto original n√£o salvo.'; 
                
                document.getElementById('pub-view-extra-actions').innerHTML = ''; 
                document.getElementById('pub-view-action-btn').style.display = 'block'; 
                
                const btn = document.getElementById('pub-view-action-btn'); 
                btn.onclick = () => { 
                    this.closeModal('modal-publication-view'); 
                    let extractedDeadline = '';
                    if(b.b7) {
                        let m = b.b7.match(/Data final exata:\s*(\d{2}\/\d{2}\/\d{4})/i);
                        if(!m) m = b.b7.match(/(\d{2})\/(\d{2})\/(\d{4})/);
                        if(m) extractedDeadline = `${m[3]}-${m[2]}-${m[1]}`;
                    }
                    this.openModal('modal-deadline', pub.caseId, extractedDeadline); 
                }; 
                document.getElementById('modal-publication-view').classList.add('active');
            },

            editUpdate(id) { const u = this.data.updates.find(x => x.id === id); if(!u) return; document.getElementById('import-id').value = u.id; document.getElementById('import-text').value = u.rawText; const b = u.analysis.blocks; const rebuilt = `1Ô∏è‚É£\n${b.b1}\n2Ô∏è‚É£\n${b.b2}\n3Ô∏è‚É£\n${b.b3}\n4Ô∏è‚É£\n${b.b4}\n5Ô∏è‚É£\n${b.b5}\n6Ô∏è‚É£\n${b.b6}\n7Ô∏è‚É£\n${b.b7}\n8Ô∏è‚É£\n${b.b8}\n9Ô∏è‚É£\n${b.b9}`; document.getElementById('ai-result-text').value = rebuilt; document.getElementById('modal-import').classList.add('active'); },
            deleteUpdate(id) { if(confirm('Tem certeza que deseja excluir esta publica√ß√£o do sistema?')) { this.data.updates = this.data.updates.filter(u => u.id !== id); this.saveToStorage(); this.renderUpdatesFull(); } },

            renderUpdatesFull() { 
                const c = document.getElementById('updates-list-full'); c.innerHTML = ''; 
                if(this.data.updates.length === 0) { c.innerHTML = '<p style="color:var(--text-muted)">Nenhuma publica√ß√£o analisada ainda.</p>'; return; }
                let arr = [...this.data.updates];
                const sortBy = this.sortState.updates || 'date';
                if (sortBy === 'name') { arr.sort((a,b) => { let ca = this.data.cases.find(x=>x.id===a.caseId); let cb = this.data.cases.find(x=>x.id===b.caseId); return (ca ? ca.client : 'Z').localeCompare(cb ? cb.client : 'Z'); }); } else { arr.sort((a,b)=>new Date(b.date)-new Date(a.date)); }
                arr.forEach(u => { 
                    const a = u.analysis || {}; const caseRef = this.data.cases.find(caseItem => caseItem.id === u.caseId); const clientRole = caseRef ? (caseRef.client_role || 'autor') : 'autor'; const clientName = caseRef ? caseRef.client : "Cliente N√£o Vinculado";
                    let outcomeColor = this.getOutcomeColor(a.blocks?.b4 || a.outcome, clientRole); let displayLabel = 'Movimenta√ß√£o'; if (outcomeColor.includes('success')) displayLabel = "Positivo"; if (outcomeColor.includes('danger')) displayLabel = "Negativo";
                    c.innerHTML += `<div class="smart-summary" onclick="app.viewPublication(${u.id})"><div class="summary-header"><span style="font-size:1.1rem; font-weight:800; color:var(--text-main);">${a.type || 'Ato Judicial'}</span> <span ${outcomeColor}>${displayLabel}</span></div><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px; font-size:0.9rem;"><div><b style="color:var(--text-secondary)">Processo:</b> ${a.caseNumber || 'N/A'}</div><div><b style="color:var(--text-secondary)">Cliente:</b> <span style="color:var(--primary); font-weight:600;">${clientName}</span></div><div><b style="color:var(--text-secondary)">Publicado em:</b> ${new Date(u.date).toLocaleDateString('pt-BR')}</div></div><div style="background:var(--bg-body); padding:15px; border-radius:var(--radius-md); border-left:4px solid var(--primary); font-size:0.95rem; line-height:1.5;"><b>Resumo T√©cnico:</b><br> ${(a.blocks && a.blocks.b4) ? a.blocks.b4.substring(0, 200) + '...' : 'Sem resumo.'}</div><div style="margin-top:20px; text-align:right; border-top:1px solid var(--border-color); padding-top:15px;"><button class="btn btn-outline btn-sm" onclick="event.stopPropagation(); app.editUpdate(${u.id})">‚úèÔ∏è Editar</button> <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); app.deleteUpdate(${u.id})">üóë Excluir</button></div></div>`; 
                }); 
            },

            renderAnalyses() {
                const cList = document.getElementById('analyses-list-full'); cList.innerHTML = '';
                let analysesArr = [];
                this.data.cases.forEach(c => {
                    if(c.full_analyses && c.full_analyses.length > 0) {
                        c.full_analyses.forEach(fa => {
                            analysesArr.push({ caseData: c, analysis: fa });
                        });
                    }
                });
                
                if(analysesArr.length === 0) { cList.innerHTML = '<p style="color:var(--text-muted)">Nenhum diagn√≥stico estrat√©gico realizado.</p>'; return; }
                
                analysesArr.sort((a,b) => new Date(b.analysis.date) - new Date(a.analysis.date));
                
                analysesArr.forEach(item => {
                    const c = item.caseData;
                    const fa = item.analysis;
                    const b9Match = fa.text.match(/9Ô∏è‚É£([^\n]*(?:\n[^\n]*)*)/);
                    const b9Resumo = b9Match ? b9Match[1].replace(/Resumo Estrat√©gico para Auxiliar Minha Advogada/i, '').trim() : 'Clique para ver a an√°lise completa';
                    
                    cList.innerHTML += `
                        <div class="smart-summary" onclick="app.viewStrategicAnalysis(${c.id}, ${fa.id})">
                            <div class="summary-header">
                                <span style="font-size:1.1rem; font-weight:800; color:var(--text-main);">üß† Diagn√≥stico Processual</span> 
                                <span class="summary-tag" style="background:var(--warning); color:white;">AN√ÅLISE DE AUTOS</span>
                            </div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px; font-size:0.9rem;">
                                <div><b style="color:var(--text-secondary)">Processo:</b> ${c.number || 'N/A'}</div>
                                <div><b style="color:var(--text-secondary)">Cliente:</b> <span style="color:var(--primary); font-weight:600;">${c.client}</span></div>
                                <div><b style="color:var(--text-secondary)">Gerado em:</b> ${new Date(fa.date).toLocaleDateString('pt-BR')}</div>
                            </div>
                            <div style="background:var(--bg-body); padding:15px; border-radius:var(--radius-md); border-left:4px solid var(--warning); font-size:0.95rem; line-height:1.5;">
                                <b>Resumo R√°pido (Cen√°rio):</b><br> ${b9Resumo.substring(0, 150)}...
                            </div>
                        </div>`;
                });
            },

            exportBackup() { const dataStr = JSON.stringify(this.data, null, 2); const blob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `LexManager_Backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); },
            importBackup(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const importedData = JSON.parse(e.target.result); if (importedData && importedData.cases !== undefined) { if (confirm('Aten√ß√£o: Restaurar o backup substituir√° todos os dados atuais na sua tela. Deseja continuar?')) { this.data = importedData; this.saveToStorage(); alert('‚úÖ Backup restaurado com sucesso! A p√°gina ser√° recarregada.'); location.reload(); } } else { alert('‚ùå Arquivo de backup inv√°lido. N√£o parece ser um backup do LexManager.'); } } catch (err) { alert('‚ùå Erro ao ler o arquivo. Certifique-se de que √© um arquivo JSON v√°lido.'); } }; reader.readAsText(file); event.target.value = ''; },

            fixDate(dateStr) { if(!dateStr) return null; return new Date(dateStr + 'T12:00:00'); },
            toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); },
            navigate(view) {
                document.querySelectorAll('main section').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
                const sec = document.getElementById(`view-${view}`); if(sec) sec.classList.remove('hidden');
                const navBtn = document.getElementById(view === 'case-detail' ? 'nav-cases' : `nav-${view}`);
                if(navBtn) navBtn.classList.add('active');
                document.getElementById('sidebar').classList.remove('active');
                if(view === 'dashboard') this.renderDashboard(); 
                if(view === 'updates') this.renderUpdatesFull(); 
                if(view === 'cases') this.renderCases(); 
                if(view === 'deadlines') this.renderDeadlines(); 
                if(view === 'finance') this.renderFinance(); 
                if(view === 'tasks') this.renderTasks(); 
                if(view === 'clients') this.renderClients();
                if(view === 'analyses') this.renderAnalyses();
            },
            
            renderDashboard() {
                const active = this.data.cases.filter(c => c.status === 'Em andamento'); document.getElementById('dash-active').innerText = active.length;
                let totalIncome = 0; let totalExpense = 0; this.data.transactions.forEach(t => { if (t.type === 'income') totalIncome += (parseFloat(t.amount) || 0); if (t.type === 'expense') totalExpense += (parseFloat(t.amount) || 0); }); const netBalance = totalIncome - totalExpense; const balanceEl = document.getElementById('dash-finance-received'); balanceEl.innerText = this.formatCurrency(totalIncome); balanceEl.className = `stat-value text-success`;
                const today = new Date(); today.setHours(0,0,0,0); const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"]; document.getElementById('calendar-month-label').innerText = `${monthNames[today.getMonth()]} ${today.getFullYear()}`;
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1); const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                const grid = document.getElementById('calendar-grid-content'); grid.innerHTML = ''; for(let i=0; i<firstDay.getDay(); i++) grid.innerHTML += `<div></div>`;
                for(let i=1; i<=lastDay.getDate(); i++) { const currentDateStr = new Date(today.getFullYear(), today.getMonth(), i).toDateString(); const deadlinesToday = this.data.deadlines.filter(d => new Date(d.date).toDateString() === currentDateStr && !d.done); const tasksToday = this.data.tasks.filter(t => new Date(t.date).toDateString() === currentDateStr && !t.done); const updatesToday = this.data.updates.filter(u => new Date(u.date).toDateString() === currentDateStr); let dotsHtml = '<div class="calendar-dots">'; deadlinesToday.slice(0,3).forEach(() => dotsHtml += '<div class="calendar-dot dot-deadline"></div>'); tasksToday.slice(0,3).forEach(() => dotsHtml += '<div class="calendar-dot dot-task"></div>'); updatesToday.slice(0,3).forEach(() => dotsHtml += '<div class="calendar-dot dot-publication"></div>'); dotsHtml += '</div>'; grid.innerHTML += `<div class="calendar-day ${i === today.getDate() ? 'today' : ''}" onclick="app.showDayDetails(${i}, ${today.getMonth()}, ${today.getFullYear()})"><span>${i}</span> ${dotsHtml}</div>`; }
                const list = document.getElementById('calendar-list-content'); list.innerHTML = ''; let agendaItems = [];
                this.data.deadlines.filter(d => !d.done && new Date(d.date) >= today).forEach(d => { const c = this.data.cases.find(x => x.id == d.caseId); agendaItems.push({type:'deadline', date:d.date, title:d.type, sub: c ? c.client : 'Sem v√≠nculo', id:d.id}); });
                this.data.tasks.filter(t => !t.done && new Date(t.date) >= today).forEach(t => { const c = this.data.cases.find(x => x.id == t.caseId); agendaItems.push({type:'task', date:t.date, title:t.desc, sub: c ? c.client : 'Geral', id:t.id}); });
                this.data.updates.filter(u => new Date(u.date) >= today).slice(0,5).forEach(u => { const c = this.data.cases.find(x => x.id == u.caseId); agendaItems.push({type:'update', date:u.date, title:u.analysis.type || 'Decis√£o', sub: c ? c.client : 'S/ V√≠nculo', id:u.id}); });
                agendaItems.sort((a,b)=>new Date(a.date)-new Date(b.date));
                if(agendaItems.length === 0) { list.innerHTML = '<div style="padding:20px 10px;text-align:center;color:var(--text-muted)">A agenda est√° livre no momento.</div>'; } else { agendaItems.slice(0,6).forEach(item => { const icon = item.type==='deadline' ? '‚è≥' : (item.type==='task' ? 'üìù' : 'üìú'); const color = item.type==='deadline' ? 'var(--danger)' : (item.type==='task' ? 'var(--info)' : 'var(--warning)'); const clickAction = item.type==='update' ? `app.viewPublication(${item.id})` : `app.navigate('${item.type==='deadline'?'deadlines':'tasks'}')`; list.innerHTML += `<div style="padding:12px; border-radius:var(--radius-md); background:var(--bg-body); margin-bottom:10px; cursor:pointer; transition:0.2s;" onclick="${clickAction}"><div style="font-weight:700; font-size:0.9rem; color:${color}; margin-bottom:4px;">${icon} ${item.title}</div><div style="font-size:0.8rem; color:var(--text-secondary); font-weight:500;">${new Date(item.date).toLocaleDateString('pt-BR').slice(0,5)} ‚Ä¢ ${item.sub}</div></div>`; }); }
                document.getElementById('dash-today').innerText = this.data.deadlines.filter(d => { const dDate = new Date(d.date); return !d.done && dDate.getDate() === today.getDate() && dDate.getMonth() === today.getMonth() && dDate.getFullYear() === today.getFullYear(); }).length;
            },
            
            showDayDetails(day, month, year) {
                const events = []; const targetDateStr = new Date(year, month, day).toDateString();
                this.data.deadlines.forEach(d => { if(new Date(d.date).toDateString() === targetDateStr) { const c = this.data.cases.find(x => x.id == d.caseId); events.push({ type: 'deadline', title: d.type, sub: c ? c.client : 'Sem v√≠nculo', done: d.done, id: d.id }); } });
                this.data.tasks.forEach(t => { if(new Date(t.date).toDateString() === targetDateStr) { const c = this.data.cases.find(x => x.id == t.caseId); events.push({ type: 'task', title: t.desc, sub: c ? c.client : `Tarefa Geral - ${t.priority}`, done: t.done, id: t.id }); } });
                this.data.updates.forEach(u => { if(new Date(u.date).toDateString() === targetDateStr) { const c = this.data.cases.find(x => x.id == u.caseId); events.push({ type: 'update', title: u.analysis?.type || 'Publica√ß√£o', sub: c ? c.client : 'Sem v√≠nculo', done: true, id: u.id }); } });
                const body = document.getElementById('day-details-body'); document.getElementById('day-details-title').innerText = `Agenda: ${String(day).padStart(2,'0')}/${String(month+1).padStart(2,'0')}/${year}`;
                if(events.length === 0) { body.innerHTML = '<p style="color:var(--text-muted); text-align:center; padding:20px 0;">Nenhum evento registrado.</p>'; } else { body.innerHTML = events.map(e => { let icon = 'üìù'; let color = 'var(--info)'; if(e.type === 'deadline') { icon = '‚è≥'; color = 'var(--danger)'; } if(e.type === 'update') { icon = 'üìú'; color = 'var(--warning)'; } let actionBtn = ''; if(e.type !== 'update') { actionBtn = `<button class="btn btn-sm ${e.done?'btn-success':'btn-outline'}" onclick="app.${e.type==='deadline'?'toggleDeadline':'toggleTask'}(${e.id}); app.showDayDetails(${day},${month},${year})">${e.done?'Desfazer':'Concluir'}</button>`; } else { actionBtn = `<button class="btn btn-sm btn-outline" onclick="app.closeModal('modal-day-details'); app.viewPublication(${e.id})">Visualizar</button>`; } return `<div style="padding:15px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center; background:var(--bg-body); border-radius:var(--radius-md); margin-bottom:8px;"><div><div style="font-weight:700; color:${color}; text-decoration:${(e.done && e.type !== 'update')?'line-through':'none'}">${icon} ${e.title}</div><div style="font-size:0.85rem; color:var(--text-secondary); margin-top:4px;">${e.sub}</div></div><div style="display:flex; gap:5px;">${actionBtn}</div></div>`; }).join(''); }
                document.getElementById('modal-day-details').classList.add('active');
            },

            swapClientOpponent() { const clientInput = document.querySelector('#modal-case [name="client"]'); const opponentInput = document.querySelector('#modal-case [name="opponent"]'); const roleInput = document.querySelector('#modal-case [name="client_role"]'); if(clientInput && opponentInput && roleInput) { const temp = clientInput.value; clientInput.value = opponentInput.value; opponentInput.value = temp; roleInput.value = roleInput.value === 'autor' ? 'reu' : 'autor'; } },
            openStatusMenu(el, id) { this.currentStatusId = id; const m = document.getElementById('status-menu'); const r = el.getBoundingClientRect(); m.style.top = (r.bottom + window.scrollY + 8) + 'px'; m.style.left = r.left + 'px'; m.classList.add('show'); },
            changeStatus(st) { if(this.currentStatusId) { const i = this.data.cases.findIndex(c=>c.id===this.currentStatusId); if(i>-1) { this.data.cases[i].status=st; this.saveToStorage(); this.renderCases(); document.getElementById('status-menu').classList.remove('show'); } } },
            
            openModal(id, dataId = null, extraDate = null) { 
                document.getElementById(id).classList.add('active'); const form = document.querySelector(`#${id} form`); if(form) form.reset(); 
                
                if (extraDate && id === 'modal-deadline') {
                    document.querySelector('#modal-deadline [name="date"]').value = extraDate;
                }

                if(id==='modal-case' && dataId) { const c = this.data.cases.find(x=>x.id===dataId); if(c){ document.querySelector('[name="id"]').value=c.id; document.querySelector('[name="number"]').value=c.number; document.querySelector('[name="client"]').value=c.client; document.querySelector('[name="client_role"]').value=c.client_role || 'autor'; document.querySelector('[name="status"]').value=c.status; document.querySelector('[name="opponent"]').value=c.opponent||''; document.querySelector('[name="area"]').value=c.area||'C√≠vel'; document.querySelector('[name="value"]').value=c.value||''; document.querySelector('[name="fees"]').value=c.fees||''; document.querySelector('[name="lawyer"]').value=c.lawyer||''; document.querySelector('[name="obs"]').value=c.obs||''; if(c.date_start) document.querySelector('[name="date_start"]').value=c.date_start.split('T')[0]; } } 
                if(id==='modal-deadline' || id==='modal-task' || id==='modal-payment') { let selId = ''; if(id==='modal-deadline') selId = 'case-select-dropdown'; else if(id==='modal-task') selId = 'task-case-select'; else if(id==='modal-payment') selId = 'payment-case-select'; const sel = document.getElementById(selId); sel.innerHTML = id==='modal-task' ? '<option value="">Geral (Sem v√≠nculo)</option>' : '<option value="">Selecione um processo...</option>'; this.data.cases.forEach(x=>sel.add(new Option(`${x.client} - ${x.number}`, x.id))); if(dataId && typeof dataId === 'number') { if(id==='modal-payment') { sel.value = dataId; } else { const item = id==='modal-deadline'?this.data.deadlines.find(x=>x.id===dataId):this.data.tasks.find(x=>x.id===dataId); if(item) { document.querySelector(`#${id} [name="id"]`).value=item.id; if(item.caseId) sel.value=item.caseId; if(id==='modal-deadline') { document.querySelector(`#${id} [name="type"]`).value = item.type || ''; if(item.date_start) document.querySelector(`#${id} [name="date_start"]`).value = item.date_start.split('T')[0]; if(item.date) document.querySelector(`#${id} [name="date"]`).value = item.date.split('T')[0]; } else if(id==='modal-task') { document.querySelector(`#${id} [name="desc"]`).value = item.desc || ''; document.querySelector(`#${id} [name="priority"]`).value = item.priority || 'M√©dia'; if(item.date) document.querySelector(`#${id} [name="date"]`).value = item.date.split('T')[0]; } } } } else if (dataId && id==='modal-deadline') { document.getElementById('deadline-case-id').value=dataId; document.getElementById('case-selector-container').style.display='none'; } else { if(id==='modal-deadline') document.getElementById('case-selector-container').style.display='block'; } } 
            },
            closeModal(id) { document.getElementById(id).classList.remove('active'); },
            
            saveCase(e) { e.preventDefault(); const f = new FormData(e.target); const id = f.get('id'); const d = { number: f.get('number'), client: f.get('client'), client_role: f.get('client_role') || 'autor', opponent: f.get('opponent'), status: f.get('status'), area: f.get('area'), value: parseFloat(f.get('value')||0), fees: parseFloat(f.get('fees')||0), obs: f.get('obs'), lawyer: f.get('lawyer'), date_start: f.get('date_start') ? this.fixDate(f.get('date_start')).toISOString() : null }; if(id){ const i = this.data.cases.findIndex(c=>c.id==id); this.data.cases[i]={...this.data.cases[i],...d}; } else { this.data.cases.push({...d, id:Date.now(), date_created:new Date().toISOString()}); } this.saveToStorage(); this.closeModal('modal-case'); this.navigate('cases'); },
            
            saveDeadline(e) { 
                e.preventDefault(); 
                const f = new FormData(e.target); 
                const id = f.get('id'); 
                const cid = f.get('caseId')||f.get('caseSelect'); 
                if(!cid) return alert('Selecione um processo.'); 
                
                const dtStart = f.get('date_start') ? this.fixDate(f.get('date_start')).toISOString() : null;
                const dtEnd = this.fixDate(f.get('date'));
                
                const payload = { 
                    caseId: parseInt(cid), 
                    type: f.get('type'), 
                    date_start: dtStart, 
                    date: dtEnd.toISOString(), 
                    done: false 
                }; 
                
                if(id) { 
                    const idx = this.data.deadlines.findIndex(d => d.id == id); 
                    if(idx > -1) { 
                        payload.done = this.data.deadlines[idx].done; 
                        this.data.deadlines[idx] = { ...this.data.deadlines[idx], ...payload }; 
                    } 
                } else { 
                    this.data.deadlines.push({ id: Date.now(), ...payload }); 
                } 
                this.saveToStorage(); 
                this.closeModal('modal-deadline'); 
                this.navigate('deadlines'); 

                if(confirm('Prazo salvo! Deseja criar um evento ou tarefa no Google Agenda?')) {
                    const cRef = this.data.cases.find(x => x.id == parseInt(cid));
                    const clientName = cRef ? cRef.client : "Processo";
                    
                    const dStr = dtEnd.toISOString().split('T')[0].replace(/-/g, '');
                    const nextDay = new Date(dtEnd); nextDay.setDate(nextDay.getDate()+1);
                    const dEndStr = nextDay.toISOString().split('T')[0].replace(/-/g, '');
                    
                    const eventTitle = `Prazo Final: ${f.get('type')} (${clientName})`;
                    const gcalUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(eventTitle)}&dates=${dStr}/${dEndStr}&details=${encodeURIComponent('Prazo gerado via LexManager para o cliente ' + clientName)}`;
                    window.open(gcalUrl, '_blank');
                }
            },

            saveTask(e) { e.preventDefault(); const f = new FormData(e.target); const id = f.get('id'); const payload = { desc: f.get('desc'), priority: f.get('priority'), date: this.fixDate(f.get('date')).toISOString(), caseId: document.getElementById('task-case-select').value, done: false }; if(id) { const idx = this.data.tasks.findIndex(t => t.id == id); if(idx > -1) { payload.done = this.data.tasks[idx].done; this.data.tasks[idx] = { ...this.data.tasks[idx], ...payload }; } } else { this.data.tasks.push({ id: Date.now(), ...payload }); } this.saveToStorage(); this.closeModal('modal-task'); this.navigate('tasks'); },
            saveTransaction(e) { e.preventDefault(); const f = new FormData(e.target); this.data.transactions.push({ id: Date.now(), caseId: parseInt(f.get('caseId')), type: f.get('type'), amount: parseFloat(f.get('amount')), desc: f.get('desc') }); this.saveToStorage(); this.closeModal('modal-payment'); this.navigate('finance'); },
            deleteTransaction(id) { if(confirm('Tem certeza que deseja excluir este lan√ßamento permanentemente?')) { this.data.transactions = this.data.transactions.filter(t => t.id !== id); this.saveToStorage(); this.navigate('finance'); } },

            renderCases() { 
                const t = document.getElementById('cases-table-body'); t.innerHTML = ''; 
                let arr = [...this.data.cases]; if(this.sortState.cases === 'name') { arr.sort((a,b) => a.client.localeCompare(b.client)); } else { arr.sort((a,b) => new Date(b.date_created||0) - new Date(a.date_created||0)); }
                arr.forEach(c => { 
                    let bg = c.status === 'Em andamento' ? 'badge-blue' : (c.status === 'Finalizado' ? 'badge-green' : 'badge-gray'); 
                    t.innerHTML += `<tr><td><span class="clickable-link" onclick="app.openCaseDetail(${c.id})">${c.number}</span></td><td>${c.client}</td><td>${c.area}</td><td><span class="badge ${bg}" onclick="app.openStatusMenu(this,${c.id})">${c.status} ‚ñæ</span></td><td><button class="btn btn-outline btn-sm" onclick="app.openModal('modal-case',${c.id})">‚úèÔ∏è</button></td></tr>`; 
                }); 
            },
            
            renderDeadlines() { 
                const t = document.getElementById('deadlines-table-body'); t.innerHTML = ''; 
                let arr = [...this.data.deadlines]; if(this.sortState.deadlines === 'name') { arr.sort((a,b) => { let ca = this.data.cases.find(x=>x.id==a.caseId); let cb = this.data.cases.find(x=>x.id==b.caseId); return (ca?ca.client:'Z').localeCompare(cb?cb.client:'Z'); }); } else { arr.sort((a,b)=>new Date(a.date)-new Date(b.date)); }
                arr.forEach(d => { const c = this.data.cases.find(x=>x.id==d.caseId); t.innerHTML += `<tr><td>${new Date(d.date).toLocaleDateString('pt-BR')}</td><td><span class="badge badge-gray">${d.type}</span></td><td>${c ? `<span class="clickable-link" onclick="app.openCaseDetail(${c.id})">${c.client}</span>` : '-'}</td><td>${d.done ? '<span class="badge badge-green">Conclu√≠do</span>' : '<span class="badge badge-red">Pendente</span>'}</td><td><button class="btn btn-outline btn-sm" onclick="app.toggleDeadline(${d.id})">${d.done ? 'Desfazer' : 'Concluir'}</button> <button class="btn btn-outline btn-sm" onclick="app.openModal('modal-deadline',${d.id})">‚úèÔ∏è</button> <button class="btn btn-danger btn-sm" onclick="app.deleteDeadline(${d.id})">üóë</button></td></tr>`; }); 
            },

            renderTasks() { 
                const t = document.getElementById('tasks-table-body'); t.innerHTML = ''; 
                let arr = [...this.data.tasks]; if(this.sortState.tasks === 'name') { arr.sort((a,b) => a.desc.localeCompare(b.desc)); } else { arr.sort((a,b)=>new Date(a.date)-new Date(b.date)); }
                arr.forEach(tsk => { const c = this.data.cases.find(x=>x.id==tsk.caseId); let badgeClass = tsk.priority === 'Alta' ? 'badge-red' : (tsk.priority === 'M√©dia' ? 'badge-yellow' : 'badge-blue'); t.innerHTML += `<tr><td><span class="badge ${badgeClass}">${tsk.priority}</span></td><td style="text-decoration:${tsk.done?'line-through':'none'}; color:${tsk.done?'var(--text-muted)':'var(--text-main)'}">${tsk.desc}</td><td>${c ? `<span class="clickable-link" onclick="app.openCaseDetail(${c.id})">${c.client}</span>` : '<span style="color:var(--text-muted)">Geral</span>'}</td><td>${new Date(tsk.date).toLocaleDateString('pt-BR')}</td><td><button class="btn btn-outline btn-sm" onclick="app.toggleTask(${tsk.id})">${tsk.done ? 'Reabrir' : 'Feito'}</button> <button class="btn btn-outline btn-sm" onclick="app.openModal('modal-task',${tsk.id})">‚úèÔ∏è</button></td></tr>`; }); 
            },

            renderClients() { 
                const t = document.getElementById('clients-table-body'); t.innerHTML = ''; 
                const cs = {}; this.data.cases.forEach(c => { if(!cs[c.client]) cs[c.client] = {name:c.client, count:0, val:0, roles:new Set()}; if(c.status==='Em andamento') cs[c.client].count++; cs[c.client].val += (parseFloat(c.value)||0); cs[c.client].roles.add(c.client_role === 'reu' ? 'R√©u' : 'Autor'); }); 
                let arr = Object.values(cs); if(this.sortState.clients === 'name') { arr.sort((a,b) => a.name.localeCompare(b.name)); } else { arr.sort((a,b) => b.val - a.val); }
                arr.forEach(cl => { const rolesStr = Array.from(cl.roles).join(' / '); t.innerHTML += `<tr><td><span class="clickable-link" onclick="app.openClientDetail('${cl.name}')">${cl.name}</span></td><td><span class="badge badge-gray">${rolesStr}</span></td><td><span class="badge badge-blue">${cl.count}</span> ativos</td><td>${this.formatCurrency(cl.val)}</td><td><button class="btn btn-danger btn-sm" onclick="app.deleteClient('${cl.name}')">üóë</button></td></tr>`; }); 
            },

            renderFinance() {
                let pending = 0, received = 0, expenses = 0; this.data.transactions.forEach(t => { if(t.type === 'income') received += t.amount; if(t.type === 'expense') expenses += t.amount; }); document.getElementById('fin-received-tab').innerText = this.formatCurrency(received); document.getElementById('fin-expenses-tab').innerText = this.formatCurrency(expenses); document.getElementById('fin-balance-tab').innerText = this.formatCurrency(received - expenses);
                const tBody = document.getElementById('finance-ledger-body'); tBody.innerHTML = ''; let ledger = [...this.data.transactions]; if(this.sortState.finance === 'name') { ledger.sort((a,b) => { let ca = this.data.cases.find(x=>x.id==a.caseId); let cb = this.data.cases.find(x=>x.id==b.caseId); return (ca?ca.client:'Z').localeCompare(cb?cb.client:'Z'); }); } else { ledger.sort((a,b) => b.id - a.id); }
                ledger.forEach(t => { const c = this.data.cases.find(x=>x.id==t.caseId); const isInc = t.type === 'income'; tBody.innerHTML += `<tr><td>${new Date(t.id).toLocaleDateString('pt-BR')}</td><td><span class="badge ${isInc?'badge-green':'badge-red'}">${isInc?'Entrada':'Sa√≠da'}</span></td><td>${t.desc}</td><td>${c ? c.client : '-'}</td><td style="color:${isInc?'var(--success)':'var(--danger)'}; font-weight:600;">${isInc?'+':'-'} ${this.formatCurrency(t.amount)}</td><td><button class="btn btn-danger btn-sm" onclick="app.deleteTransaction(${t.id})">üóë</button></td></tr>`; });
                const bBody = document.getElementById('finance-table-body'); bBody.innerHTML = ''; this.data.cases.forEach(c => { if(!c.fees && !this.data.transactions.some(t=>t.caseId===c.id)) return; const rec = this.data.transactions.filter(t=>t.caseId===c.id && t.type==='income').reduce((a,v)=>a+v.amount,0); bBody.innerHTML += `<tr><td><span class="clickable-link" onclick="app.openCaseDetail(${c.id})">${c.client}</span><br><small style="color:var(--text-muted); font-family:monospace;">${c.number}</small></td><td>${this.formatCurrency(c.fees||0)}</td><td><span style="color:var(--success); font-weight:600;">${this.formatCurrency(rec)}</span></td><td style="font-weight:600; color:var(--text-main);">${this.formatCurrency((c.fees||0)-rec)}</td><td><button class="btn btn-outline btn-sm" onclick="app.openModal('modal-payment', ${c.id})">+ Lan√ßamento</button></td></tr>`; });
            },
            
            openClientDetail(name) { 
                const cl = this.data.cases.filter(c=>c.client===name); let h = `<div style="margin-bottom:20px; font-size:1.1rem;">Total consolidado: <b>${cl.length} processo(s)</b></div><table style="width:100%"><thead><tr><th>N¬∫ CNJ</th><th>Posi√ß√£o</th><th>Status</th><th>Valor Causa</th></tr></thead><tbody>`; 
                cl.forEach(c => { const roleLabel = c.client_role === 'reu' ? '<span class="badge badge-yellow">R√©u</span>' : '<span class="badge badge-blue">Autor</span>'; h += `<tr><td><span class="clickable-link" onclick="app.closeModal('modal-client-detail'); app.openCaseDetail(${c.id})">${c.number}</span></td><td>${roleLabel}</td><td><span class="badge ${c.status==='Em andamento'?'badge-blue':'badge-gray'}">${c.status}</span></td><td>${this.formatCurrency(c.value)}</td></tr>`; }); 
                document.getElementById('client-detail-body').innerHTML = h + `</tbody></table>`; document.getElementById('modal-client-detail').classList.add('active'); 
            },

            openCaseDetail(id) { 
                const c = this.data.cases.find(x=>x.id===id); if(!c) return; 
                const contracted = c.fees||0; const received = this.data.transactions.filter(t=>t.caseId===id && t.type==='income').reduce((acc,t)=>acc+t.amount,0); const pctReceived = contracted > 0 ? Math.min((received/contracted)*100, 100) : 0; 
                let timeline = []; const initialDate = c.date_start || c.date_created; timeline.push({date:initialDate, type:'create', title:'In√≠cio do Processo / Cadastro', desc:'Registro do caso', id:null}); 
                this.data.deadlines.filter(d=>d.caseId===id).forEach(d => timeline.push({date:d.date, type:'deadline', title:`Prazo: ${d.type}`, desc:d.done?'Status: Conclu√≠do ‚úÖ':'Status: Pendente ‚è≥', id:d.id}) ); this.data.transactions.filter(t=>t.caseId===id).forEach(t => timeline.push({date:t.id, type:'finance', title:t.type==='income'?'Honor√°rios Recebidos':'Despesa Registrada', desc:`Valor: ${this.formatCurrency(t.amount)}`, id:null}) ); this.data.updates.filter(u=>u.caseId===id).forEach(u => timeline.push({date:u.date, type:'update', title:'Publica√ß√£o Analisada', desc:`Ato: ${u.analysis.type}`, id:u.id}) ); 
                
                if(c.full_analyses) {
                    c.full_analyses.forEach(fa => {
                        timeline.push({date: fa.date, type: 'analysis', title: 'Diagn√≥stico Estrat√©gico', desc: 'Clique para ver a an√°lise completa', id: null, originalId: fa.id});
                    });
                }
                timeline.sort((a,b)=>new Date(b.date)-new Date(a.date)); 

                document.getElementById('case-detail-content').innerHTML = `
                    <div class="case-detail-card">
                        
                        <div class="case-header-optimized">
                            <div class="case-number-box">
                                <span class="case-number-label">Processo Unificado</span>
                                <span class="case-number-main">${c.number}</span>
                            </div>
                            <span class="badge ${c.status==='Em andamento'?'badge-blue':'badge-gray'}">${c.status}</span>
                        </div>
                        
                        <div class="case-info-grid">
                            <div class="info-item"><label>Cliente</label><div>${c.client}</div></div>
                            <div class="info-item"><label>Adverso</label><div>${c.opponent||'-'}</div></div>
                            <div class="info-item"><label>√Årea</label><div>${c.area}</div></div>
                            <div class="info-item"><label>Valor</label><div>${this.formatCurrency(c.value)}</div></div>
                        </div>

                        <div class="finance-compact">
                            <div class="finance-row"><span>Contrato: <b>${this.formatCurrency(contracted)}</b></span><span>Recebido: <b style="color:var(--success)">${this.formatCurrency(received)}</b></span></div>
                            <div class="finance-progress"><div class="progress-received" style="width:${pctReceived}%"></div><div class="progress-pending" style="width:${100-pctReceived}%"></div></div>
                        </div>

                        <div class="btn-group-mobile">
                            <button class="btn btn-outline" onclick="app.openModal('modal-case', ${c.id})">‚úèÔ∏è Editar</button> 
                            <button class="btn btn-primary" onclick="app.openModal('modal-deadline', ${c.id})">‚è≥ Prazo</button>
                        </div>
                    </div>
                    
                    <h3 style="margin-bottom: 20px; font-size:1.1rem; border-top:1px solid var(--border-color); padding-top:20px;">Linha do Tempo</h3>
                    <div class="full-timeline">
                        ${timeline.map(t => { 
                            let clickAct = ''; if(t.type === 'update') clickAct = `onclick="app.viewPublication(${t.id})" style="cursor:pointer;"`; if(t.type === 'deadline') clickAct = `onclick="app.openModal('modal-deadline', ${t.id})" style="cursor:pointer;"`; 
                            
                            if (t.type === 'analysis') {
                                clickAct = `onclick="app.viewStrategicAnalysis(${c.id}, ${t.originalId})" style="cursor:pointer;"`;
                                return `<div class="ft-item" ${clickAct}><div class="ft-icon analysis">üß†</div><div class="ft-card"><div class="ft-date">${new Date(t.date).toLocaleDateString('pt-BR')}</div><b style="color:var(--warning); font-size:1rem; display:block; margin-bottom:2px;">${t.title}</b><div style="font-size:0.85rem; color:var(--text-secondary);">${t.desc}</div></div></div>`;
                            }
                            return `<div class="ft-item" ${clickAct}><div class="ft-icon ${t.type}">${t.type==='create'?'‚òÖ':(t.type==='deadline'?'‚è≥':(t.type==='finance'?'$':'üìÑ'))}</div><div class="ft-card"><div class="ft-date">${new Date(t.date).toLocaleDateString('pt-BR')}</div><b style="color:var(--primary); font-size:1rem; display:block; margin-bottom:2px;">${t.title}</b><div style="font-size:0.85rem; color:var(--text-secondary);">${t.desc}</div></div></div>`; 
                        }).join('')}
                    </div>`; 
                
                this.navigate('case-detail'); 
            },

            deleteClient(n) { if(confirm('Aviso: Isso apagar√° TODOS os processos vinculados a este cliente. Deseja prosseguir?')) { this.data.cases = this.data.cases.filter(c=>c.client!==n); this.saveToStorage(); this.renderClients(); } },
            toggleDeadline(id) { const i = this.data.deadlines.findIndex(d=>d.id===id); if(i>-1) { this.data.deadlines[i].done = !this.data.deadlines[i].done; this.saveToStorage(); this.renderDeadlines(); } },
            deleteDeadline(id) { if(confirm('Tem certeza que deseja apagar este prazo?')) { this.data.deadlines = this.data.deadlines.filter(d=>d.id!==id); this.saveToStorage(); this.renderDeadlines(); } },
            toggleTask(id) { const i = this.data.tasks.findIndex(t=>t.id===id); if(i>-1) { this.data.tasks[i].done = !this.data.tasks[i].done; this.saveToStorage(); this.renderTasks(); } },
            saveToStorage() { localStorage.setItem('lexData', JSON.stringify(this.data)); },
            loadData() { 
                const d = localStorage.getItem('lexData'); if(d) this.data = JSON.parse(d); if(!this.data.tasks) this.data.tasks = []; if(!this.data.updates) this.data.updates = []; if(!this.data.settings) this.data.settings = { theme: 'light', dashOrder: ['ativos', 'prazos', 'saldo'], userName: 'Doutor(a)', profilePic: null }; if(this.data.settings && !this.data.settings.userName) this.data.settings.userName = 'Doutor(a)';
                const l = [...new Set(this.data.cases.map(c=>c.lawyer).filter(Boolean))]; const ls = document.getElementById('filter-lawyer'); if(ls) l.forEach(x => ls.add(new Option(x,x))); const a = [...new Set(this.data.cases.map(c=>c.area).filter(Boolean))]; const as = document.getElementById('filter-area'); if(as) a.forEach(x => as.add(new Option(x,x))); 
            },
            toggleDarkMode() { document.body.classList.toggle('dark-mode'); localStorage.setItem('lexTheme', document.body.classList.contains('dark-mode') ? 'dark' : 'light'); },
            clearData() { if(confirm('ATEN√á√ÉO: Isso ir√° apagar TODOS os processos, clientes e financeiro do seu navegador. N√£o h√° como desfazer. Confirmar?')) { localStorage.removeItem('lexData'); location.reload(); } },
            formatCurrency(v) { return new Intl.NumberFormat('pt-BR', {style:'currency', currency:'BRL'}).format(v); }
        };

        app.init();
    </script>
</body>
</html>
