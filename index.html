<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LexManager | CRM Jur√≠dico Profissional</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           1. DESIGN SYSTEM & VARI√ÅVEIS CSS
        ========================================= */
        :root {
            --primary: #4F46E5;
            --primary-hover: #4338CA;
            --primary-gradient: linear-gradient(135deg, #4F46E5 0%, #818CF8 100%);
            
            --danger: #EF4444; 
            --warning: #F59E0B; 
            --success: #10B981; 
            --info: #3B82F6;
            
            --bg-body: #F8FAFC; 
            --bg-surface: #FFFFFF;
            --bg-sidebar: #1E293B; 
            --text-main: #1E293B; 
            --text-secondary: #64748B; 
            --text-muted: #94A3B8;
            --text-on-dark: #F8FAFC;
            --border-color: #E2E8F0;
            
            --radius-sm: 8px;
            --radius-md: 12px; 
            --radius-lg: 20px; 
            --radius-xl: 28px;
            
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.025);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
            --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.08), 0 8px 10px -6px rgba(0,0,0,0.04);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            --font-main: 'Inter', system-ui, sans-serif;
            --sidebar-width: 260px;
        }

        body.dark-mode {
            --bg-body: #0F172A; 
            --bg-surface: #1E293B;
            --bg-sidebar: #0B0F19;
            --text-main: #F1F5F9; 
            --text-secondary: #94A3B8; 
            --border-color: #334155;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.4);
            --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        body { font-family: var(--font-main); background-color: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; transition: background-color 0.3s, color 0.3s; font-size: 14px; -webkit-font-smoothing: antialiased; }

        aside { width: var(--sidebar-width); background-color: var(--bg-sidebar); display: flex; flex-direction: column; padding: 24px 16px; transition: var(--transition); z-index: 50; flex-shrink: 0; box-shadow: var(--shadow-md); }
        .logo { font-size: 1.5rem; font-weight: 800; margin-bottom: 40px; padding: 0 12px; display: flex; align-items: center; gap: 12px; color: var(--text-on-dark); letter-spacing: -0.5px; }
        .logo svg { width: 28px; height: 28px; fill: var(--primary); }
        nav button { background: transparent; border: none; color: #94A3B8; width: 100%; padding: 12px 16px; text-align: left; cursor: pointer; border-radius: var(--radius-md); display: flex; align-items: center; gap: 12px; font-weight: 500; font-size: 0.95rem; transition: var(--transition); position: relative; margin-bottom: 8px; }
        nav button:hover { background-color: rgba(255,255,255,0.05); color: var(--text-on-dark); }
        nav button.active { background-color: var(--primary); color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }

        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .app-topbar { height: 70px; background-color: var(--bg-surface); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; padding: 0 32px; flex-shrink: 0; transition: background-color 0.3s, border-color 0.3s; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 32px; scroll-behavior: smooth; }
        .hidden { display: none !important; }

        .card { background: var(--bg-surface); border-radius: var(--radius-lg); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); padding: 24px; margin-bottom: 24px; transition: var(--transition); }
        .card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); border-color: var(--primary); }

        .dash-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 32px; }
        .dash-header h2 { font-size: 1.8rem; font-weight: 700; color: var(--text-main); letter-spacing: -0.5px; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px; margin-bottom: 32px; }
        .stat-card { background: var(--bg-surface); padding: 24px; border-radius: var(--radius-lg); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); display: flex; flex-direction: column; min-height: 140px; transition: var(--transition); }
        .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .stat-icon-bg { width: 48px; height: 48px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin-bottom: 16px; font-size: 1.5rem; }
        .stat-title { font-size: 0.8rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-value { font-size: 2.25rem; font-weight: 800; color: var(--text-main); margin: 8px 0 4px 0; letter-spacing: -1px; }

        .card-blue .stat-icon-bg { background: rgba(79, 70, 229, 0.1); color: var(--primary); }
        .card-red .stat-icon-bg { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .stat-value.text-danger { color: var(--danger); }
        .card-green .stat-icon-bg { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .stat-value.text-success { color: var(--success); }

        .btn { padding: 10px 20px; border-radius: var(--radius-md); border: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: var(--transition); box-shadow: var(--shadow-sm); font-family: inherit; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary-gradient); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); }
        .btn-primary:hover { box-shadow: 0 6px 15px rgba(79, 70, 229, 0.4); transform: translateY(-1px); }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-main); box-shadow: none; }
        .btn-outline:hover { background: var(--bg-body); border-color: var(--text-secondary); }
        .btn-danger { background: var(--bg-surface); border: 1px solid var(--danger); color: var(--danger); }
        .btn-success { background: var(--success); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; border-radius: 8px; }
        
        input, select, textarea { width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: var(--bg-body); color: var(--text-main); font-family: var(--font-main); font-size: 0.95rem; margin-bottom: 16px; transition: var(--transition); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); background: var(--bg-surface); box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        label { display: block; margin-bottom: 6px; font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); }

        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { text-align: left; padding: 16px 20px; color: var(--text-secondary); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; border-bottom: 1px solid var(--border-color); background: var(--bg-surface); position: sticky; top: 0; }
        td { padding: 16px 20px; border-bottom: 1px solid var(--border-color); font-size: 0.95rem; vertical-align: middle; }
        tr:hover td { background-color: var(--bg-body); }
        tr:last-child td { border-bottom: none; }

        .badge { padding: 6px 12px; border-radius: 999px; font-size: 0.75rem; font-weight: 700; display: inline-flex; align-items: center; cursor: pointer; transition: transform 0.2s; }
        .badge-blue { background: rgba(59, 130, 246, 0.1); color: #2563eb; border: 1px solid rgba(59, 130, 246, 0.2); }
        .badge-green { background: rgba(16, 185, 129, 0.1); color: #059669; border: 1px solid rgba(16, 185, 129, 0.2); }
        .badge-red { background: rgba(239, 68, 68, 0.1); color: #dc2626; border: 1px solid rgba(239, 68, 68, 0.2); }
        .badge-yellow { background: rgba(245, 158, 11, 0.1); color: #d97706; border: 1px solid rgba(245, 158, 11, 0.2); }
        .badge-gray { background: rgba(107, 114, 128, 0.1); color: var(--text-secondary); border: 1px solid rgba(107, 114, 128, 0.2); }

        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .flex-gap { display: flex; gap: 16px; }
        .clickable-link { color: var(--primary); font-weight: 600; cursor: pointer; transition: 0.2s; }
        .clickable-link:hover { text-decoration: underline; color: var(--primary-hover); }

        /* WIDGETS CALENDARIO */
        .calendar-widget { display: grid; grid-template-columns: 1fr 320px; gap: 32px; }
        .calendar-list { border-right: 1px solid var(--border-color); padding-right: 24px; max-height: 350px; overflow-y: auto; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
        .calendar-day-header { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; padding-bottom: 8px; }
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: var(--radius-md); font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: 0.2s; color: var(--text-main); position: relative; background: var(--bg-body); }
        .calendar-day:hover { background: var(--border-color); }
        .calendar-day.today { border: 2px solid var(--primary); background: rgba(79, 70, 229, 0.05); color: var(--primary); font-weight: 800; }
        .calendar-dots { display: flex; gap: 4px; margin-top: 4px; flex-wrap: wrap; justify-content: center; max-width: 80%; }
        .calendar-dot { width: 6px; height: 6px; border-radius: 50%; }
        .dot-deadline { background-color: var(--danger); }
        .dot-task { background-color: var(--info); }
        .dot-publication { background-color: var(--warning); }
        
        .calendar-legend { display: flex; gap: 15px; justify-content: center; margin-top: 20px; font-size: 0.85rem; color: var(--text-secondary); font-weight: 600; padding-top:15px; border-top: 1px solid var(--border-color); }
        .legend-item { display: flex; align-items: center; gap: 6px; }

        .smart-summary { background: var(--bg-body); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px; cursor: pointer; transition: 0.2s; }
        .smart-summary:hover { box-shadow: var(--shadow-md); border-color: var(--primary); }
        .summary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); }
        .summary-tag { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; padding: 4px 10px; border-radius: 8px; }
        .tag-blue { background: var(--primary); color: white; }
        .raw-text-content { display: none; }

        .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 0.9rem; margin-bottom: 20px; }
        .analysis-item { display: flex; flex-direction: column; background: var(--bg-body); padding: 12px; border-radius: var(--radius-md); }
        .analysis-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; }
        .analysis-val { font-weight: 500; color: var(--text-main); font-size: 0.9rem; white-space: pre-wrap;}
        .client-summary-box { background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); padding: 16px; border-radius: var(--radius-md); margin-top: 10px; font-size: 0.95rem; color: #b45309; line-height: 1.5; font-style: italic;}
        body.dark-mode .client-summary-box { color: #fcd34d; }

        .full-timeline { position: relative; margin-top: 2rem; }
        .full-timeline::before { content: ''; position: absolute; left: 24px; top: 0; bottom: 0; width: 2px; background: var(--border-color); }
        .ft-item { position: relative; margin-bottom: 24px; padding-left: 60px; }
        .ft-icon { position: absolute; left: 8px; top: 0; width: 34px; height: 34px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; border: 4px solid var(--bg-surface); z-index: 2; box-shadow: var(--shadow-sm); }
        .ft-icon.finance { background: var(--success); } .ft-icon.create { background: var(--text-secondary); } .ft-icon.update { background: var(--info); }
        .ft-card { background: var(--bg-surface); padding: 1.5rem; border-radius: var(--radius-lg); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); transition: var(--transition); }
        
        .finance-summary-bar { margin-top: 1.5rem; padding: 1.5rem; background: var(--bg-body); border-radius: var(--radius-md); border: 1px solid var(--border-color); }
        .finance-progress { height: 10px; background: var(--border-color); border-radius: 5px; margin: 12px 0; overflow: hidden; display: flex; }
        .progress-received { background: var(--success); height: 100%; } .progress-pending { background: var(--warning); height: 100%; }

        .status-dropdown { position: absolute; background: var(--bg-surface); border: 1px solid var(--border-color); box-shadow: var(--shadow-lg); border-radius: var(--radius-md); z-index: 100; display: none; min-width: 180px; padding: 8px; }
        .status-dropdown.show { display: block; animation: slideUp 0.2s ease-out; }
        .status-option { padding: 10px 12px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 10px; color: var(--text-main); }
        .status-option:hover { background: var(--bg-body); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); z-index: 200; backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-surface); padding: 32px; border-radius: var(--radius-xl); width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg); border: 1px solid var(--border-color); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }

        .pub-view-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .pub-full-text { background: var(--bg-body); padding: 16px; border-radius: var(--radius-md); font-family: 'Courier New', monospace; font-size: 0.85rem; color: var(--text-secondary); max-height: 200px; overflow-y: auto; white-space: pre-wrap; border: 1px solid var(--border-color); }
        
        .menu-toggle { display: none; position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: var(--primary); color: white; box-shadow: var(--shadow-lg); z-index: 100; font-size: 24px; align-items: center; justify-content: center; border: none; }

        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* RESPONSIVIDADE */
        @media (max-width: 768px) { 
            aside { position: fixed; height: 100%; left: -280px; box-shadow: var(--shadow-lg); } 
            aside.active { left: 0; } 
            .menu-toggle { display: flex; } 
            .calendar-widget { grid-template-columns: 1fr; } 
            .app-topbar { padding: 0 16px; } 
            .stats-grid { grid-template-columns: 1fr; }
            .dash-header { flex-direction: column; gap: 15px;}
            .dash-header .quick-actions { width: 100%; display: flex; gap: 10px;}
            .dash-header .quick-actions button { flex: 1; font-size: 0.85rem; padding: 10px 5px;}
            .analysis-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <button class="menu-toggle" onclick="app.toggleSidebar()">‚ò∞</button>

    <aside id="sidebar">
        <div class="logo"><svg viewBox="0 0 24 24"><path d="M12 2L1 21h22L12 2zm0 3.5L19.5 19h-15L12 5.5z"/></svg> LexManager</div>
        <nav>
            <button onclick="app.navigate('dashboard')" class="active" id="nav-dashboard">üìä Dashboard</button>
            <button onclick="app.navigate('updates')" id="nav-updates">üì¢ Publica√ß√µes</button>
            <button onclick="app.navigate('cases')" id="nav-cases">‚öñÔ∏è Processos</button>
            <button onclick="app.navigate('clients')" id="nav-clients">üë• Clientes</button>
            <button onclick="app.navigate('deadlines')" id="nav-deadlines">‚è≥ Prazos</button>
            <button onclick="app.navigate('tasks')" id="nav-tasks">üìù Tarefas</button>
            <button onclick="app.navigate('finance')" id="nav-finance">üí∞ Financeiro</button>
            <button onclick="app.navigate('settings')" id="nav-settings">‚öôÔ∏è Configura√ß√µes</button>
        </nav>
    </aside>

    <main>
        <div class="app-topbar">
            <div style="font-weight:700; font-size:1.2rem; color:var(--text-main);">Painel Executivo</div>
            <div style="display:flex; align-items:center; gap:15px;">
                <button class="btn-outline" style="min-width:auto; padding:8px 12px; border-radius: 8px;" onclick="app.toggleDarkMode()">üåì Tema</button>
                <div style="width:38px; height:38px; border-radius:50%; background:var(--primary-gradient); color:white; display:flex; align-items:center; justify-content:center; font-weight: 700;">Dr</div>
            </div>
        </div>

        <div class="content-scroll">
            
            <section id="view-dashboard">
                <div class="dash-header">
                    <div><h2>Ol√°, Doutor(a)</h2><p style="color:var(--text-secondary); margin-top:4px;">Resumo estrat√©gico do escrit√≥rio.</p></div>
                    <div class="quick-actions flex-gap">
                        <button class="btn btn-outline" onclick="app.openModal('modal-case')">‚ûï Processo</button>
                        <button class="btn btn-primary" onclick="app.openModal('modal-import')">üìã Importar Pub.</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card card-blue"><div class="stat-icon-bg">‚öñÔ∏è</div><div class="stat-title">Ativos</div><div class="stat-value" id="dash-active">0</div></div>
                    <div class="stat-card card-red"><div class="stat-icon-bg">‚è≥</div><div class="stat-title">Prazos Hoje</div><div class="stat-value text-danger" id="dash-today">0</div></div>
                    <div class="stat-card card-green"><div class="stat-icon-bg">üí∞</div><div class="stat-title">Saldo Global</div><div class="stat-value text-success" id="dash-finance-received">R$ 0,00</div></div>
                </div>

                <div class="card">
                    <div class="flex-between" style="margin-bottom: 1.5rem;"><h3>üìÖ Agenda Forense</h3><span id="calendar-month-label" style="font-weight:700; color:var(--primary); text-transform:uppercase; font-size:0.85rem;"></span></div>
                    <div class="calendar-widget">
                        <div class="calendar-list" id="calendar-list-content"></div>
                        <div>
                            <div class="calendar-grid" style="margin-bottom:5px;"><div class="calendar-day-header">D</div><div class="calendar-day-header">S</div><div class="calendar-day-header">T</div><div class="calendar-day-header">Q</div><div class="calendar-day-header">Q</div><div class="calendar-day-header">S</div><div class="calendar-day-header">S</div></div>
                            <div class="calendar-grid" id="calendar-grid-content"></div>
                            
                            <div class="calendar-legend">
                                <div class="legend-item"><div class="calendar-dot dot-deadline"></div> Prazo</div>
                                <div class="legend-item"><div class="calendar-dot dot-task"></div> Tarefa</div>
                                <div class="legend-item"><div class="calendar-dot dot-publication"></div> Pub.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="view-cases" class="hidden">
                <div class="flex-between" style="margin-bottom:1.5rem;"><h2>Processos</h2><button class="btn btn-primary" onclick="app.openModal('modal-case')">+ Novo Processo</button></div>
                <div class="card" style="overflow-x:auto; padding:0; border-radius: var(--radius-md);"><table style="width:100%"><thead><tr><th>N√∫mero</th><th>Cliente</th><th>√Årea</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="cases-table-body"></tbody></table></div>
            </section>

            <section id="view-updates" class="hidden">
                <div class="dash-header">
                    <div><h2>Central de Publica√ß√µes</h2><p style="color:var(--text-secondary); margin-top:4px;">An√°lise inteligente via IA.</p></div>
                    <button class="btn btn-primary" onclick="app.openModal('modal-import')">‚ú® Analisar Nova</button>
                </div>
                <div id="updates-list-full"></div>
            </section>

            <section id="view-clients" class="hidden"><div class="flex-between" style="margin-bottom:1.5rem;"><h2>Clientes</h2></div><div class="card" style="padding:0; overflow-x:auto;"><table style="width:100%"><thead><tr><th>Cliente</th><th>Processos Ativos</th><th>Total Causa</th><th>A√ß√µes</th></tr></thead><tbody id="clients-table-body"></tbody></table></div></section>
            
            <section id="view-finance" class="hidden">
                <div class="flex-between" style="margin-bottom:1.5rem;"><h2>Financeiro</h2><button class="btn btn-primary" onclick="app.openModal('modal-payment')">+ Novo Lan√ßamento</button></div>
                <div class="stats-grid">
                    <div class="stat-card" style="border-top: 4px solid var(--info)"><div class="stat-title">A Receber</div><div class="stat-value" id="fin-pending">R$ 0,00</div></div>
                    <div class="stat-card" style="border-top: 4px solid var(--success)"><div class="stat-title">Entradas</div><div class="stat-value text-success" id="fin-received">R$ 0,00</div></div>
                    <div class="stat-card" style="border-top: 4px solid var(--danger)"><div class="stat-title">Sa√≠das</div><div class="stat-value text-danger" id="fin-expenses">R$ 0,00</div></div>
                    <div class="stat-card" style="border-top: 4px solid var(--primary)"><div class="stat-title">Saldo L√≠quido</div><div class="stat-value" id="fin-balance">R$ 0,00</div></div>
                </div>
                
                <h3 style="margin-bottom: 1rem; margin-top:2rem;">Balan√ßo por Processo</h3>
                <div class="card" style="padding:0; overflow-x:auto;"><table style="width:100%"><thead><tr><th>Cliente / Processo</th><th>Contratado</th><th>Recebido</th><th>Saldo</th><th>A√ß√µes</th></tr></thead><tbody id="finance-table-body"></tbody></table></div>

                <h3 style="margin-bottom: 1rem; margin-top:2rem;">Hist√≥rico Geral de Caixa</h3>
                <div class="card" style="padding:0; overflow-x:auto;"><table style="width:100%"><thead><tr><th>Data</th><th>Tipo</th><th>Descri√ß√£o</th><th>Processo/Cliente</th><th>Valor</th><th>A√ß√µes</th></tr></thead><tbody id="finance-ledger-body"></tbody></table></div>
            </section>

            <section id="view-deadlines" class="hidden"><div class="flex-between" style="margin-bottom:1.5rem;"><h2>Prazos</h2><button class="btn btn-primary" onclick="app.openModal('modal-deadline')">+ Novo</button></div><div class="card" style="padding:0; overflow-x:auto;"><table style="width:100%"><thead><tr><th>Data</th><th>Tipo</th><th>Processo</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="deadlines-table-body"></tbody></table></div></section>
            <section id="view-tasks" class="hidden"><div class="flex-between" style="margin-bottom:1.5rem;"><h2>Tarefas</h2><button class="btn btn-primary" onclick="app.openModal('modal-task')">+ Tarefa</button></div><div class="card" style="padding:0; overflow-x:auto;"><table style="width:100%"><thead><tr><th>Prioridade</th><th>Descri√ß√£o</th><th>V√≠nculo</th><th>Prazo</th><th>A√ß√µes</th></tr></thead><tbody id="tasks-table-body"></tbody></table></div></section>
            <section id="view-settings" class="hidden"><h2>Configura√ß√µes</h2><div class="card" style="max-width: 400px; margin-top:20px;"><button class="btn btn-outline" style="width:100%; margin-bottom:15px;" onclick="app.toggleDarkMode()">üåì Alternar Tema</button><hr style="margin:20px 0; border:0; border-top:1px solid var(--border-color);"><h4 style="margin-bottom: 10px; font-size:0.9rem; color:var(--text-secondary);">Dados e Backup</h4><button class="btn btn-outline" style="width:100%; margin-bottom:10px; color: var(--info); border-color: var(--info);" onclick="app.exportBackup()">üíæ Salvar Backup (JSON)</button><button class="btn btn-outline" style="width:100%; margin-bottom:20px; color: var(--warning); border-color: var(--warning);" onclick="document.getElementById('import-file').click()">üìÇ Restaurar Backup</button><input type="file" id="import-file" style="display:none" accept=".json" onchange="app.importBackup(event)"><hr style="margin:20px 0; border:0; border-top:1px solid var(--border-color);"><button class="btn btn-danger" style="width:100%;" onclick="app.clearData()">‚ö†Ô∏è Limpar Todos os Dados</button></div></section>
            <section id="view-case-detail" class="hidden"><button class="btn btn-outline" onclick="app.navigate('cases')" style="margin-bottom:1rem;">‚Üê Voltar</button><div id="case-detail-content"></div></section>
        </div>

        <div id="status-menu" class="status-dropdown">
            <div class="status-option" onclick="app.changeStatus('Em andamento')"><div class="status-dot" style="background:#2563eb"></div>Em andamento</div>
            <div class="status-option" onclick="app.changeStatus('Suspenso')"><div class="status-dot" style="background:#f59e0b"></div>Suspenso</div>
            <div class="status-option" onclick="app.changeStatus('Finalizado')"><div class="status-dot" style="background:#10b981"></div>Finalizado</div>
            <div class="status-option" onclick="app.changeStatus('Arquivado')"><div class="status-dot" style="background:var(--text-secondary)"></div>Arquivado</div>
        </div>

        <div id="modal-import" class="modal">
            <div class="modal-content">
                <div class="flex-between" style="margin-bottom:20px;"><h3>Analisar Nova Publica√ß√£o</h3><button class="btn-outline btn-sm" style="border:none;" onclick="app.closeModal('modal-import')">‚úï</button></div>
                <input type="hidden" id="import-id">
                
                <div id="step-1-import">
                    <label style="color:var(--primary); font-weight:800; font-size:1rem;">PASSO 1: Publica√ß√£o Original</label>
                    <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:10px;">Cole o texto bruto retirado do Di√°rio Oficial.</p>
                    <textarea id="import-text" rows="5" placeholder="Cole o texto aqui..."></textarea>
                    
                    <div style="text-align:right; margin-top:10px; display:flex; justify-content:flex-end; gap:10px;">
                        <button class="btn" style="background: linear-gradient(135deg, #1d4ed8, #3b82f6); color:white;" onclick="app.analyzeWithAI('gemini')">‚ú® Gemini</button>
                        <button class="btn" style="background: linear-gradient(135deg, #10b981, #059669); color:white;" onclick="app.analyzeWithAI('chatgpt')">ü§ñ ChatGPT</button>
                    </div>

                    <hr style="margin: 25px 0; border:0; border-top:1px dashed var(--border-color)">
                    
                    <label style="color:var(--primary); font-weight:800; font-size:1rem;">PASSO 2: Resultado da IA</label>
                    <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:10px;">Ap√≥s copiar o resultado na IA, cole-o na caixa abaixo.</p>
                    <textarea id="ai-result-text" rows="6" placeholder="Cole o resultado estruturado gerado pela Intelig√™ncia Artificial..."></textarea>
                    <button class="btn btn-primary" style="width:100%; margin-top:10px; padding:15px; font-size:1rem;" onclick="app.parseAIResult()">ü™Ñ Extrair Dados e Salvar</button>
                </div>

                <div id="step-2-import" style="display:none;">
                    <div style="text-align:center; padding: 20px 0;">
                        <h3 style="color:var(--success); margin-bottom:10px;">‚úÖ An√°lise Extra√≠da com Sucesso!</h3>
                        <div id="match-info" style="font-size:0.95rem; color:var(--text-secondary);"></div>
                    </div>
                    <div style="text-align:right; margin-top:20px; display:flex; justify-content:space-between;">
                        <button class="btn btn-outline" onclick="app.backToStep1()">‚Üê Corrigir</button>
                        <button class="btn btn-primary" onclick="app.saveParsedImport()">üíæ Finalizar Registro</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal-publication-view" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="flex-between" style="margin-bottom:20px"><h3>Vis√£o Estrat√©gica</h3><button class="btn-outline btn-sm" style="border:none;" onclick="app.closeModal('modal-publication-view')">‚úï</button></div>
                <div class="pub-view-grid">
                    <div id="pub-view-summary"></div>
                    <div style="margin-top:20px;">
                        <label>Texto Original Di√°rio Oficial:</label>
                        <div class="pub-full-text" id="pub-view-text"></div>
                    </div>
                </div>
                <div style="margin-top:20px; text-align:right; border-top:1px solid var(--border-color); padding-top:20px;">
                    <button class="btn btn-primary" id="pub-view-action-btn">üìÖ Ir para Prazos</button>
                </div>
            </div>
        </div>

        <div id="modal-case" class="modal"><div class="modal-content"><div class="flex-between" style="margin-bottom:20px"><h3>Processo</h3><button class="btn-outline btn-sm" style="border:none;" onclick="app.closeModal('modal-case')">‚úï</button></div><form onsubmit="app.saveCase(event)"><input type="hidden" name="id"><div class="flex-gap"><div style="flex:1"><label>N√∫mero</label><input type="text" name="number" required></div><div style="flex:1"><label>Status</label><select name="status"><option>Em andamento</option><option>Suspenso</option><option>Finalizado</option><option>Arquivado</option></select></div></div><label>Cliente</label><input type="text" name="client" required><label>Adverso</label><input type="text" name="opponent"><div class="flex-gap"><div style="flex:1"><label>√Årea</label><select name="area">
            <option>C√≠vel</option>
            <option>Trabalhista</option>
            <option>Fam√≠lia e Sucess√µes</option>
            <option>Penal</option>
            <option>Previdenci√°rio</option>
            <option>Tribut√°rio</option>
            <option>Empresarial</option>
            <option>Consumidor</option>
            <option>Imobili√°rio</option>
            <option>Digital / Prote√ß√£o de Dados</option>
            <option>Outros</option>
        </select></div><div style="flex:1"><label>Valor da Causa (R$)</label><input type="number" name="value" step="0.01"></div></div>
        <div class="flex-gap"><div style="flex:1"><label>Data In√≠cio (Opcional)</label><input type="date" name="date_start"></div><div style="flex:1"><label>Honor√°rios (R$)</label><input type="number" name="fees" step="0.01"></div></div>
        <label>Advogado Respons√°vel</label><input type="text" name="lawyer">
        <label>Observa√ß√µes</label><textarea name="obs"></textarea>
        <button class="btn btn-primary" style="width:100%; margin-top:10px;">Salvar</button></form></div></div>
        
        <div id="modal-deadline" class="modal"><div class="modal-content"><div class="flex-between" style="margin-bottom:20px"><h3>Prazo</h3><button class="btn-outline btn-sm" style="border:none;" onclick="app.closeModal('modal-deadline')">‚úï</button></div><form onsubmit="app.saveDeadline(event)"><input type="hidden" name="id"><input type="hidden" name="caseId" id="deadline-case-id"><div id="case-selector-container" style="margin-bottom:1rem"><label>Processo</label><select id="case-select-dropdown" name="caseSelect" onchange="document.getElementById('deadline-case-id').value=this.value"><option value="">Selecione...</option></select></div><label>Tipo</label><input type="text" name="type" required><div class="flex-gap"><div style="flex:1"><label>Data In√≠cio</label><input type="date" name="date_start"></div><div style="flex:1"><label>Data Fatal</label><input type="date" name="date" required></div></div><button class="btn btn-primary" style="width:100%; margin-top:10px;">Salvar Prazo</button></form></div></div>

        <div id="modal-task" class="modal"><div class="modal-content"><div class="flex-between" style="margin-bottom:20px"><h3>Tarefa</h3><button class="btn-outline btn-sm" style="border:none;" onclick="app.closeModal('modal-task')">‚úï</button></div><form onsubmit="app.saveTask(event)"><input type="hidden" name="id"><label>V√≠nculo</label><select id="task-case-select" name="caseId"><option value="">Geral</option></select><label>Descri√ß√£o</label><input type="text" name="desc" required><div class="flex-gap"><div style="flex:1"><label>Prioridade</label><select name="priority"><option>Alta</option><option selected>M√©dia</option><option>Baixa</option></select></div><div style="flex:1"><label>Data</label><input type="date" name="date" required></div></div><button class="btn btn-primary" style="width:100%; margin-top:10px;">Adicionar</button></form></div></div>

        <div id="modal-payment" class="modal">
            <div class="modal-content">
                <div class="flex-between" style="margin-bottom:20px">
                    <h3>Novo Lan√ßamento</h3>
                    <button class="btn-outline btn-sm" style="border:none;" onclick="app.closeModal('modal-payment')">‚úï</button>
                </div>
                <form onsubmit="app.saveTransaction(event)">
                    <label>Processo / Cliente</label>
                    <select name="caseId" id="payment-case-select" required>
                        <option value="">Selecione...</option>
                    </select>
                    
                    <div class="flex-gap">
                        <div style="flex:1">
                            <label>Tipo</label>
                            <select name="type">
                                <option value="income">Recebimento (+)</option>
                                <option value="expense">Despesa (-)</option>
                            </select>
                        </div>
                        <div style="flex:1">
                            <label>Valor (R$)</label>
                            <input type="number" step="0.01" name="amount" required>
                        </div>
                    </div>
                    
                    <label>Descri√ß√£o do Lan√ßamento</label>
                    <input type="text" name="desc" placeholder="Ex: Custas, honor√°rios, dilig√™ncia..." required>
                    
                    <button class="btn btn-success" style="width:100%; margin-top:10px;">Registrar no Caixa</button>
                </form>
            </div>
        </div>

        <div id="modal-receipt-config" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="flex-between" style="margin-bottom:20px">
                    <h3>Configurar Recibo</h3>
                    <button class="btn-outline btn-sm" style="border:none;" onclick="app.closeModal('modal-receipt-config')">‚úï</button>
                </div>
                
                <label>Pagador (Nome do Cliente)</label>
                <input type="text" id="rcpt-client" list="rcpt-client-list" placeholder="Nome completo ou Raz√£o Social">
                <datalist id="rcpt-client-list"></datalist>
                
                <div class="flex-gap">
                    <div style="flex:1"><label>Valor (R$)</label><input type="number" id="rcpt-amount" step="0.01"></div>
                    <div style="flex:1"><label>Data</label><input type="date" id="rcpt-date"></div>
                </div>
                
                <label>Referente a</label>
                <textarea id="rcpt-desc" rows="3" placeholder="Ex: Honor√°rios advocat√≠cios referentes ao processo..."></textarea>
                
                <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="app.generateReceipt()">Visualizar Recibo</button>
            </div>
        </div>

        <div id="modal-receipt" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div id="receipt-content"></div>
                <div style="margin-top:20px; text-align:center; display:flex; gap:10px; justify-content:center;">
                    <button class="btn btn-primary" onclick="window.print()">üñ® Imprimir / Salvar PDF</button>
                    <button class="btn btn-outline" onclick="app.closeModal('modal-receipt')">Fechar</button>
                </div>
            </div>
        </div>

        <div id="modal-client-detail" class="modal"><div class="modal-content"><div class="flex-between" style="margin-bottom:20px;"><h3>Ficha</h3><button class="btn-outline btn-sm" style="border:none;" onclick="app.closeModal('modal-client-detail')">‚úï</button></div><div id="client-detail-body"></div></div></div>
        
        <div id="modal-day-details" class="modal"><div class="modal-content" style="max-width:500px"><div class="flex-between" style="margin-bottom:20px"><h3 id="day-details-title">Detalhes</h3><button class="btn-outline btn-sm" style="border:none;" onclick="app.closeModal('modal-day-details')">‚úï</button></div><div id="day-details-body"></div></div></div>
        
    </main>

    <script>
        const app = {
            data: { cases: [], deadlines: [], transactions: [], updates: [], tasks: [], settings: { theme: 'light' } },
            currentStatusId: null,
            tempParsedData: null,

            init() {
                this.loadData();
                if(localStorage.getItem('lexTheme') === 'dark') document.body.classList.add('dark-mode');
                this.renderDashboard();
                document.addEventListener('click', (e) => { 
                    if (!e.target.closest('.badge') && !e.target.closest('.status-dropdown')) {
                        document.getElementById('status-menu').classList.remove('show'); 
                    }
                });
            },

            analyzeWithAI(platform) {
                const textToAnalyze = document.getElementById('import-text').value;
                if (!textToAnalyze || !textToAnalyze.trim()) {
                    alert('‚ö†Ô∏è Cole o texto da publica√ß√£o no Passo 1 primeiro.');
                    return;
                }

                const geminiPrompt = `Analise a publica√ß√£o judicial abaixo e extraia as informa√ß√µes de forma ESTRUTURADA, EXTREMAMENTE CONCISA e DIRETA.

‚ö†Ô∏è REGRAS DE FORMATA√á√ÉO OBRIGAT√ìRIAS:
- N√ÉO USE formata√ß√£o Markdown (PROIBIDO usar asteriscos **, PROIBIDO usar bullet points como * ou -).
- Use APENAS texto puro.
- Siga rigorosamente os emojis de 1Ô∏è‚É£ a 9Ô∏è‚É£ para separa√ß√£o dos blocos.
- Responda exatamente no formato "Campo: Resposta curta" em linhas separadas.

1Ô∏è‚É£ Identifica√ß√£o do Processo
N√∫mero:
√ìrg√£o:
Tribunal:
Tipo de Justi√ßa:
Comunica√ß√£o:
Data de disponibiliza√ß√£o:
In√≠cio do prazo:

2Ô∏è‚É£ Partes do Processo
Autor:
R√©u:
Advogados:
Intimado:

3Ô∏è‚É£ Natureza do Ato Judicial
Classifica√ß√£o:
Explica√ß√£o:

4Ô∏è‚É£ Resumo Objetivo do Conte√∫do
Resumo:

5Ô∏è‚É£ Determina√ß√µes do Juiz
Determina√ß√£o:
Quem deve cumprir:
Prazo expresso:

6Ô∏è‚É£ Pedidos e Recursos Envolvidos
Recurso/Pedido:
Fase:

7Ô∏è‚É£ Prazo Fatal do Pr√≥ximo Passo
Ato a ser praticado:
Respons√°vel:
Prazo legal:
Data prov√°vel:
Risco:

8Ô∏è‚É£ Pr√≥ximo Cen√°rio Processual
Cen√°rio:

9Ô∏è‚É£ Resumo Para o Cliente
Resumo:

Segue a publica√ß√£o para an√°lise:
${textToAnalyze}`;

                navigator.clipboard.writeText(geminiPrompt).then(() => {
                    alert(`‚úÖ Prompt copiado com sucesso!\n\nEstou abrindo o ${platform === 'gemini' ? 'Gemini' : 'ChatGPT'}. Cole o texto l√° (Ctrl+V), aguarde a resposta e copie o resultado de volta para o Passo 2.`);
                    if(platform === 'gemini') window.open('https://gemini.google.com/app', '_blank');
                    else window.open('https://chatgpt.com', '_blank');
                }).catch(err => {
                    console.error('Falha ao copiar:', err);
                    alert('Seu navegador bloqueou a c√≥pia autom√°tica. Verifique as permiss√µes.');
                });
            },

            parseAIResult() {
                const aiResult = document.getElementById('ai-result-text').value;
                const rawImport = document.getElementById('import-text').value;

                if(!aiResult.trim()) return alert("Cole o resultado gerado pela IA na caixa do Passo 2.");

                const extract = (current, next) => {
                    let regexStr = current + "([\\s\\S]*?)";
                    regexStr += next ? "(?=" + next + "|$)" : "(?=$)";
                    const match = aiResult.match(new RegExp(regexStr));
                    if(match) {
                        let block = match[1].trim();
                        block = block.replace(/^[^\n]*\n/, '').replace(/\*\*/g, '').replace(/^\s*[\*\-]\s/gm, '').trim(); 
                        return block;
                    }
                    return '-';
                };

                const b1 = extract('1Ô∏è‚É£', '2Ô∏è‚É£');
                const b2 = extract('2Ô∏è‚É£', '3Ô∏è‚É£');
                const b3 = extract('3Ô∏è‚É£', '4Ô∏è‚É£');
                const b4 = extract('4Ô∏è‚É£', '5Ô∏è‚É£');
                const b5 = extract('5Ô∏è‚É£', '6Ô∏è‚É£');
                const b6 = extract('6Ô∏è‚É£', '7Ô∏è‚É£');
                const b7 = extract('7Ô∏è‚É£', '8Ô∏è‚É£');
                const b8 = extract('8Ô∏è‚É£', '9Ô∏è‚É£');
                const b9 = extract('9Ô∏è‚É£', '‚öñÔ∏è');

                const caseMatch = (b1 + rawImport).match(/\d{7}-\d{2}\.\d{4}\.\d\.\d{2}\.\d{4}/);
                const caseNum = caseMatch ? caseMatch[0] : '';
                
                const autorMatch = b2.match(/Autor:\s*([^\n]+)/i);
                const reuMatch = b2.match(/R√©u:\s*([^\n]+)/i);
                const extractedAutor = autorMatch ? autorMatch[1].trim() : '';
                const extractedReu = reuMatch ? reuMatch[1].trim() : '';

                const dateMatch = b1.match(/Data de disponibiliza√ß√£o:\s*(\d{2})\/(\d{2})\/(\d{4})/i);
                let dispDate = null;
                if(dateMatch) {
                    dispDate = new Date(`${dateMatch[3]}-${dateMatch[2]}-${dateMatch[1]}T12:00:00`).toISOString();
                }

                let matchedId = null;
                if(caseNum) {
                    const found = this.data.cases.find(c => c.number === caseNum);
                    if(found) matchedId = found.id;
                }

                let outcomeLabel = "Movimenta√ß√£o";
                if(/deferi/i.test(b4) || /procedente/i.test(b4)) outcomeLabel = "Deferido / Procedente";
                if(/indeferi/i.test(b4) || /improcedente/i.test(b4)) outcomeLabel = "Indeferido / Improcedente";

                this.tempParsedData = {
                    rawText: rawImport,
                    caseNumber: caseNum,
                    matchedCaseId: matchedId,
                    extractedAutor: extractedAutor,
                    extractedReu: extractedReu,
                    dispDate: dispDate,
                    type: b3.split('\n')[0].replace('Classifica√ß√£o:', '').trim().substring(0, 40) || 'Ato Judicial', 
                    outcome: outcomeLabel,
                    blocks: { b1, b2, b3, b4, b5, b6, b7, b8, b9 }
                };

                const matchDiv = document.getElementById('match-info');
                if(matchedId) {
                    matchDiv.innerHTML = `Processo identificado automaticamente na base: <b style="color:var(--text-main)">${caseNum}</b>. Ser√° vinculado ao dossi√™.`;
                } else if(caseNum) {
                    matchDiv.innerHTML = `Processo <b style="color:var(--text-main)">${caseNum}</b> n√£o encontrado na base. Um novo caso ser√° criado com Autor(a): <b style="color:var(--text-main)">${extractedAutor || 'Desconhecido'}</b> e R√©u: <b style="color:var(--text-main)">${extractedReu || 'Desconhecido'}</b>.`;
                } else {
                    matchDiv.innerHTML = `Processo n√£o identificado. Ficar√° registrado como an√°lise avulsa.`;
                }

                document.getElementById('step-1-import').style.display = 'none';
                document.getElementById('step-2-import').style.display = 'block';
            },

            saveParsedImport() {
                if(!this.tempParsedData) return;
                
                let cid = this.tempParsedData.matchedCaseId;
                
                if(!cid && this.tempParsedData.caseNumber) {
                    const newCase = { 
                        id: Date.now(), 
                        number: this.tempParsedData.caseNumber, 
                        client: this.tempParsedData.extractedAutor || "Cliente N√£o Identificado", 
                        opponent: this.tempParsedData.extractedReu || "-", 
                        area: 'C√≠vel', 
                        status: 'Em andamento', 
                        date_created: new Date().toISOString() 
                    };
                    this.data.cases.push(newCase); 
                    cid = newCase.id;
                }

                const isEditId = document.getElementById('import-id').value;
                const updatePayload = {
                    id: isEditId ? parseInt(isEditId) : Date.now(),
                    date: this.tempParsedData.dispDate || new Date().toISOString(),
                    rawText: this.tempParsedData.rawText,
                    caseId: cid,
                    analysis: {
                        caseNumber: this.tempParsedData.caseNumber,
                        type: this.tempParsedData.type,
                        outcome: this.tempParsedData.outcome,
                        blocks: this.tempParsedData.blocks
                    }
                };

                if(isEditId) {
                    const idx = this.data.updates.findIndex(u => u.id == isEditId);
                    if(idx > -1) {
                        updatePayload.date = this.tempParsedData.dispDate || this.data.updates[idx].date;
                        this.data.updates[idx] = updatePayload;
                    }
                } else {
                    this.data.updates.unshift(updatePayload);
                }
                
                this.saveToStorage(); 
                
                document.getElementById('import-text').value = '';
                document.getElementById('ai-result-text').value = '';
                document.getElementById('import-id').value = '';
                this.tempParsedData = null;
                
                this.closeModal('modal-import'); 
                this.navigate('updates'); 
                this.backToStep1();

                if(confirm('Deseja agendar um Prazo relacionado a esta publica√ß√£o agora mesmo?')) {
                    this.openModal('modal-deadline', cid);
                }
            },

            backToStep1() {
                document.getElementById('step-1-import').style.display = 'block';
                document.getElementById('step-2-import').style.display = 'none';
            },

            viewPublication(id) {
                const pub = this.data.updates.find(u => u.id === id); 
                if(!pub) return;
                const b = pub.analysis.blocks || {};
                
                const formatBlock = (text) => {
                    if(!text) return '-';
                    return text.replace(/^([^:\n]+):/gm, '<span style="color:var(--primary); font-weight:700;">$1:</span>');
                };
                
                const summaryHtml = `
                    <div style="display:flex; flex-direction:column; gap:15px;">
                        <div class="analysis-grid">
                            <div class="analysis-item"><span class="analysis-label">1Ô∏è‚É£ Identifica√ß√£o</span><span class="analysis-val">${formatBlock(b.b1) || pub.analysis.caseNumber || '-'}</span></div>
                            <div class="analysis-item"><span class="analysis-label">2Ô∏è‚É£ Partes</span><span class="analysis-val">${formatBlock(b.b2) || '-'}</span></div>
                            <div class="analysis-item"><span class="analysis-label">3Ô∏è‚É£ Natureza</span><span class="analysis-val">${formatBlock(b.b3) || pub.analysis.type}</span></div>
                            <div class="analysis-item"><span class="analysis-label">4Ô∏è‚É£ Resumo</span><span class="analysis-val">${formatBlock(b.b4) || '-'}</span></div>
                        </div>
                        <div style="background: var(--bg-body); padding: 15px; border-radius: var(--radius-md);">
                            <span class="analysis-label">5Ô∏è‚É£ Determina√ß√µes do Juiz</span>
                            <div style="margin-top:8px; font-size:0.95rem; color:var(--text-main); white-space:pre-wrap; line-height: 1.5;">${formatBlock(b.b5)}</div>
                        </div>
                        <div style="background: var(--bg-body); padding: 15px; border-radius: var(--radius-md);">
                            <span class="analysis-label">6Ô∏è‚É£ Pedidos e Recursos</span>
                            <div style="margin-top:8px; font-size:0.95rem; color:var(--text-main); white-space:pre-wrap; line-height: 1.5;">${formatBlock(b.b6)}</div>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                            <div style="background:var(--bg-body); padding:15px; border-radius:var(--radius-md); border-top: 4px solid var(--danger);">
                                <span class="analysis-label" style="color:var(--danger)">7Ô∏è‚É£ Prazo Fatal</span>
                                <div style="margin-top:8px; font-size:0.95rem; white-space:pre-wrap; color:var(--text-main);">${formatBlock(b.b7)}</div>
                            </div>
                            <div style="background:var(--bg-body); padding:15px; border-radius:var(--radius-md); border-top: 4px solid var(--info);">
                                <span class="analysis-label">8Ô∏è‚É£ Pr√≥ximo Cen√°rio</span>
                                <div style="margin-top:8px; font-size:0.95rem; white-space:pre-wrap; color:var(--text-main);">${formatBlock(b.b8)}</div>
                            </div>
                        </div>
                        <div class="client-summary-box">
                            <b>9Ô∏è‚É£ Resumo para o Cliente (Copie e envie no WhatsApp):</b><br><br>
                            <span style="white-space:pre-wrap; font-style: normal; font-size:1rem; color:var(--text-main);">${(b.b9 || '').replace(/^Resumo:/i, '').trim() || '-'}</span>
                        </div>
                    </div>
                `;
                
                document.getElementById('pub-view-summary').innerHTML = summaryHtml;
                document.getElementById('pub-view-text').innerText = pub.rawText || 'Texto original n√£o salvo.';
                
                const btn = document.getElementById('pub-view-action-btn');
                btn.onclick = () => { 
                    this.closeModal('modal-publication-view'); 
                    this.openModal('modal-deadline', pub.caseId); 
                };
                
                document.getElementById('modal-publication-view').classList.add('active');
            },

            editUpdate(id) {
                const u = this.data.updates.find(x => x.id === id); 
                if(!u) return;
                document.getElementById('import-id').value = u.id; 
                document.getElementById('import-text').value = u.rawText;
                
                const b = u.analysis.blocks;
                const rebuilt = `1Ô∏è‚É£\n${b.b1}\n2Ô∏è‚É£\n${b.b2}\n3Ô∏è‚É£\n${b.b3}\n4Ô∏è‚É£\n${b.b4}\n5Ô∏è‚É£\n${b.b5}\n6Ô∏è‚É£\n${b.b6}\n7Ô∏è‚É£\n${b.b7}\n8Ô∏è‚É£\n${b.b8}\n9Ô∏è‚É£\n${b.b9}`;
                document.getElementById('ai-result-text').value = rebuilt;
                
                document.getElementById('modal-import').classList.add('active');
            },

            deleteUpdate(id) { 
                if(confirm('Tem certeza que deseja excluir esta publica√ß√£o do sistema?')) { 
                    this.data.updates = this.data.updates.filter(u => u.id !== id); 
                    this.saveToStorage(); 
                    this.renderUpdatesFull(); 
                } 
            },

            renderUpdatesFull() { 
                const c = document.getElementById('updates-list-full'); 
                c.innerHTML = ''; 
                if(this.data.updates.length === 0) {
                    c.innerHTML = '<p style="color:var(--text-muted)">Nenhuma publica√ß√£o analisada ainda.</p>';
                    return;
                }
                
                this.data.updates.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(u => { 
                    const a = u.analysis || {};
                    let outcomeColor = (a.outcome||'').toLowerCase().includes('deferido') ? 'style="background:var(--success); color:white;"' : ((a.outcome||'').toLowerCase().includes('indeferido') ? 'style="background:var(--danger); color:white;"' : 'class="tag-blue"');
                    
                    const caseRef = this.data.cases.find(caseItem => caseItem.id === u.caseId);
                    const clientName = caseRef ? caseRef.client : "Cliente N√£o Vinculado";

                    c.innerHTML += `
                        <div class="smart-summary" onclick="app.viewPublication(${u.id})">
                            <div class="summary-header">
                                <span style="font-size:1.1rem; font-weight:800; color:var(--text-main);">${a.type || 'Ato Judicial'}</span> 
                                <span class="summary-tag" ${outcomeColor}>${a.outcome || 'Movimenta√ß√£o'}</span>
                            </div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px; font-size:0.9rem;">
                                <div><b style="color:var(--text-secondary)">Processo:</b> ${a.caseNumber || 'N/A'}</div>
                                <div><b style="color:var(--text-secondary)">Cliente:</b> <span style="color:var(--primary); font-weight:600;">${clientName}</span></div>
                                <div><b style="color:var(--text-secondary)">Publicado em:</b> ${new Date(u.date).toLocaleDateString('pt-BR')}</div>
                            </div>
                            <div style="background:var(--bg-body); padding:15px; border-radius:var(--radius-md); border-left:4px solid var(--primary); font-size:0.95rem; line-height:1.5;">
                                <b>Resumo T√©cnico:</b><br> ${(a.blocks && a.blocks.b4) ? a.blocks.b4.substring(0, 200) + '...' : 'Sem resumo.'}
                            </div>
                            <div style="margin-top:20px; text-align:right; border-top:1px solid var(--border-color); padding-top:15px;">
                                <button class="btn btn-outline btn-sm" onclick="event.stopPropagation(); app.editUpdate(${u.id})">‚úèÔ∏è Editar</button> 
                                <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); app.deleteUpdate(${u.id})">üóë Excluir</button>
                            </div>
                        </div>`; 
                }); 
            },

            exportBackup() {
                const dataStr = JSON.stringify(this.data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `LexManager_Backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },

            importBackup(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData && importedData.cases !== undefined) {
                            if (confirm('Aten√ß√£o: Restaurar o backup substituir√° todos os dados atuais na sua tela. Deseja continuar?')) {
                                this.data = importedData;
                                this.saveToStorage();
                                alert('‚úÖ Backup restaurado com sucesso! A p√°gina ser√° recarregada.');
                                location.reload();
                            }
                        } else {
                            alert('‚ùå Arquivo de backup inv√°lido. N√£o parece ser um backup do LexManager.');
                        }
                    } catch (err) {
                        alert('‚ùå Erro ao ler o arquivo. Certifique-se de que √© um arquivo JSON v√°lido.');
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            },

            fixDate(dateStr) { if(!dateStr) return null; return new Date(dateStr + 'T12:00:00'); },
            toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); },
            navigate(view) {
                document.querySelectorAll('main section').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
                const sec = document.getElementById(`view-${view}`); if(sec) sec.classList.remove('hidden');
                const navBtn = document.getElementById(view === 'case-detail' ? 'nav-cases' : `nav-${view}`);
                if(navBtn) navBtn.classList.add('active');
                document.getElementById('sidebar').classList.remove('active');
                
                if(view === 'dashboard') this.renderDashboard(); 
                if(view === 'updates') this.renderUpdatesFull(); 
                if(view === 'cases') this.renderCases(); 
                if(view === 'deadlines') this.renderDeadlines(); 
                if(view === 'finance') this.renderFinance(); 
                if(view === 'tasks') this.renderTasks(); 
                if(view === 'clients') this.renderClients();
            },
            
            renderDashboard() {
                const active = this.data.cases.filter(c => c.status === 'Em andamento'); 
                document.getElementById('dash-active').innerText = active.length;
                
                let totalIncome = 0; let totalExpense = 0;
                this.data.transactions.forEach(t => { 
                    if (t.type === 'income') totalIncome += (parseFloat(t.amount) || 0); 
                    if (t.type === 'expense') totalExpense += (parseFloat(t.amount) || 0); 
                }); 
                const netBalance = totalIncome - totalExpense;
                const balanceEl = document.getElementById('dash-finance-received');
                balanceEl.innerText = this.formatCurrency(netBalance);
                balanceEl.className = `stat-value ${netBalance >= 0 ? 'text-success' : 'text-danger'}`;
                
                const today = new Date(); 
                today.setHours(0,0,0,0);
                
                const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"]; 
                document.getElementById('calendar-month-label').innerText = `${monthNames[today.getMonth()]} ${today.getFullYear()}`;
                
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1); 
                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                
                const grid = document.getElementById('calendar-grid-content'); 
                grid.innerHTML = '';
                for(let i=0; i<firstDay.getDay(); i++) grid.innerHTML += `<div></div>`;
                
                for(let i=1; i<=lastDay.getDate(); i++) {
                    const currentDateStr = new Date(today.getFullYear(), today.getMonth(), i).toDateString();
                    
                    const deadlinesToday = this.data.deadlines.filter(d => new Date(d.date).toDateString() === currentDateStr && !d.done);
                    const tasksToday = this.data.tasks.filter(t => new Date(t.date).toDateString() === currentDateStr && !t.done);
                    const updatesToday = this.data.updates.filter(u => new Date(u.date).toDateString() === currentDateStr);
                    
                    let dotsHtml = '<div class="calendar-dots">'; 
                    deadlinesToday.slice(0,3).forEach(() => dotsHtml += '<div class="calendar-dot dot-deadline"></div>'); 
                    tasksToday.slice(0,3).forEach(() => dotsHtml += '<div class="calendar-dot dot-task"></div>'); 
                    updatesToday.slice(0,3).forEach(() => dotsHtml += '<div class="calendar-dot dot-publication"></div>'); 
                    dotsHtml += '</div>';
                    
                    grid.innerHTML += `<div class="calendar-day ${i === today.getDate() ? 'today' : ''}" onclick="app.showDayDetails(${i}, ${today.getMonth()}, ${today.getFullYear()})"><span>${i}</span> ${dotsHtml}</div>`;
                }
                
                const list = document.getElementById('calendar-list-content'); 
                list.innerHTML = ''; let agendaItems = [];
                
                this.data.deadlines.filter(d => !d.done && new Date(d.date) >= today).forEach(d => {
                    const c = this.data.cases.find(x => x.id == d.caseId);
                    agendaItems.push({type:'deadline', date:d.date, title:d.type, sub: c ? c.client : 'Sem v√≠nculo', id:d.caseId});
                });
                
                this.data.tasks.filter(t => !t.done && new Date(t.date) >= today).forEach(t => {
                    const c = this.data.cases.find(x => x.id == t.caseId);
                    agendaItems.push({type:'task', date:t.date, title:t.desc, sub: c ? c.client : 'Geral', id:t.id});
                });

                this.data.updates.filter(u => new Date(u.date) >= today).slice(0,5).forEach(u => {
                    const c = this.data.cases.find(x => x.id == u.caseId);
                    agendaItems.push({type:'update', date:u.date, title:u.analysis.type || 'Decis√£o', sub: c ? c.client : 'S/ V√≠nculo', id:u.id});
                });
                
                agendaItems.sort((a,b)=>new Date(a.date)-new Date(b.date));
                
                if(agendaItems.length === 0) { 
                    list.innerHTML = '<div style="padding:20px 10px;text-align:center;color:var(--text-muted)">A agenda est√° livre no momento.</div>'; 
                } else { 
                    agendaItems.slice(0,6).forEach(item => { 
                        const icon = item.type==='deadline' ? '‚è≥' : (item.type==='task' ? 'üìù' : 'üìú'); 
                        const color = item.type==='deadline' ? 'var(--danger)' : (item.type==='task' ? 'var(--info)' : 'var(--warning)'); 
                        const clickAction = item.type==='update' ? `app.viewPublication(${item.id})` : `app.navigate('${item.type==='deadline'?'deadlines':'tasks'}')`; 
                        
                        list.innerHTML += `<div style="padding:12px; border-radius:var(--radius-md); background:var(--bg-body); margin-bottom:10px; cursor:pointer; transition:0.2s;" onclick="${clickAction}"><div style="font-weight:700; font-size:0.9rem; color:${color}; margin-bottom:4px;">${icon} ${item.title}</div><div style="font-size:0.8rem; color:var(--text-secondary); font-weight:500;">${new Date(item.date).toLocaleDateString('pt-BR').slice(0,5)} ‚Ä¢ ${item.sub}</div></div>`; 
                    }); 
                }
                
                document.getElementById('dash-today').innerText = this.data.deadlines.filter(d => {
                    const dDate = new Date(d.date);
                    return !d.done && dDate.getDate() === today.getDate() && dDate.getMonth() === today.getMonth() && dDate.getFullYear() === today.getFullYear();
                }).length;
            },
            
            showDayDetails(day, month, year) {
                const events = [];
                const targetDateStr = new Date(year, month, day).toDateString();
                
                this.data.deadlines.forEach(d => { 
                    if(new Date(d.date).toDateString() === targetDateStr) { 
                        const c = this.data.cases.find(x => x.id == d.caseId); 
                        events.push({ type: 'deadline', title: d.type, sub: c ? c.client : 'Sem v√≠nculo', done: d.done, id: d.id }); 
                    } 
                });
                this.data.tasks.forEach(t => { 
                    if(new Date(t.date).toDateString() === targetDateStr) { 
                        const c = this.data.cases.find(x => x.id == t.caseId);
                        events.push({ type: 'task', title: t.desc, sub: c ? c.client : `Tarefa Geral - ${t.priority}`, done: t.done, id: t.id }); 
                    } 
                });
                this.data.updates.forEach(u => {
                    if(new Date(u.date).toDateString() === targetDateStr) {
                        const c = this.data.cases.find(x => x.id == u.caseId);
                        events.push({ type: 'update', title: u.analysis?.type || 'Publica√ß√£o', sub: c ? c.client : 'Sem v√≠nculo', done: true, id: u.id });
                    }
                });
                
                const body = document.getElementById('day-details-body'); 
                document.getElementById('day-details-title').innerText = `Agenda: ${String(day).padStart(2,'0')}/${String(month+1).padStart(2,'0')}/${year}`;
                
                if(events.length === 0) { 
                    body.innerHTML = '<p style="color:var(--text-muted); text-align:center; padding:20px 0;">Nenhum evento registrado.</p>'; 
                } else { 
                    body.innerHTML = events.map(e => {
                        let icon = 'üìù'; let color = 'var(--info)';
                        if(e.type === 'deadline') { icon = '‚è≥'; color = 'var(--danger)'; }
                        if(e.type === 'update') { icon = 'üìú'; color = 'var(--warning)'; }
                        
                        let actionBtn = '';
                        if(e.type !== 'update') {
                            actionBtn = `<button class="btn btn-sm ${e.done?'btn-success':'btn-outline'}" onclick="app.${e.type==='deadline'?'toggleDeadline':'toggleTask'}(${e.id}); app.showDayDetails(${day},${month},${year})">${e.done?'Desfazer':'Concluir'}</button>`;
                        } else {
                            actionBtn = `<button class="btn btn-sm btn-outline" onclick="app.closeModal('modal-day-details'); app.viewPublication(${e.id})">Visualizar</button>`;
                        }

                        return `<div style="padding:15px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center; background:var(--bg-body); border-radius:var(--radius-md); margin-bottom:8px;"><div><div style="font-weight:700; color:${color}; text-decoration:${(e.done && e.type !== 'update')?'line-through':'none'}">${icon} ${e.title}</div><div style="font-size:0.85rem; color:var(--text-secondary); margin-top:4px;">${e.sub}</div></div><div style="display:flex; gap:5px;">${actionBtn}</div></div>`;
                    }).join(''); 
                }
                document.getElementById('modal-day-details').classList.add('active');
            },

            openStatusMenu(el, id) { this.currentStatusId = id; const m = document.getElementById('status-menu'); const r = el.getBoundingClientRect(); m.style.top = (r.bottom + window.scrollY + 8) + 'px'; m.style.left = r.left + 'px'; m.classList.add('show'); },
            changeStatus(st) { if(this.currentStatusId) { const i = this.data.cases.findIndex(c=>c.id===this.currentStatusId); if(i>-1) { this.data.cases[i].status=st; this.saveToStorage(); this.renderCases(); document.getElementById('status-menu').classList.remove('show'); } } },
            
            openModal(id, dataId = null) { 
                document.getElementById(id).classList.add('active'); 
                const form = document.querySelector(`#${id} form`); 
                if(form) form.reset(); 
                
                if(id==='modal-case' && dataId) { 
                    const c = this.data.cases.find(x=>x.id===dataId); 
                    if(c){ 
                        document.querySelector('[name="id"]').value=c.id; 
                        document.querySelector('[name="number"]').value=c.number; 
                        document.querySelector('[name="client"]').value=c.client; 
                        document.querySelector('[name="status"]').value=c.status; 
                        document.querySelector('[name="opponent"]').value=c.opponent||''; 
                        document.querySelector('[name="area"]').value=c.area||'C√≠vel'; 
                        document.querySelector('[name="value"]').value=c.value||''; 
                        document.querySelector('[name="fees"]').value=c.fees||''; 
                        document.querySelector('[name="lawyer"]').value=c.lawyer||''; 
                        document.querySelector('[name="obs"]').value=c.obs||''; 
                        if(c.date_start) document.querySelector('[name="date_start"]').value=c.date_start.split('T')[0];
                    } 
                } 
                
                if(id==='modal-deadline' || id==='modal-task' || id==='modal-payment') { 
                    let selId = '';
                    if(id==='modal-deadline') selId = 'case-select-dropdown';
                    else if(id==='modal-task') selId = 'task-case-select';
                    else if(id==='modal-payment') selId = 'payment-case-select';

                    const sel = document.getElementById(selId); 
                    sel.innerHTML = id==='modal-task' ? '<option value="">Geral (Sem v√≠nculo)</option>' : '<option value="">Selecione um processo...</option>'; 
                    
                    this.data.cases.forEach(x=>sel.add(new Option(`${x.client} - ${x.number}`, x.id))); 
                    
                    if(dataId && typeof dataId === 'number') { 
                        if(id==='modal-payment') {
                            sel.value = dataId;
                        } else {
                            const item = id==='modal-deadline'?this.data.deadlines.find(x=>x.id===dataId):this.data.tasks.find(x=>x.id===dataId); 
                            if(item) { 
                                document.querySelector(`#${id} [name="id"]`).value=item.id; 
                                if(item.caseId) sel.value=item.caseId; 
                            }
                        }
                    } else if (dataId && id==='modal-deadline') { 
                        document.getElementById('deadline-case-id').value=dataId; 
                        document.getElementById('case-selector-container').style.display='none'; 
                    } else { 
                        if(id==='modal-deadline') document.getElementById('case-selector-container').style.display='block'; 
                    } 
                } 
            },
            
            closeModal(id) { document.getElementById(id).classList.remove('active'); },
            
            saveCase(e) { 
                e.preventDefault(); 
                const f = new FormData(e.target); 
                const id = f.get('id'); 
                
                const d = { 
                    number: f.get('number'), 
                    client: f.get('client'), 
                    opponent: f.get('opponent'), 
                    status: f.get('status'), 
                    area: f.get('area'), 
                    value: parseFloat(f.get('value')||0), 
                    fees: parseFloat(f.get('fees')||0), 
                    obs: f.get('obs'), 
                    lawyer: f.get('lawyer'), 
                    date_start: f.get('date_start') ? this.fixDate(f.get('date_start')).toISOString() : null
                }; 
                
                if(id){ 
                    const i = this.data.cases.findIndex(c=>c.id==id); 
                    this.data.cases[i]={...this.data.cases[i],...d}; 
                } else { 
                    this.data.cases.push({...d, id:Date.now(), date_created:new Date().toISOString()}); 
                } 
                
                this.saveToStorage(); 
                this.closeModal('modal-case'); 
                this.navigate('cases'); 
            },
            
            saveDeadline(e) { e.preventDefault(); const f = new FormData(e.target); const cid = f.get('caseId')||f.get('caseSelect'); if(!cid) return alert('Selecione um processo.'); this.data.deadlines.push({ id: Date.now(), caseId: parseInt(cid), type: f.get('type'), date: this.fixDate(f.get('date')).toISOString(), done: false }); this.saveToStorage(); this.closeModal('modal-deadline'); this.navigate('deadlines'); },
            saveTask(e) { e.preventDefault(); const f = new FormData(e.target); this.data.tasks.push({ id: Date.now(), desc: f.get('desc'), priority: f.get('priority'), date: this.fixDate(f.get('date')).toISOString(), caseId: document.getElementById('task-case-select').value, done: false }); this.saveToStorage(); this.closeModal('modal-task'); this.navigate('tasks'); },
            
            saveTransaction(e) { 
                e.preventDefault(); 
                const f = new FormData(e.target); 
                this.data.transactions.push({ 
                    id: Date.now(), 
                    caseId: parseInt(f.get('caseId')), 
                    type: f.get('type'), 
                    amount: parseFloat(f.get('amount')),
                    desc: f.get('desc')
                }); 
                this.saveToStorage(); 
                this.closeModal('modal-payment'); 
                this.navigate('finance'); 
            },

            deleteTransaction(id) {
                if(confirm('Tem certeza que deseja excluir este lan√ßamento permanentemente?')) {
                    this.data.transactions = this.data.transactions.filter(t => t.id !== id);
                    this.saveToStorage();
                    this.navigate('finance');
                }
            },

            renderCases() { const t = document.getElementById('cases-table-body'); t.innerHTML = ''; const s = document.getElementById('search-case') ? document.getElementById('search-case').value.toLowerCase() : ''; const fl = document.getElementById('filter-lawyer') ? document.getElementById('filter-lawyer').value : ''; const fa = document.getElementById('filter-area') ? document.getElementById('filter-area').value : ''; this.data.cases.filter(c => (c.client.toLowerCase().includes(s) || c.number.includes(s)) && (fl === "" || c.lawyer === fl) && (fa === "" || c.area === fa) ).forEach(c => { let bg = c.status === 'Em andamento' ? 'badge-blue' : (c.status === 'Finalizado' ? 'badge-green' : 'badge-gray'); t.innerHTML += `<tr><td style="font-family:monospace; font-size:0.95rem;"><span class="clickable-link" onclick="app.openCaseDetail(${c.id})">${c.number}</span></td><td style="font-weight:600;">${c.client}</td><td>${c.area}</td><td><span class="badge ${bg}" onclick="app.openStatusMenu(this,${c.id})">${c.status} ‚ñæ</span></td><td><button class="btn btn-outline btn-sm" onclick="app.openModal('modal-case',${c.id})">‚úèÔ∏è</button></td></tr>`; }); },
            renderDeadlines() { const t = document.getElementById('deadlines-table-body'); t.innerHTML = ''; this.data.deadlines.sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(d => { const c = this.data.cases.find(x=>x.id==d.caseId); t.innerHTML += `<tr><td style="font-weight:700; color:${d.done ? 'var(--text-muted)' : 'var(--danger)'}; text-decoration:${d.done?'line-through':'none'}">${new Date(d.date).toLocaleDateString('pt-BR')}</td><td><span class="badge badge-gray">${d.type}</span></td><td>${c ? `<span class="clickable-link" onclick="app.openCaseDetail(${c.id})">${c.client}</span>` : '-'}</td><td>${d.done ? '<span class="badge badge-green">Conclu√≠do</span>' : '<span class="badge badge-red">Pendente</span>'}</td><td><button class="btn btn-outline btn-sm" onclick="app.toggleDeadline(${d.id})">${d.done ? 'Desfazer' : 'Concluir'}</button> <button class="btn btn-danger btn-sm" onclick="app.deleteDeadline(${d.id})">üóë</button></td></tr>`; }); },
            renderTasks() { const t = document.getElementById('tasks-table-body'); t.innerHTML = ''; this.data.tasks.sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(tsk => { const c = this.data.cases.find(x=>x.id==tsk.caseId); let badgeClass = tsk.priority === 'Alta' ? 'badge-red' : (tsk.priority === 'M√©dia' ? 'badge-yellow' : 'badge-blue'); t.innerHTML += `<tr><td><span class="badge ${badgeClass}">${tsk.priority}</span></td><td style="font-weight:600; text-decoration:${tsk.done?'line-through':'none'}; color:${tsk.done?'var(--text-muted)':'var(--text-main)'}">${tsk.desc}</td><td>${c ? `<span class="clickable-link" onclick="app.openCaseDetail(${c.id})">${c.client}</span>` : '<span style="color:var(--text-muted)">Geral</span>'}</td><td>${new Date(tsk.date).toLocaleDateString('pt-BR')}</td><td><button class="btn btn-outline btn-sm" onclick="app.toggleTask(${tsk.id})">${tsk.done ? 'Reabrir' : 'Feito'}</button></td></tr>`; }); },
            renderClients() { const t = document.getElementById('clients-table-body'); t.innerHTML = ''; const cs = {}; this.data.cases.forEach(c => { if(!cs[c.client]) cs[c.client] = {name:c.client, count:0, val:0}; if(c.status==='Em andamento') cs[c.client].count++; cs[c.client].val += (parseFloat(c.value)||0); }); Object.values(cs).forEach(cl => { t.innerHTML += `<tr><td><span class="clickable-link" onclick="app.openClientDetail('${cl.name}')">${cl.name}</span></td><td><span class="badge badge-blue">${cl.count}</span> ativos</td><td style="font-weight:600;">${this.formatCurrency(cl.val)}</td><td><button class="btn btn-danger btn-sm" onclick="app.deleteClient('${cl.name}')">üóë</button></td></tr>`; }); },
            
            renderFinance() { 
                const t = document.getElementById('finance-table-body'); 
                const ledger = document.getElementById('finance-ledger-body');
                t.innerHTML = ''; 
                ledger.innerHTML = '';

                let totalIn = 0, totalOut = 0, totalPending = 0; 

                this.data.cases.forEach(c => { 
                    const p = this.data.transactions.filter(x=>x.caseId==c.id && x.type=='income').reduce((a,b)=>a+(parseFloat(b.amount)||0),0); 
                    const b = (parseFloat(c.fees)||0) - p; 
                    totalPending += (b > 0 ? b : 0);
                    
                    t.innerHTML += `<tr>
                        <td><span class="clickable-link" onclick="app.openCaseDetail(${c.id})">${c.client}</span><br><small style="color:var(--text-muted)">${c.number}</small></td>
                        <td>${this.formatCurrency(c.fees||0)}</td>
                        <td><span class="clickable-link text-success" onclick="app.openReceiptConfig(null, ${c.id})" style="font-weight:700;">${this.formatCurrency(p)}</span></td>
                        <td style="color:${b > 0 ? 'var(--warning)' : 'inherit'}; font-weight:${b > 0 ? '700' : 'normal'}">${this.formatCurrency(b)}</td>
                        <td style="display:flex; gap:8px;">
                            <button class="btn btn-outline btn-sm" onclick="app.openModal('modal-payment',${c.id})">‚ûï Lan√ßar</button>
                            <button class="btn btn-primary btn-sm" onclick="app.openReceiptConfig(null, ${c.id})">üìÑ Recibo</button>
                        </td>
                    </tr>`; 
                }); 

                this.data.transactions.forEach(tx => {
                    if (tx.type === 'income') totalIn += parseFloat(tx.amount) || 0;
                    if (tx.type === 'expense') totalOut += parseFloat(tx.amount) || 0;
                });
                const balance = totalIn - totalOut;

                if(document.getElementById('fin-received')) document.getElementById('fin-received').innerText = this.formatCurrency(totalIn); 
                if(document.getElementById('fin-pending')) document.getElementById('fin-pending').innerText = this.formatCurrency(totalPending); 
                if(document.getElementById('fin-expenses')) document.getElementById('fin-expenses').innerText = this.formatCurrency(totalOut);
                if(document.getElementById('fin-balance')) {
                    const balEl = document.getElementById('fin-balance');
                    balEl.innerText = this.formatCurrency(balance);
                    balEl.className = `stat-value ${balance >= 0 ? 'text-success' : 'text-danger'}`;
                }

                this.data.transactions.sort((a,b)=>b.id-a.id).forEach(tx => {
                    const c = this.data.cases.find(x => x.id == tx.caseId);
                    const isIncome = tx.type === 'income';
                    
                    let actionBtns = `<button class="btn btn-danger btn-sm" onclick="app.deleteTransaction(${tx.id})">üóë</button>`;
                    if(isIncome) {
                        actionBtns = `<button class="btn btn-outline btn-sm" onclick="app.openReceiptConfig(${tx.id})">üìÑ Recibo</button> ` + actionBtns;
                    }

                    ledger.innerHTML += `<tr>
                        <td>${new Date(tx.id).toLocaleDateString('pt-BR')}</td>
                        <td><span class="badge ${isIncome?'badge-green':'badge-red'}">${isIncome?'Entrada':'Sa√≠da'}</span></td>
                        <td>${tx.desc || '-'}</td>
                        <td>${c ? c.client : '-'}</td>
                        <td style="font-weight:bold; color:${isIncome?'var(--success)':'var(--danger)'}">${isIncome?'+':'-'} ${this.formatCurrency(tx.amount)}</td>
                        <td style="display:flex; gap:8px;">${actionBtns}</td>
                    </tr>`;
                });
            },

            // ==========================================
            // RECEIPT GENERATOR (DYNAMIC)
            // ==========================================
            openReceiptConfig(txId = null, caseId = null) {
                let pagador = '';
                let valor = 0;
                let desc = 'Servi√ßos jur√≠dicos prestados.';
                let data = new Date().toISOString().split('T')[0];

                const dl = document.getElementById('rcpt-client-list');
                dl.innerHTML = '';
                const clients = [...new Set(this.data.cases.map(c => c.client).filter(Boolean))];
                clients.forEach(c => dl.innerHTML += `<option value="${c}">`);

                if (txId) {
                    const tx = this.data.transactions.find(t => t.id === txId);
                    if (tx) {
                        valor = tx.amount;
                        desc = tx.desc || 'Pagamento de honor√°rios';
                        data = new Date(tx.id).toISOString().split('T')[0];
                        const c = this.data.cases.find(x => x.id == tx.caseId);
                        if (c) {
                            pagador = c.client;
                            desc += ` (Processo n¬∫ ${c.number})`;
                        }
                    }
                } else if (caseId) {
                    const c = this.data.cases.find(x => x.id === caseId);
                    if (c) {
                        pagador = c.client;
                        valor = this.data.transactions.filter(t => t.caseId === caseId && t.type === 'income').reduce((a,b) => a + (parseFloat(b.amount) || 0), 0);
                        desc = `Honor√°rios advocat√≠cios referente ao processo ${c.number}`;
                    }
                }

                document.getElementById('rcpt-client').value = pagador;
                document.getElementById('rcpt-amount').value = valor;
                document.getElementById('rcpt-desc').value = desc;
                document.getElementById('rcpt-date').value = data;

                document.getElementById('modal-receipt-config').classList.add('active');
            },

            generateReceipt() {
                const pagador = document.getElementById('rcpt-client').value || '_______________________';
                const valor = parseFloat(document.getElementById('rcpt-amount').value) || 0;
                const desc = document.getElementById('rcpt-desc').value || '_______________________';
                
                const dateInput = document.getElementById('rcpt-date').value;
                const dateStr = dateInput ? new Date(dateInput + 'T12:00:00').toLocaleDateString('pt-BR') : new Date().toLocaleDateString('pt-BR');

                document.getElementById('receipt-content').innerHTML = `
                    <div style="border: 2px solid #000; padding: 40px; background: #fff; color: #000; font-family: 'Times New Roman', serif; position: relative; border-radius: 8px;">
                        <div style="display:flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 25px;">
                            <div>
                                <h1 style="margin:0; font-size: 1.8rem; text-transform: uppercase; letter-spacing: 2px;">RECIBO</h1>
                                <p style="margin: 5px 0 0 0; color: #555;">Via LexManager CRM</p>
                            </div>
                            <div style="text-align:right;">
                                <div style="background: #f4f4f4; border: 1px solid #000; padding: 10px 20px; font-size: 1.5rem; font-weight: bold;">
                                    ${this.formatCurrency(valor)}
                                </div>
                                <p style="margin: 5px 0 0 0; font-size: 0.9rem;">N¬∫ ${Date.now().toString().slice(-6)}</p>
                            </div>
                        </div>

                        <div style="font-size: 1.15rem; line-height: 1.8; text-align: justify; margin-bottom: 30px;">
                            Recebi(emos) de <b>${pagador}</b>, portador(a) do CPF/CNPJ n¬∫ ________________________, a import√¢ncia supra de <b>${this.formatCurrency(valor)}</b>, em pagamento referente a <b>${desc}</b>.
                            <br><br>
                            Para maior clareza e validade, firmo o presente recibo dando plena, rasa e irrevog√°vel quita√ß√£o referente ao valor acima especificado.
                        </div>

                        <div style="display:flex; justify-content: flex-end; margin-bottom: 50px;">
                            <div style="text-align: center; width: 60%;">
                                <p style="font-size: 1.1rem; margin: 0;">__________________________, ${dateStr}</p>
                            </div>
                        </div>

                        <div style="display:flex; justify-content: space-between; gap: 30px;">
                            <div style="flex:1; border-top: 1px solid #000; text-align: center; padding-top: 10px;">
                                <b style="display:block;">Assinatura do Pagador</b>
                                <span style="font-size:0.9rem; color:#555;">(Opcional)</span>
                            </div>
                            <div style="flex:1; border-top: 1px solid #000; text-align: center; padding-top: 10px;">
                                <b style="display:block;">Assinatura do Recebedor</b>
                                <span style="font-size:0.9rem; color:#555;">Advogado / Escrit√≥rio</span>
                            </div>
                        </div>
                    </div>
                `;
                
                this.closeModal('modal-receipt-config');
                document.getElementById('modal-receipt').classList.add('active');
            },

            openCaseDetail(id) { 
                const c = this.data.cases.find(x=>x.id===id); 
                if(!c) return; 
                const contracted = c.fees||0; 
                const received = this.data.transactions.filter(t=>t.caseId===id && t.type==='income').reduce((acc,t)=>acc+t.amount,0); 
                const pctReceived = contracted > 0 ? Math.min((received/contracted)*100, 100) : 0; 
                
                let timeline = []; 
                const initialDate = c.date_start || c.date_created;
                timeline.push({date:initialDate, type:'create', title:'In√≠cio do Processo / Cadastro', desc:'Registro do caso', id:null}); 
                
                this.data.deadlines.filter(d=>d.caseId===id).forEach(d => timeline.push({date:d.date, type:'deadline', title:`Prazo: ${d.type}`, desc:d.done?'Status: Conclu√≠do ‚úÖ':'Status: Pendente ‚è≥', id:null}) ); 
                this.data.transactions.filter(t=>t.caseId===id).forEach(t => timeline.push({date:t.id, type:'finance', title:t.type==='income'?'Honor√°rios Recebidos':'Despesa Registrada', desc:`Valor: ${this.formatCurrency(t.amount)}`, id:null}) ); 
                this.data.updates.filter(u=>u.caseId===id).forEach(u => timeline.push({date:u.date, type:'update', title:'Publica√ß√£o Analisada', desc:`Ato: ${u.analysis.type}`, id:u.id}) ); 
                
                timeline.sort((a,b)=>new Date(b.date)-new Date(a.date)); 
                
                document.getElementById('case-detail-content').innerHTML = `
                    <div class="card" style="margin-bottom: 30px;">
                        <div class="flex-between"><h2 style="font-size:1.8rem; font-family:monospace; letter-spacing:-1px;">${c.number}</h2> <span class="badge ${c.status==='Em andamento'?'badge-blue':'badge-gray'}">${c.status}</span></div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin:25px 0; background:var(--bg-body); padding:20px; border-radius:var(--radius-lg); border: 1px solid var(--border-color);">
                            <div><span style="font-size:0.8rem; color:var(--text-secondary); text-transform:uppercase; font-weight:700;">Autor / Cliente</span><br><b style="font-size:1.1rem;">${c.client}</b></div>
                            <div><span style="font-size:0.8rem; color:var(--text-secondary); text-transform:uppercase; font-weight:700;">R√©u / Adverso</span><br><b style="font-size:1.1rem;">${c.opponent||'-'}</b></div>
                            <div><span style="font-size:0.8rem; color:var(--text-secondary); text-transform:uppercase; font-weight:700;">√Årea</span><br><b>${c.area}</b></div>
                            <div><span style="font-size:0.8rem; color:var(--text-secondary); text-transform:uppercase; font-weight:700;">Valor da Causa</span><br><b>${this.formatCurrency(c.value)}</b></div>
                        </div>
                        <div class="finance-summary-bar">
                            <div class="finance-values"><span style="color:var(--text-secondary);">Contrato: <b style="color:var(--text-main);">${this.formatCurrency(contracted)}</b></span><span style="color:var(--success); font-weight:600;">Recebido: <b>${this.formatCurrency(received)}</b></span></div>
                            <div class="finance-progress"><div class="progress-received" style="width:${pctReceived}%"></div><div class="progress-pending" style="width:${100-pctReceived}%"></div></div>
                        </div>
                        <div style="margin-top:25px; text-align:right; border-top:1px solid var(--border-color); padding-top:20px; display:flex; justify-content:flex-end; gap:10px;">
                            <button class="btn btn-outline" onclick="app.openModal('modal-case', ${c.id})">‚úèÔ∏è Editar Processo</button> 
                            <button class="btn btn-primary" onclick="app.openModal('modal-deadline', ${c.id})">‚è≥ Agendar Prazo</button>
                        </div>
                    </div>
                    <h3 style="margin-bottom: 20px;">Linha do Tempo (Hist√≥rico)</h3>
                    <div class="full-timeline">
                        ${timeline.map(t => `<div class="ft-item" ${t.type==='update'?`onclick="app.viewPublication(${t.id})" style="cursor:pointer;"`:''}><div class="ft-icon ${t.type}">${t.type==='create'?'‚òÖ':(t.type==='deadline'?'‚è≥':(t.type==='finance'?'$':'üìÑ'))}</div><div class="ft-card"><div class="ft-date">${new Date(t.date).toLocaleDateString('pt-BR')}</div><b style="color:var(--primary); font-size:1.1rem; display:block; margin-bottom:5px;">${t.title}</b><div style="font-size:0.95rem; color:var(--text-secondary);">${t.desc}</div></div></div>`).join('')}
                    </div>`; 
                this.navigate('case-detail'); 
            },

            openClientDetail(name) { const cl = this.data.cases.filter(c=>c.client===name); let h = `<div style="margin-bottom:20px; font-size:1.1rem;">Total consolidado: <b>${cl.length} processo(s)</b></div><table style="width:100%"><thead><tr><th>N¬∫ CNJ</th><th>Status</th><th>Valor Causa</th></tr></thead><tbody>`; cl.forEach(c => h += `<tr><td style="font-weight:600;">${c.number}</td><td><span class="badge ${c.status==='Em andamento'?'badge-blue':'badge-gray'}">${c.status}</span></td><td>${this.formatCurrency(c.value)}</td></tr>`); document.getElementById('client-detail-body').innerHTML = h + `</tbody></table>`; document.getElementById('modal-client-detail').classList.add('active'); },
            deleteClient(n) { if(confirm('Aviso: Isso apagar√° TODOS os processos vinculados a este cliente. Deseja prosseguir?')) { this.data.cases = this.data.cases.filter(c=>c.client!==n); this.saveToStorage(); this.renderClients(); } },
            
            toggleDeadline(id) { const i = this.data.deadlines.findIndex(d=>d.id===id); if(i>-1) { this.data.deadlines[i].done = !this.data.deadlines[i].done; this.saveToStorage(); this.renderDeadlines(); } },
            deleteDeadline(id) { if(confirm('Tem certeza que deseja apagar este prazo?')) { this.data.deadlines = this.data.deadlines.filter(d=>d.id!==id); this.saveToStorage(); this.renderDeadlines(); } },
            toggleTask(id) { const i = this.data.tasks.findIndex(t=>t.id===id); if(i>-1) { this.data.tasks[i].done = !this.data.tasks[i].done; this.saveToStorage(); this.renderTasks(); } },
            
            saveToStorage() { localStorage.setItem('lexData', JSON.stringify(this.data)); },
            loadData() { const d = localStorage.getItem('lexData'); if(d) this.data = JSON.parse(d); if(!this.data.tasks) this.data.tasks = []; if(!this.data.updates) this.data.updates = []; const l = [...new Set(this.data.cases.map(c=>c.lawyer).filter(Boolean))]; const ls = document.getElementById('filter-lawyer'); if(ls) l.forEach(x => ls.add(new Option(x,x))); const a = [...new Set(this.data.cases.map(c=>c.area).filter(Boolean))]; const as = document.getElementById('filter-area'); if(as) a.forEach(x => as.add(new Option(x,x))); },
            toggleDarkMode() { document.body.classList.toggle('dark-mode'); localStorage.setItem('lexTheme', document.body.classList.contains('dark-mode') ? 'dark' : 'light'); },
            clearData() { if(confirm('ATEN√á√ÉO: Isso ir√° apagar TODOS os processos, clientes e financeiro do seu navegador. N√£o h√° como desfazer. Confirmar?')) { localStorage.removeItem('lexData'); location.reload(); } },
            formatCurrency(v) { return new Intl.NumberFormat('pt-BR', {style:'currency', currency:'BRL'}).format(v); }
        };

        app.init();
    </script>
</body>
</html>
